<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="fragment/head :: head"></head>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet">
<script crossorigin="anonymous"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<body class="vertical light">
<div class="wrapper">
    <div th:include="fragment/navbar :: navbar"></div>
    <div th:include="fragment/sidebar :: sidebar"></div>
    <main class="main-content" role="main">
        <!-- Nội dung chính sẽ được thêm vào bằng JavaScript -->
    </main>
</div>
</body>
<div th:include="fragment/script :: script"></div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" rel="stylesheet"/>

<script th:inline="javascript">

    document.addEventListener("DOMContentLoaded", function () {
        loadTrangHoaDon();

        $('.drgpicker').daterangepicker({
        singleDatePicker: true,
        timePicker: false,
        showDropdowns: true,
        locale: {
        format: 'MM/DD/YYYY'
        }
        });

        const ngayTaoMinInput = document.getElementById('ngayTaoMin');
        const ngayTaoMaxInput = document.getElementById('ngayTaoMax');

        ngayTaoMinInput.addEventListener('change', function () {
            searchMinDate(ngayTaoMinInput.value);
        });

        ngayTaoMaxInput.addEventListener('change', function () {
            searchMaxDate(ngayTaoMaxInput.value);
        });

        flatpickr("#ngayTaoMin", {});
        flatpickr("#ngayTaoMax", {});

        fetchDataAndRenderTable(); // Gọi hàm fetch và render table khi DOMContentLoaded
        });

        let initialTableData = [];
        let currentSearchQuery = "";
        let currentSearchMinMoney = "";
        let currentSearchMaxMoney = "";
        let currentStatusFilter = null;
        let currentStatusFilter2 = null;
        let currentSearchMinDate = "";
        let currentSearchMaxDate = "";

        function fetchDataAndRenderTable(page = 0, size = 10) {
        let apiURL = `/hoa-don/search-and-filter?trang=${page}&kichThuoc=${size}`;

        if (currentSearchQuery) {
        apiURL += `&key=${encodeURIComponent(currentSearchQuery)}`;
        }
        if (currentSearchMinMoney) {
        apiURL += `&tongTienMin=${encodeURIComponent(currentSearchMinMoney)}`;
        }
        if (currentSearchMaxMoney) {
        apiURL += `&tongTienMax=${encodeURIComponent(currentSearchMaxMoney)}`;
        }
        if (currentSearchMinDate) {
            apiURL += `&ngayTaoMin=${encodeURIComponent(currentSearchMinDate)}`;
        }
        if (currentSearchMaxDate) {
            apiURL += `&ngayTaoMax=${encodeURIComponent(currentSearchMaxDate)}`;
        }
        if (currentStatusFilter) {
        apiURL += `&loai=${currentStatusFilter}`;
        }
        if (currentStatusFilter2) {
        apiURL += `&trangThai=${currentStatusFilter2}`;
        }

        fetch(apiURL)
        .then(response => response.json())
        .then(data => {
            totalPagesHoaDon = data.totalPages;
            renderTable(data, page, size);
            updatePagination(data);
        })
        .catch(error => console.error('Error fetching data:', error));
        }

        function renderTable(data, page, size) {
        const tableData = data.content || data; // Kiểm tra nếu data.content không tồn tại, sử dụng data trực tiếp
        initialTableData = tableData;
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = ''; // Xóa dữ liệu hiện tại trong bảng

            tableData.forEach((hoaDon, index) => {
                const row = `
                <tr>
                <td>${(page * size) + index + 1}</td>
                <td class="maHoaDon">${hoaDon.maHoaDon}</td>
                <td class="maNhanVien">${hoaDon.maNhanVien}</td>
                <td class="hoVaTenKhachHang">${hoaDon.hoVaTenKhachHang}</td>
                <td class="soDienThoaiKhachHang">${hoaDon.soDienThoaiKhachHang}</td>
                <td class="loai">
                <span style="width: 90%"
                class="${hoaDon.loai === true ? 'custom-1' : 'custom-4'}" >
                ${hoaDon.loai == false ? "Online" : "Tại quầy"}
                </span>
                </td>
                <td class="ngayTao">${hoaDon.ngayTao}</td>
                <td class="tongTien">${hoaDon.tongTien.toLocaleString()} VND</td>
                <td class="tienCoc">${hoaDon.tienCoc.toLocaleString()} VND</td>
                <td class="trangThai">
                    <span style="width: 90%"
                          class="${hoaDon.trangThai === 'Đã hủy' ? 'custom-3' : hoaDon.trangThai === 'Chờ thanh toán' ? 'custom-5' : 'custom-4'}">
                        ${hoaDon.trangThai}
                    </span>
                </td>
                <td>
                <button class="btn mb-2 mr-1 btn-outline-success" type="button" onclick="showDetailContent(${hoaDon.id})">
                <span class="fe fe-eye"></span>
                </button>
                ${hoaDon.trangThai === 'Chờ thanh toán' ? `
                    <button class="btn mb-2 mr-1 btn-outline-danger" type="button" onclick="cancelInvoice(${hoaDon.id})">
                        <span class="fe fe-trash-2"></span>
                    </button>
                ` : ''}
                </td>
                </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

        }

        function searchInvoices(query) {
        currentSearchQuery = query.trim() === "" ? null : query;
        fetchDataAndRenderTable();
        }

        function searchMinMoney(minMoney) {
        currentSearchMinMoney = minMoney.trim() === "" ? null : minMoney;
        fetchDataAndRenderTable();
        }

        function searchMaxMoney(maxMoney) {
        currentSearchMaxMoney = maxMoney.trim() === "" ? null : maxMoney;
        fetchDataAndRenderTable();
        }

    function formatDateToCustomFormat(date, isStartOfDay) {
        if (!date.trim()) return null;

        const [year, month, day] = date.split("-");
        const formattedDate = `${day}/${month}/${year}`;
        return isStartOfDay
            ? `${formattedDate} 00:00:00`
            : `${formattedDate} 23:59:59`;
    }

    let currentPage = 0;
    let totalPagesHoaDon = 1;

    // Hàm cập nhật giao diện phân trang
    function updatePagination(data) {
        const totalPagesHoaDon = data.totalPages;
        const currentPage = data.number;

        // Cập nhật dropdown các trang
        const pageDropdown = document.getElementById('pageDropdown');
        pageDropdown.innerHTML = ''; // Xóa danh sách cũ

        for (let i = 0; i < totalPagesHoaDon; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `Trang ${i + 1}`;
            if (currentPage === i) {
                option.selected = true; // Chọn trang hiện tại
            }
            pageDropdown.appendChild(option);
        }

        // Cập nhật nút Lùi
        const prevPageButton = document.getElementById('prevPageButton');
        prevPageButton.style.display = currentPage === 0 ? 'none' : 'inline-block';

        // Cập nhật nút Tiếp
        const nextPageButton = document.getElementById('nextPageButton');
        nextPageButton.style.display = currentPage === totalPagesHoaDon - 1 ? 'none' : 'inline-block';
    }

    // Hàm chuyển đổi trang khi bấm nút Lùi hoặc Tiếp
    function changePage(page) {
        if (page >= 0 && page < totalPagesHoaDon) {
            currentPage = page; // Cập nhật currentPage ngay lập tức
            fetchDataAndRenderTable(page, 10); // Gọi hàm fetch mới
        }
    }

    // Hàm chuyển đổi trang khi chọn trong dropdown
    function changePageFromDropdown(selectElement) {
        const selectedPage = parseInt(selectElement.value, 10);
        currentPage = selectedPage; // Cập nhật currentPage
        fetchDataAndRenderTable(selectedPage, 10); // Gọi hàm fetch mới
    }

    function searchMinDate(minDate) {
        currentSearchMinDate = formatDateToCustomFormat(minDate, true);
        fetchDataAndRenderTable();
    }

    function searchMaxDate(maxDate) {
        currentSearchMaxDate = formatDateToCustomFormat(maxDate, false);
        fetchDataAndRenderTable();
    }

    //Ly viết

    //Hàm thông báo
    function showSuccessToast(message) {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            style: {
                background: "#4CAF50",
            },
            stopOnFocus: true
        }).showToast();
    }

    //Hàm lấy tham số hoàn tiền
    async function fetchCancellationTimeParam() {
        try {
            const response = await fetch('http://localhost:8080/tham-so/searchMaFake/TS_Gio_Huy');
            if (!response.ok) throw new Error('Failed to fetch cancellation time parameter.');
            const data = await response.json();
            return { value: parseInt(data.giaTri, 10), type: data.typeGiaTri }; // Chuyển đổi đúng kiểu
        } catch (error) {
            console.error('Error fetching cancellation parameter:', error);
            return { value: 0, type: 'Phút' }; // Giá trị mặc định nếu lỗi
        }
    }
    async function renderCancellationActions(chiTiet) {
        // Lấy tham số giờ hủy từ API
        const cancelParam = await fetchCancellationTimeParam();
        const { value: maxTime, type: timeUnit } = cancelParam;

        const currentTime = new Date(); // Thời gian hiện tại
        const currentTotalMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();

        const thoiGianBatDau = new Date(chiTiet.thoiGianBatDauCa);
        const startTotalMinutes = thoiGianBatDau.getHours() * 60 + thoiGianBatDau.getMinutes();

        // Tính toán chênh lệch thời gian còn lại
        let timeDifference = startTotalMinutes - currentTotalMinutes;

        // Chuyển đổi tham số thành phút
        const maxTimeInMinutes =
            timeUnit === 'Phút' ? maxTime :
                timeUnit === 'Giờ' ? maxTime * 60 :
                    timeUnit === 'Ngày' ? maxTime * 24 * 60 : 0;

        // Log đầy đủ thông tin

        // Cờ để kiểm tra auto-cancel đã xử lý hay chưa
        if (chiTiet.trangThai === 'Đã hủy') {
            return ''; // Tránh lặp vô hạn
        }

        // Xử lý logic: nếu chênh lệch phút lớn hơn giới hạn → Hiển thị nút "Hoàn tiền"
        if (timeDifference >= maxTimeInMinutes) {
            return `
         <button class="btn mb-2 mr-1 btn-outline-danger" type="button" onclick="cancelDetailInvoice(${chiTiet.id})" title="Hủy lịch đặt">
            <span class="fe fe-trash-2"></span>
        </button>
        <button class="btn mb-2 mr-1 btn-outline-warning" type="button" onclick="refundDetailInvoice(${chiTiet.id})" title="Hoàn tiền cọc">
            <span class="fe fe-rotate-ccw"></span>
        </button>
        `;
        }
        // Nếu chênh lệch nhỏ hơn giới hạn → Trả về trống và xử lý auto-cancel
        else {
            return '';
        }
    }


    async function refundDetailInvoice(id) {
        confirmAction('Xác nhận hoàn tiền', 'Bạn có muốn hoàn tiền cho lịch đặt này không?')
            .then((result) => {
                if (result.isConfirmed) {
                    fetch(`http://localhost:8080/hoa-don-chi-tiet/hoan-tien-coc/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Có lỗi xảy ra khi hoàn tiền.');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log('Hoàn tiền thành công:', data);
                            showSuccessToast('Hoàn tiền thành công!');
                            fetch(`http://localhost:8080/hoa-don-chi-tiet/${id}`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Không thể lấy thông tin hóa đơn.');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    showDetailContent(data.idHoaDon); // Gọi lại để cập nhật giao diện
                                });
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire(
                                'Thất bại!',
                                'Không thể hoàn tiền. Vui lòng thử lại!',
                                'error'
                            );
                        });
                }
            });
    }

    //End Ly viết

    function filterTable() {
        const statusFilter = document.getElementById('statusFilter').value;
        currentStatusFilter = statusFilter === "all" ? null : statusFilter;
        fetchDataAndRenderTable();
        }

        function filterTable2(valueStatus) {
        currentStatusFilter2 = valueStatus === "all" ? null : valueStatus;
        fetchDataAndRenderTable();
        }

        // Hàm để ẩn nội dung ban đầu và hiển thị nội dung mới
        function showDetailContent(id) {
        const bodyContent = document.getElementById('bodyContent');

        const form = `
        <div class="row justify-content-center">
        <div class="col-12">
        <h2 class="mb-2 page-title">Quản lý hóa đơn</h2>
        <div class="row my-4">
        <div class="col-md-12">
        <div class="card shadow">
        <div class="card-body">
        <div class="form-row mb-3">
        <h4 class="card-title ml-3" id="title"></h4>
        </div>
        <div>
        <form>
        <div class="form-row">
        <div class="form-group col-md-4">
        <label for="hoVaTenKhachHang" name="hoVaTenKhachHang">Tên khách hàng</label>
        <input type="text" class="form-control" id="hoVaTenKhachHang" readonly>
        </div>
        <div class="form-group col-md-4">
        <label for="soDienThoaiKhachHang" name="soDienThoaiKhachHang">SĐT</label>
        <input type="text" class="form-control" id="soDienThoaiKhachHang" readonly>
        </div>
        <div class="form-group col-md-4">
        <label for="maNhanVien" name="maNhanVien">Mã nhân viên</label>
        <input type="text" class="form-control" id="maNhanVien" readonly>
        </div>
        </div>
        <div class="form-row">
        <div class="form-group col-md-3">
        <label for="tienCoc" name="tienCoc">Tiền cọc</label>
        <div class="input-group">
        <input type="text" class="form-control" id="tienCoc" readonly>
        </div>
        </div>
        <div class="form-group col-md-3">
        <label for="tongTien" name="tongTien">Tổng tiền</label>
        <div class="input-group">
        <input type="text" class="form-control" id="tongTien" readonly>
        </div>
        </div>
        <div class="form-group col-md-3">
        <label for="trangThai" name="trangThai">Trạng thái</label>
        <input type="text" class="form-control" id="trangThai" readonly>
        </div>
        <div class="form-group col-md-3">
        <label for="loai" name="loai">Loại</label>
        <input type="text" class="form-control" id="loai" readonly>
        </div>
        </div>
        </form>
        </div>
        </div>
        </div>
        </div>
        </div>
        <div class="row my-4">
        <div class="col-md-12">
        <div class="card shadow">
        <div class="card-body">
        <div class="form-row mb-3">
        <h4 class="card-title ml-3">Thông tin sân đặt</h4>
        </div>
        <div>
        <table class="table datatables" style="justify-content: center; text-align: center" id="dataTable-1">
        <thead>
        <tr>
        <th>STT</th>
        <th>Mã hóa đơn chi tiết</th>
        <th>Sân</th>
        <th>Thời gian</th>
        <th>Ngày đến sân</th>
        <th>Tổng tiền</th>
        <th>Trạng thái</th>
        </tr>
        </thead>
        <tbody id="tableBody">
            <!-- Dữ liệu bảng sẽ được thêm bởi JavaScript -->
        </tbody>
        </table>
        <div class="row my-4">
            <div class="col-md-4">
                <div class="card shadow">
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-6 text-left">Tổng tiền sân:</div>
                            <div class="col-6 text-right" id="tongTienSan">0 VND</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-left">Tổng tiền dịch vụ:</div>
                            <div class="col-6 text-right" id="tongTienDichVu">0 VND</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-left">Tổng tiền phụ phí:</div>
                            <div class="col-6 text-right" id="tongTienPhuPhi">0 VND</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 text-left">Tổng tiền giảm:</div>
                            <div class="col-6 text-right" id="tongTienGiam">0 VND</div>
                        </div>
                        <hr>
                        <div class="row mb-2">
                            <div class="col-6 text-left">Tổng tiền thanh toán:</div>
                            <div class="col-6 text-right" id="tongTienThanhToan">0 VND</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button class="btn btn-outline-secondary" onclick="back()">Quay lại</button>
        `;

        bodyContent.innerHTML = form;

        fetch(`http://localhost:8080/hoa-don/${id}`)
        .then(response => response.json())
        .then(data => {
        document.getElementById('title').innerText = 'Thông tin hóa đơn: ' + data.maHoaDon;
        document.getElementById('hoVaTenKhachHang').value = data.hoVaTenKhachHang;
        document.getElementById('soDienThoaiKhachHang').value = data.soDienThoaiKhachHang;
        document.getElementById('maNhanVien').value = data.maNhanVien;
        document.getElementById('tongTien').value = data.tongTien.toLocaleString() + " VND";
        document.getElementById('tienCoc').value = data.tienCoc.toLocaleString() + " VND";
        document.getElementById('loai').value = data.loai ? "Online" : "Tại quầy";
        document.getElementById('trangThai').value = data.trangThai;
        });

            fetch(`http://localhost:8080/hoa-don-chi-tiet/hien-thi/${id}`)
                .then(response => response.json())
                .then(async data => {
                    const tableBody = document.getElementById('tableBody');
                    tableBody.innerHTML = '';

                    let tongTienSan = 0;
                    let tongTienDichVu = 0;
                    let tongTienPhuPhi = 0;
                    let tongTienGiam = 0;

                    // Tạo mảng các promises
                    const allPromises = [];

                    for (const [index, chiTiet] of data.entries()) {
                        const actionHTML = await renderCancellationActions(chiTiet);

                        const startTime = new Date(chiTiet.thoiGianBatDauCa);
                        const endTime = new Date(chiTiet.thoiGianKetThucCa);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                <td>${index + 1}</td>
                <td>${chiTiet.maHoaDonChiTiet}</td>
                <td>${chiTiet.tenSanBong}</td>
                <td>${startTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                <td>${chiTiet.ngayDenSan}</td>
                <td>${chiTiet.tongTien.toLocaleString()} VND</td>
                <td>
                    <span style="width: 90%"
                        class="${chiTiet.trangThai === 'Đã hủy' ? 'custom-3' : chiTiet.trangThai === 'Chờ nhận sân' ? 'custom-5' : 'custom-4'}">
                        ${chiTiet.trangThai}
                    </span>
                </td>
                <td>
                    ${chiTiet.trangThai === 'Chờ nhận sân' ? actionHTML : ''}
                </td>
            `;
                        tableBody.appendChild(row);

                        // Cộng dồn các loại tiền
                        tongTienSan += chiTiet.giaSanCa || 0;
                        tongTienGiam += chiTiet.tienGiamGia || 0;

                        // Push các fetch promises vào mảng allPromises
                        allPromises.push(
                            fetch(`http://localhost:8080/dich-vu-san-bong/dichVuSanBongTheoHoaDon/${chiTiet.id}`)
                                .then(response => response.json())
                                .then(dichVuData => {
                                    dichVuData.forEach(dichVu => {
                                        tongTienDichVu += dichVu.tongTien || 0;
                                    });
                                })
                        );

                        allPromises.push(
                            fetch(`http://localhost:8080/api/phu-phi-hoa-don/${chiTiet.id}`)
                                .then(response => response.json())
                                .then(phuPhiData => {
                                    phuPhiData.forEach(phuPhi => {
                                        tongTienPhuPhi += phuPhi.tienPhuPhi || 0;
                                    });
                                })
                        );
                    }

                    // Chờ tất cả các fetch hoàn tất
                    await Promise.all(allPromises);

                    // Cập nhật các giá trị tổng tiền vào giao diện
                    document.getElementById('tongTienSan').textContent = tongTienSan.toLocaleString() + " VND";
                    document.getElementById('tongTienDichVu').textContent = tongTienDichVu.toLocaleString() + " VND";
                    document.getElementById('tongTienPhuPhi').textContent = tongTienPhuPhi.toLocaleString() + " VND";
                    document.getElementById('tongTienGiam').textContent = tongTienGiam.toLocaleString() + " VND";

                    // Tính tổng tiền thanh toán
                    const tongTienThanhToan = tongTienSan + tongTienDichVu + tongTienPhuPhi - tongTienGiam;
                    document.getElementById('tongTienThanhToan').textContent = tongTienThanhToan.toLocaleString() + " VND";
                })
                .catch(error => console.error('Error:', error));
        };

    function cancelInvoice(id) {
        confirmAction('Bạn có chắc chắn?', 'Bạn có muốn hủy lịch đặt này không?')
            .then((result) => {
                if (result.isConfirmed) {
                    // Bước 1: Lấy danh sách hóa đơn chi tiết thuộc hóa đơn
                    fetch(`http://localhost:8080/hoa-don-chi-tiet/hien-thi/${id}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Không thể lấy danh sách hóa đơn chi tiết');
                            }
                            return response.json();
                        })
                        .then(detailInvoices => {
                            // Bước 2: Hủy lần lượt từng hóa đơn chi tiết
                            const cancelDetailPromises = detailInvoices.map(detail => {
                                return fetch(`http://localhost:8080/hoa-don-chi-tiet/huy-lich-dat/${detail.id}`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                }).then(response => {
                                    if (!response.ok) {
                                        throw new Error(`Lỗi khi hủy hóa đơn chi tiết ${detail.id}`);
                                    }
                                });
                            });

                            // Đợi tất cả các hóa đơn chi tiết được hủy
                            return Promise.all(cancelDetailPromises);
                        })
                        .then(() => {
                            // Bước 3: Hủy hóa đơn chính
                            return fetch(`http://localhost:8080/hoa-don/huy-lich-dat/${id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            });
                        })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Có lỗi xảy ra khi hủy hóa đơn');
                            }
                            return response.json();
                        })
                        .then(() => {
                            Swal.fire(
                                'Thành công!',
                                'Lịch đặt đã được hủy cùng với tất cả chi tiết.',
                                'success'
                            );
                            fetchDataAndRenderTable();
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire(
                                'Thất bại!',
                                'Không thể hủy lịch đặt. Vui lòng thử lại!',
                                'error'
                            );
                        });
                }
            });
    }

    function cancelDetailInvoice(id) {
        confirmAction('Bạn có chắc chắn?', 'Bạn có muốn hủy lịch đặt này không?')
            .then((result) => {
                if (result.isConfirmed) {
                    fetch(`http://localhost:8080/hoa-don-chi-tiet/huy-lich-dat/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Có lỗi xảy ra khi hủy lịch đặt');
                            }
                            return response.json();
                        })
                        .then(data => {
                            // alert("Hủy lịch đặt thành công!");
                            console.log(data);
                            fetch(`http://localhost:8080/hoa-don-chi-tiet/${id}`,{
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error('Có lỗi xảy ra khi hủy lịch đặt');
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    showDetailContent(data.idHoaDon);
                                })
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire(
                                'Thất bại!',
                                'Không thể hủy lịch đặt. Vui lòng thử lại!',
                                'error'
                            );
                        });
                }
            });
    }

    function back(){
        loadTrangHoaDon();

        $('.drgpicker').daterangepicker({
        singleDatePicker: true,
        timePicker: false,
        showDropdowns: true,
        locale: {
        format: 'MM/DD/YYYY'
        }
        });

        flatpickr("#ngayTaoMin", {});
        flatpickr("#ngayTaoMax", {});
        initialTableData = [];
        currentSearchQuery = "";
        currentSearchMinMoney = "";
        currentSearchMaxMoney = "";
        currentStatusFilter = null;
        currentStatusFilter2 = null;
        currentSearchMinDate = "";
        currentSearchMaxDate = "";
        fetchDataAndRenderTable(); // Gọi hàm fetch và render table khi DOMContentLoaded
    }

    function confirmAction(title, text, confirmText = 'Đồng ý', cancelText = 'Hủy') {
        return Swal.fire({
            title: title,
            text: text,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: confirmText,
            cancelButtonText: cancelText
        });
    }

    function loadTrangHoaDon(){
        const mainContent = document.querySelector('.main-content');
        mainContent.innerHTML = `
        <div class="container-fluid" id="bodyContent">
            <div class="row justify-content-center">
                <div class="col-12">
                    <h2 class="mb-2 page-title">Quản lý hóa đơn</h2>
                    <div class="row my-4">
                        <div class="col-md-12">
                            <div class="card shadow">
                                <div class="card-body">
                                    <div class="form-row mb-3">
                                        <i class="bi bi-funnel-fill"></i>
                                        <h4 class="card-title ml-3">Bộ lọc</h4>
                                    </div>
                                    <div class="toolbar row">
                                        <div class="col">
                                            <form>
                                                <div class="form-row mb-1">
                                                    <div class="form-group col-md-1 d-flex align-items-center">
                                                        <label for="search">Tìm kiếm: </label>
                                                    </div>
                                                    <div class="form-group col-md-4 mr-5">
                                                        <input type="text" class="form-control" id="search"
                                                               placeholder="Mã HD, NV, tên KH, SĐT" oninput="searchInvoices(this.value)">
                                                    </div>
                                                    <div class="form-group col-md-1 d-flex align-items-center">
                                                        <label for="statusFilter">Loại: </label>
                                                    </div>
                                                    <div class="form-group col-md-2">
                                                        <select class="custom-select my-1 mr-sm-2"
                                                                id="statusFilter" onchange="filterTable()">
                                                            <option value="all" selected>Tất cả</option>
                                                            <option value="0">Online</option>
                                                            <option value="1">Tại quầy</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-row">
                                                    <h5>Tổng tiền</h5>
                                                </div>
                                                <div class="form-row mb-1">
                                                    <div class="form-group col-md-1 d-flex align-items-center">
                                                        <label for="tienMin">Từ: </label>
                                                    </div>
                                                    <div class="form-group col-md-4 mr-5">
                                                        <input type="text" class="form-control" id="tienMin"
                                                               placeholder="Nhập số tiền" oninput="searchMinMoney(this.value)">
                                                    </div>
                                                    <div class="form-group col-md-1 d-flex align-items-center">
                                                        <label for="tienMax">Đến: </label>
                                                    </div>
                                                    <div class="form-group col-md-4 mr-5">
                                                        <input type="text" class="form-control" id="tienMax"
                                                               placeholder="Nhập số tiền" oninput="searchMaxMoney(this.value)">
                                                    </div>
                                                </div>
                                                <div class="form-row">
                                                    <h5>Ngày tạo</h5>
                                                </div>
                                                <div class="form-row mb-1">
                                                    <div class="form-group col-md-1 d-flex align-items-center">
                                                        <label for="ngayTaoMin" class="col-form-label">Từ</label>
                                                    </div>
                                                    <div class="form-group col-md-4 mr-5">
                                                        <input type="date" id="ngayTaoMin" class="form-control" style="width: 100%;" />
                                                    </div>
                                                    <div class="form-group col-md-1 d-flex align-items-center">
                                                        <label for="ngayTaoMax" class="col-form-label">Đến</label>
                                                    </div>
                                                    <div class="form-group col-md-4">
                                                        <input type="date" id="ngayTaoMax" class="form-control" style="width: 100%;" />
                                                    </div>
                                                    <div class="form-group d-flex gap-2" style="margin-left: auto;">
                                                        <button class="btn btn-primary" onclick="back()" title="Reset" type="button">
                                                            <span class="fe fe-refresh-ccw"></span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row my-4">
                        <div class="col-md-12">
                            <div class="card shadow">
                                <div class="card-body">
                                    <div class="toolbar row mb-3">
                                        <div class="col">
                                            <form class="form-inline">
                                                <div class="form-row">
                                                    <div class="form-group col-auto ml-3">
                                                        <h4 class="card-title">Danh sách hóa đơn</h4>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="col-md-12 mb-4">
                                    <div class="card shadow">
                                        <div class="card-body">
                                            <ul class="nav nav-pills nav-fill mb-3" id="pills-tab" role="tablist">
                                                <li class="nav-item">
                                                    <button class="nav-link active" role="tab" data-toggle="pill" aria-controls="pills-home" aria-selected="true" onclick="filterTable2('all')">Tất cả</button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link" role="tab" data-toggle="pill" aria-controls="pills-profile" onclick="filterTable2('da thanh toan')" aria-selected="false">Đã thanh toán</button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link" role="tab" data-toggle="pill" aria-controls="pills-profile" onclick="filterTable2('da thanh toan mot phan')" aria-selected="false">Đã thanh toán một phần</button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link" role="tab" data-toggle="pill" aria-controls="pills-contact" onclick="filterTable2('da huy')" aria-selected="false">Đã hủy</button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link" role="tab" data-toggle="pill" aria-controls="pills-contact" onclick="filterTable2('cho thanh toan')" aria-selected="false">Chờ thanh toán</button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link" role="tab" data-toggle="pill" aria-controls="pills-contact" onclick="filterTable2('da hoan tien coc')" aria-selected="false">Đã hoàn tiền cọc</button>
                                                </li>
                                            </ul>
                                            <div class="tab-content mb-1" id="pills-tabContent">
                                                <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
                                                    <table class="table datatables" style="justify-content: center; text-align: center" id="table-home">
                                                        <thead>
                                                            <tr>
                                                                <th>STT</th>
                                                                <th>Mã hóa đơn</th>
                                                                <th>Mã nhân viên</th>
                                                                <th>Tên khách hàng</th>
                                                                <th>SĐT khách hàng</th>
                                                                <th>Loại</th>
                                                                <th>Ngày tạo</th>
                                                                <th>Tổng tiền</th>
                                                                <th>Tổng cọc</th>
                                                                <th>Trạng thái</th>
                                                                <th>Hành động</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="tableBody">

                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <div class="mt-3">
                                    <nav aria-label="Table Paging" class="mb-0 text-muted">
                                        <ul id="pagination" class="pagination justify-content-end mb-0">
                                            <!-- Nút Lùi -->
                                            <li class="page-item" id="prevPageButton">
                                                <a class="btn btn-success" href="#" onclick="changePage(currentPage - 1)" aria-label="Previous">
                                                    <span aria-hidden="true">&lt;</span>
                                                </a>
                                            </li>

                                            <!-- Dropdown chọn trang -->
                                            <li class="page-item">
                                                <select class="custom-select" id="pageDropdown" onchange="changePageFromDropdown(this)">
                                                    <!-- Các tùy chọn trang sẽ được thêm động -->
                                                </select>
                                            </li>

                                            <!-- Nút Tiếp -->
                                            <li class="page-item" id="nextPageButton">
                                                <a class="btn btn-success" href="#" onclick="changePage(currentPage + 1)" aria-label="Next">
                                                    <span aria-hidden="true">&gt;</span>
                                                </a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
        </div>
        </div>
        </div>
        </div>
        </div>
        </div>
        `;
    }

</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
</html>

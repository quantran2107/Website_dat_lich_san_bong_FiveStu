<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="fragment/head :: head"></head>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<body class="vertical light">
<div class="wrapper">
    <div th:include="fragment/navbar :: navbar"></div>
    <div th:include="fragment/sidebar :: sidebar"></div>
    <main role="main" class="main-content">
        <!-- Nội dung chính sẽ được thêm vào bằng JavaScript -->
    </main>
</div>
</body>
<div th:include="fragment/script :: script"></div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

<script th:inline="javascript">

    let originalMainContent = null;

    document.addEventListener("DOMContentLoaded", function () {
        const mainContent = document.querySelector('.main-content');
        mainContent.innerHTML = `
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-12">
                    <h2 class="mb-2 page-title">Quản lý hóa đơn</h2>
                    <div class="row my-4">
                        <div class="col-md-12">
                            <div class="card shadow">
                                <div class="card-body">
                                    <div class="form-row mb-3">
                                        <i class="bi bi-funnel-fill"></i>
                                        <h4 class="card-title ml-3">Bộ lọc</h4>
                                    </div>
                                    <div class="toolbar row">
                                        <div class="col">
                                            <form>
                                                <div class="form-row mb-3">
                                                    <div class="form-group col-md-1 d-flex align-items-center">
                                                        <label for="search">Tìm kiếm: </label>
                                                    </div>
                                                    <div class="form-group col-md-4 mr-5">
                                                        <input type="text" class="form-control" id="search"
                                                               placeholder="Mã HD, NV, tên KH, SĐT" oninput="searchInvoices(this.value)">
                                                    </div>
                                                    <div class="form-group col-md-1 d-flex align-items-center">
                                                        <label for="statusFilter">Loại: </label>
                                                    </div>
                                                    <div class="form-group col-md-4">
                                                        <select class="custom-select my-1 mr-sm-2"
                                                                id="statusFilter" onchange="filterTable()">
                                                            <option value="all" selected>Tất cả</option>
                                                            <option value="0">Online</option>
                                                            <option value="1">Tại quầy</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="form-row">
                                                    <h5>Tổng tiền</h5>
                                                </div>
                                                <div class="form-row mb-3">
                                                    <div class="form-group col-md-1 d-flex align-items-center">
                                                        <label for="tienMin">Từ: </label>
                                                    </div>
                                                    <div class="form-group col-md-4 mr-5">
                                                        <input type="text" class="form-control" id="tienMin"
                                                               placeholder="Nhập số tiền" oninput="searchMinMoney(this.value)">
                                                    </div>
                                                    <div class="form-group col-md-1 d-flex align-items-center">
                                                        <label for="tienMax">Đến: </label>
                                                    </div>
                                                    <div class="form-group col-md-4 mr-5">
                                                        <input type="text" class="form-control" id="tienMax"
                                                               placeholder="Nhập số tiền" oninput="searchMaxMoney(this.value)">
                                                    </div>
                                                </div>
                                                <div class="form-row">
                                                    <h5>Ngày tạo</h5>
                                                </div>
                                                <div class="form-row mb-3">
                                                    <div class="form-group col-md-1 d-flex align-items-center">
                                                        <label for="ngayBatDau">Từ ngày: </label>
                                                    </div>
                                                    <div class="form-group col-md-4 mr-5">
                                                        <div class="input-group">
                                                          <input type="text" class="form-control drgpicker" id="ngayBatDau" value="" placeholder="dd/MM/yyyy">
                                                          <div class="input-group-append">
                                                            <div class="input-group-text" id="button-addon-date"><span class="fe fe-calendar fe-16 mx-2"></span></div>
                                                          </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-group col-md-1 d-flex align-items-center">
                                                        <label for="ngayKetThuc">Đến ngày: </label>
                                                    </div>
                                                    <div class="form-group col-md-4">
                                                        <div class="input-group">
                                                          <input type="text" class="form-control drgpicker" id="ngayKetThuc" value="" placeholder="dd/MM/yyyy">
                                                          <div class="input-group-append">
                                                            <div class="input-group-text" id="button-addon-date"><span class="fe fe-calendar fe-16 mx-2"></span></div>
                                                          </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row my-4">
                        <div class="col-md-12">
                            <div class="card shadow">
                                <div class="card-body">
                                    <div class="toolbar row mb-3">
                                        <div class="col">
                                            <form class="form-inline">
                                                <div class="form-row">
                                                    <div class="form-group col-auto ml-3">
                                                        <h4 class="card-title">Danh sách hóa đơn</h4>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col ml-auto">
                                            <div class="dropdown float-right">
                                                <button class="btn btn-primary" type="button">
                                                    + Tạo hóa đơn
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <table class="table datatables" style="justify-content: center; text-align: center" id="dataTable-1">
                                        <thead>
                                            <tr>
                                                <th>STT</th>
                                                <th>Mã hóa đơn</th>
                                                <th>Mã nhân viên</th>
                                                <th>Tên khách hàng</th>
                                                <th>SĐT khách hàng</th>
                                                <th>Loại</th>
                                                <th>Ngày tạo</th>
                                                <th>Tổng tiền</th>
                                                <th>Trạng thái</th>
                                                <th>Hành động</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tableBody">
                                            <!-- Dữ liệu bảng sẽ được thêm bởi JavaScript -->
                                        </tbody>
                                    </table>
                                    <nav aria-label="Table Paging" class="mb-0 text-muted">
                                        <ul id="pagination" class="pagination justify-content-end mb-0">
                                            <!-- Các nút phân trang sẽ được thêm bởi JavaScript -->
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

        $('.drgpicker').daterangepicker({
            singleDatePicker: true,
            timePicker: false,
            showDropdowns: true,
            locale: {
                format: 'MM/DD/YYYY'
            }
        });

        fetchDataAndRenderTable(); // Gọi hàm fetch và render table khi DOMContentLoaded
    });

        let initialTableData = [];
        let currentSearchQuery = "";
        let currentSearchMinMoney = "";
        let currentSearchMaxMoney = "";
        let currentStatusFilter = null;

        function fetchDataAndRenderTable(page = 0, size = 10) {
            let apiURL = `/hoa-don/search-and-filter?trang=${page}&kichThuoc=${size}`;

            if (currentSearchQuery) {
                apiURL += `&key=${encodeURIComponent(currentSearchQuery)}`;
            }
            if (currentSearchMinMoney) {
                apiURL += `&tongTienMin=${encodeURIComponent(currentSearchMinMoney)}`;
            }
            if (currentSearchMaxMoney) {
                apiURL += `&tongTienMax=${encodeURIComponent(currentSearchMaxMoney)}`;
            }
            if (currentStatusFilter) {
                apiURL += `&loai=${currentStatusFilter}`;
            }

            fetch(apiURL)
                .then(response => response.json())
                .then(data => {
                    renderTable(data, page, size);
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function renderTable(data, page, size) {
            const tableData = data.content || data; // Kiểm tra nếu data.content không tồn tại, sử dụng data trực tiếp
            initialTableData = tableData;
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ''; // Xóa dữ liệu hiện tại trong bảng

            tableData.forEach((hoaDon, index) => {
                const ngayTaoFormatted = new Date(hoaDon.ngayTao).toLocaleDateString();
                const row = `
            <tr>
                <td>${(page * size) + index + 1}</td>
                <td class="maHoaDon">${hoaDon.maHoaDon}</td>
                <td class="maNhanVien">${hoaDon.maNhanVien}</td>
                <td class="hoVaTenKhachHang">${hoaDon.hoVaTenKhachHang}</td>
                <td class="soDienThoaiKhachHang">${hoaDon.soDienThoaiKhachHang}</td>
                <td class="loai">${hoaDon.loai == false ? "Online" : "Tại quầy"}</td>
                <td class="ngayTao">${ngayTaoFormatted}</td>
                <td class="tongTien">${hoaDon.tongTien}</td>
                <td class="trangThai">
                    <span style="width: 90%; color: black; font-size: 90%;"
                        class="${hoaDon.trangThai === 'hủy' ? 'badge badge-danger' : 'badge badge-success'}">
                        ${hoaDon.trangThai}
                    </span>
                </td>
                <td style="display: flex">
                    <button class="btn mb-2 mr-1 btn-warning" type="button" onclick="showDetailContent('${hoaDon.id}')">
                        <span class="fe fe-eye"></span>
                    </button>
                </td>
            </tr>
        `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            // Tạo các nút phân trang
            const paginationElement = document.getElementById('pagination');
            paginationElement.innerHTML = ''; // Xóa nút phân trang hiện tại

            // Tạo nút Previous nếu có trang trước đó
            if (data.number > 0) {
                const previousButton = `<li class="page-item"><a class="page-link" href="#" onclick="fetchDataAndRenderTable(${data.number - 1}, ${data.size})">Previous</a></li>`;
                paginationElement.insertAdjacentHTML('beforeend', previousButton);
            }

            // Tạo các nút trang
            for (let i = 0; i < data.totalPages; i++) {
                const pageButton = `<li class="page-item ${i === data.number ? 'active' : ''}"><a class="page-link" href="#" onclick="fetchDataAndRenderTable(${i}, ${data.size})">${i + 1}</a></li>`;
                paginationElement.insertAdjacentHTML('beforeend', pageButton);
            }

            // Tạo nút Next nếu có trang tiếp theo
            if (data.number < data.totalPages - 1) {
                const nextButton = `<li class="page-item"><a class="page-link" href="#" onclick="fetchDataAndRenderTable(${data.number + 1}, ${data.size})">Next</a></li>`;
                paginationElement.insertAdjacentHTML('beforeend', nextButton);
            }
        }

        function searchInvoices(query) {
            currentSearchQuery = query.trim() === "" ? null : query;
            fetchDataAndRenderTable();
        }

        function searchMinMoney(minMoney) {
            currentSearchMinMoney = minMoney.trim() === "" ? null : minMoney;
            fetchDataAndRenderTable();
        }

        function searchMaxMoney(maxMoney) {
            currentSearchMaxMoney = maxMoney.trim() === "" ? null : maxMoney;
            fetchDataAndRenderTable();
        }

        function filterTable() {
            const statusFilter = document.getElementById('statusFilter').value;
            currentStatusFilter = statusFilter === "all" ? null : statusFilter;
            fetchDataAndRenderTable();
        }

        // Hàm để ẩn nội dung ban đầu và hiển thị nội dung mới
        function showDetailContent(hoaDonId) {
            // Lưu trữ nội dung chính ban đầu
            if (!originalMainContent) {
                originalMainContent = document.querySelector('.main-content').innerHTML;
            }

            // Ẩn nội dung chính
            document.querySelector('.main-content').style.display = 'none';
            let initialTableData2 = [];
            // Giả sử fetchInvoiceDetails là hàm gọi API để lấy chi tiết hóa đơn
            fetch(`/hoa-don/${hoaDonId}`)
                .then(response => response.json())
                .then(data => {
                    // Tạo nội dung mới với chi tiết hóa đơn
                    const newContent = `
                <div class="container-fluid">
                    <div class="row justify-content-center">
                        <div class="col-12">
                            <h2 class="mb-2 page-title">Chi tiết hóa đơn</h2>
                            <div class="row my-4">
                                <div class="col-md-12">
                                    <div class="card shadow">
                                        <div class="card-body">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Tên sản phẩm</th>
                                                        <th>Số lượng</th>
                                                        <th>Đơn giá</th>
                                                        <th>Thành tiền</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="detailTableBody">
                                                </tbody>
                                            </table>
                                            <button class="btn btn-primary" onclick="returnToMainContent()">Quay lại</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

                    // Thêm nội dung mới vào main-content
                    document.querySelector('.main-content').insertAdjacentHTML('beforeend', newContent);

                    // Sử dụng forEach để tạo các hàng trong bảng chi tiết
                    const tableData2 = data.content || data; // Kiểm tra nếu data.content không tồn tại, sử dụng data trực tiếp
                    initialTableData2 = tableData2;
                    const detailTableBody = document.getElementById('detailTableBody');
                    detailTableBody.innerHTML = ''; // Xóa dữ liệu hiện tại trong bảng
                    initialTableData2.forEach(hdct => {
                        const detailRow = `
                    <tr>
                        <td>${hdct.id}</td>
                        <td>${hdct.tienSan}</td>
                        <td>${hdct.tenSanBong}</td>
                        <td>${hdct.tenCa}</td>
                    </tr>
                `;
                        detailTableBody.insertAdjacentHTML('beforeend', detailRow);
                    });
                })
                .catch(error => console.error('Error fetching invoice details:', error));
        }

        function returnToMainContent() {
            // Hiển thị lại nội dung chính và xóa nội dung chi tiết hóa đơn
            document.querySelector('.main-content').style.display = 'block';
            document.querySelector('.main-content').innerHTML = originalMainContent;
            fetchDataAndRenderTable(); // Gọi lại hàm để fetch và render lại dữ liệu
        }

</script>
</html>

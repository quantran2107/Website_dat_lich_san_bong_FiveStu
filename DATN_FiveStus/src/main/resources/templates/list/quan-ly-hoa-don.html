<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="fragment/head :: head"></head>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<body class="vertical light">
<div class="wrapper">
    <div th:include="fragment/navbar :: navbar"></div>
    <div th:include="fragment/sidebar :: sidebar"></div>
    <main role="main" class="main-content">
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-12">
                    <h2 class="mb-2 page-title">Quản lý hóa đơn</h2>
                    <p class="card-text"></p>
                    <div class="row my-4">
                        <!-- Small table -->
                        <div class="col-md-12">
                            <div class="card shadow">
                                <div class="card-body">
                                    <div class="toolbar row mb-3">
                                        <div class="col">
                                            <form class="form-inline">
                                                <div class="form-row">
                                                    <div class="form-group col-auto">
                                                        <label for="search" class="sr-only">Tìm kiếm</label>
                                                        <input type="text" class="form-control" id="search"
                                                               placeholder="Search" oninput="searchInvoices(this.value)">
                                                    </div>
                                                    <div class="form-group col-auto ml-3">
                                                        <label class="my-1 mr-2 sr-only"
                                                               for="inlineFormCustomSelectPref">Status</label>
                                                        <select class="custom-select my-1 mr-sm-2"
                                                                id="inlineFormCustomSelectPref">
                                                            <option selected>Trạng thái</option>
                                                            <option value="1">Hoạt động</option>
                                                            <option value="2">Kết thúc</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col ml-auto">
                                            <div class="dropdown float-right">
                                                <button class="btn btn-secondary dropdown-toggle" type="button"
                                                        id="actionMenuButton" data-toggle="dropdown"
                                                        aria-haspopup="true" aria-expanded="false"> Hành động
                                                </button>
                                                <div class="dropdown-menu" aria-labelledby="actionMenuButton">
                                                    <a class="dropdown-item" href="#">Export</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- table -->
                                    <table class="table datatables" id="dataTable-1">
                                        <thead>
                                        <tr>
                                            <th>STT</th>
                                            <th>Mã hóa đơn</th>
                                            <th>Tên khách hàng</th>
                                            <th>Mã nhân viên</th>
                                            <th>Loại</th>
                                            <th>Ngày tạo</th>
                                            <th>Tổng tiền</th>
                                            <th>Trạng thái</th>
                                            <th>Hành động</th>
                                        </tr>
                                        </thead>
                                        <tbody id="tableBody">

                                        </tbody>
                                    </table>

                                    <nav aria-label="Table Paging" class="mb-0 text-muted">
                                        <ul id="pagination" class="pagination justify-content-end mb-0">
                                            <!-- Các nút phân trang sẽ được thêm bởi JavaScript -->
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div> <!-- simple table -->
                    </div> <!-- end section -->
                </div> <!-- .col-12 -->
            </div> <!-- .row -->
        </div> <!-- .container-fluid -->
        <div th:include="fragment/modal :: modal"></div>
    </main>
</div>
</body>
<div th:include="fragment/script :: script"></div>
<script th:inline="javascript">
    // function showDetailModal(button) {
    //     var dataTarget = button.getAttribute("data-target");
    //     var idHoaDon = dataTarget.substring(dataTarget.lastIndexOf("#detailModal") + "#detailModal".length);
    //
    //     // Gọi API để lấy dữ liệu chi tiết hóa đơn
    //     var apiURL = "http://localhost:8080/hoa-don-chi-tiet/hien-thi/" + idHoaDon;
    //     $.get(apiURL, function (data) {
    //         var listHDCT = data;
    //
    //         // Xử lý dữ liệu nhận được
    //         var tableBody = $('#dataTable-1-custom .table-body-custom');
    //         tableBody.empty();
    //
    //         $.each(listHDCT, function (index, hdct) {
    //             var row = $('<div class="table-row-custom"></div>');
    //
    //             $('<div class="table-cell-custom"></div>').text(index + 1).appendTo(row);
    //             $('<div class="table-cell-custom"></div>').text(hdct.tenSanBong).appendTo(row);
    //             $('<div class="table-cell-custom"></div>').text(hdct.tenCa).appendTo(row);
    //             $('<div class="table-cell-custom"></div>').text(hdct.tienSan).appendTo(row);
    //             $('<div class="table-cell-custom"></div>').text(hdct.ghiChu).appendTo(row);
    //             $('<div class="table-cell-custom"></div>').text(hdct.trangThai).appendTo(row);
    //
    //             row.appendTo(tableBody);
    //         });
    //     });
    // }

    function searchInvoices(query) {
        if (query.trim() === "") {
            // Nếu ô input trống, gọi API lấy toàn bộ danh sách
            apiURL = "http://localhost:8080/hoa-don/hien-thi";
        }else{
            var apiURL = "http://localhost:8080/hoa-don/search?key=" + query;
        }

        $.get(apiURL, function (data) {
            var listHD = data;

            var tableBody = $('#dataTable-1 tbody');
            tableBody.empty();

            $.each(listHD, function (index, hd) {
                const ngayTaoFormatted = new Date(hd.ngayTao).toLocaleDateString();
                var row = $('<tr></tr>');

                $('<td></td>').text(index + 1).appendTo(row);
                $('<td></td>').text(hd.maHoaDon).appendTo(row);
                $('<td></td>').text(hd.hoVaTenKhachHang).appendTo(row);
                $('<td></td>').text(hd.maNhanVien).appendTo(row);
                $('<td></td>').text(hd.loai).appendTo(row);
                $('<td></td>').text(ngayTaoFormatted).appendTo(row);
                $('<td></td>').text(hd.tongTien).appendTo(row);
                $('<td></td>').text(hd.trangThai).appendTo(row);

                var actionCell = $('<td style="display: flex"></td>');
                var detailButton = $('<button class="btn mb-2 mr-1 btn-warning" data-toggle="modal"></button>')
                    .attr('data-target', '#detailModal' + hd.id)
                    .attr('onclick', 'showDetailModal(this)')
                    .append('<span class="fe fe-eye"></span>');
                actionCell.append(detailButton);
                row.append(actionCell);

                tableBody.append(row);
            });
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        fetchDataAndRenderTable();
    });
    let initialTableData = [];

    function fetchDataAndRenderTable(page = 0, size = 10) {
        fetch(`/hoa-don/phan-trang?trang=${page}&kichThuoc=${size}`) // Gọi API để lấy dữ liệu phân trang
            .then(response => response.json())
            .then(data => {
                initialTableData = data.content;
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = ''; // Xóa dữ liệu hiện tại trong bảng


                data.content.forEach((hoaDon, index) => {
                    // Xử lý hiển thị dữ liệu theo từng trường
                    const ngayTaoFormatted = new Date(hoaDon.ngayTao).toLocaleDateString();
                    const row = `
                    <tr>
                        <td>${(page * size) + index + 1}</td>
                        <td class="maHoaDon">${hoaDon.maHoaDon}</td>
                        <td class="hoVaTenKhachHang">${hoaDon.hoVaTenKhachHang}</td>
                        <td class="maNhanVien">${hoaDon.maNhanVien}</td>
                        <td class="loai">${hoaDon.loai == false ? "Online" : "Tại quầy"} </td>
                        <td class="ngayTao">${ngayTaoFormatted}</td>
                        <td class="tongTien">${hoaDon.tongTien}</td>
                        <td class="trangThai">${hoaDon.trangThai}</td>
                          <td style="display: flex">
                                <button class="btn mb-2 mr-1 btn-warning" type="button" data-toggle="modal">
                                    <span class="fe fe-eye"></span>
                                </button>
                          </td>
                    </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
                // Tạo các nút phân trang
                const paginationElement = document.getElementById('pagination');
                paginationElement.innerHTML = ''; // Xóa nút phân trang hiện tại

                // Tạo nút Previous nếu có trang trước đó
                if (data.number > 0) {
                    const previousButton = `<li class="page-item"><a class="page-link" href="#"
                    onclick="fetchDataAndRenderTable(${data.number - 1}, ${data.size})">Previous</a></li>`;
                    paginationElement.insertAdjacentHTML('beforeend', previousButton);
                }

                // Tạo các nút trang
                for (let i = 0; i < data.totalPages; i++) {
                    const pageButton = `<li class="page-item ${i === data.number ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="fetchDataAndRenderTable(${i}, ${data.size})">${i + 1}</a></li>`;
                    paginationElement.insertAdjacentHTML('beforeend', pageButton);
                }

                // Tạo nút Next nếu có trang tiếp theo
                if (data.number < data.totalPages - 1) {
                    const nextButton = `<li class="page-item"><a class="page-link" href="#"
                    onclick="fetchDataAndRenderTable(${data.number + 1}, ${data.size})">Next</a></li>`;
                    paginationElement.insertAdjacentHTML('beforeend', nextButton);
                }
            })
            .catch(error => console.error('Error fetching data:', error));
    }
</script>
</html>
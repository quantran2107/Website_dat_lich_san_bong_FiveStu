<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="fragment/head :: head"></head>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet">
<script crossorigin="anonymous"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .chart-container {
        width: 50%; /* Bạn có thể điều chỉnh lại theo ý muốn */
        max-width: 600px; /* Kích thước tối đa của biểu đồ */
        margin: 0 auto; /* Căn giữa */
    }
    .stat-card {
        border-radius: 8px;
        color: #fff;
        padding: 20px;
        text-align: center;
    }
    .stat-today { background-color: #009688; }
    .stat-week { background-color: #ff9800; }
    .stat-month { background-color: #2196f3; }
    .stat-year { background-color: #4caf50; }
    .stat-custom { background-color: #4c6faf; }
    .stat-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .stat-info-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
    }
    .stat-info {
        flex: 1;
        text-align: center;
    }
    .btn-filter {
        background-color: white;
        color: black;
        border: 1px solid #4caf50;
    }
    .btn-filter:hover,
    .btn-filter.active {
        background-color: #4caf50;
        color: white;
        border: 1px solid #4caf50;
    }
    /* CSS tùy chỉnh cho input ngày */
    input[type="date"]::-webkit-calendar-picker-indicator {
        background: #007bff; /* Màu nền của calendar */
        border-radius: 50%;
        padding: 5px;
        cursor: pointer;
    }

    input[type="date"]::-webkit-input-placeholder {
        color: #6c757d;
    }

    input[type="date"] {
        font-size: 1rem;
        padding: 10px;
        border-radius: 0.25rem;
        border: 1px solid #ced4da;
        width: 100%;
    }

    .input-group {
        display: flex;
        align-items: center;
    }
</style>
<body class="vertical light">
<div class="wrapper">
    <div th:include="fragment/navbar :: navbar"></div>
    <div th:include="fragment/sidebar :: sidebar"></div>
    <main class="main-content" role="main">
        <div class="container-fluid" id="bodyContent">
            <div class="row justify-content-center">
                <div class="col-12">
                    <h2 class="mb-2 page-title">Thống kê</h2>
                    <div class="row my-4">
                        <div class="col-md-12">
                            <div class="card shadow">
                                <div class="card-body">
                                    <div class="col">
                                        <form class="form-inline">
                                            <div class="form-row">
                                                <div class="form-group col-auto ml-3">
                                                    <h4 class="card-title">Doanh thu</h4>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="toolbar row">
                                        <div class="col">
                                            <div class="form-row mb-1">
                                                <div class="col-6">
                                                    <div class="stat-card stat-today">
                                                        <div class="stat-title">Hôm nay</div>
                                                        <div id="today-revenue" class="stat-value">Loading...</div>
                                                        <div class="stat-info-row">
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lịch đặt:</div>
                                                                <div id="today-products"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lượt đá:</div>
                                                                <div id="today-success"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lịch bị hủy:</div>
                                                                <div id="today-cancel"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng tiền dịch vụ:</div>
                                                                <div id="today-return"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="stat-card stat-week">
                                                        <div class="stat-title">Tuần này</div>
                                                        <div id="week-revenue" class="stat-value">Loading...</div>
                                                        <div class="stat-info-row">
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lịch đặt:</div>
                                                                <div id="week-products"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lượt đá:</div>
                                                                <div id="week-success"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lịch bị hủy:</div>
                                                                <div id="week-cancel"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng tiền dịch vụ:</div>
                                                                <div id="week-return"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row mb-1">
                                                <div class="col-6">
                                                    <div class="stat-card stat-month">
                                                        <div class="stat-title">Tháng này</div>
                                                        <div id="month-revenue" class="stat-value">Loading...</div>
                                                        <div class="stat-info-row">
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lịch đặt:</div>
                                                                <div id="month-products"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lượt đá:</div>
                                                                <div id="month-success"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lịch bị hủy:</div>
                                                                <div id="month-cancel"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng tiền dịch vụ:</div>
                                                                <div id="month-return"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="stat-card stat-year">
                                                        <div class="stat-title">Năm nay</div>
                                                        <div id="year-revenue" class="stat-value">Loading...</div>
                                                        <div class="stat-info-row">
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lịch đặt:</div>
                                                                <div id="year-products"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lượt đá:</div>
                                                                <div id="year-success"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lịch bị hủy:</div>
                                                                <div id="year-cancel"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng tiền dịch vụ:</div>
                                                                <div id="year-return"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-row mb-1" id="custom-div" style="display: none;">
                                                <div class="col-12">
                                                    <div class="stat-card stat-custom">
                                                        <div class="stat-title">Tùy chỉnh</div>
                                                        <div id="custom-revenue" class="stat-value">Loading...</div>
                                                        <div class="stat-info-row">
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lịch đặt:</div>
                                                                <div id="custom-products"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lượt đá:</div>
                                                                <div id="custom-success"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng lịch bị hủy:</div>
                                                                <div id="custom-cancel"></div>
                                                            </div>
                                                            <div class="stat-info">
                                                                <div class="stat-info">Tổng tiền dịch vụ:</div>
                                                                <div id="custom-return"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row my-4">
                        <div class="col-md-12">
                            <div class="card shadow">
                                <div class="card-body">
                                    <div class="col">
                                        <form class="form-inline">
                                            <div class="form-row">
                                                <div class="form-group col-auto ml-3">
                                                    <h4 class="card-title">Bộ lọc</h4>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="toolbar row">
                                        <div class="col">
                                            <!-- Nút Bộ lọc -->
                                            <button type="button" class="btn btn-filter mx-1 active" onclick="selectFilter(this, 'week')">NGÀY</button>
                                            <button type="button" class="btn btn-filter mx-1" onclick="selectFilter(this, 'month')">THÁNG</button>
                                            <button type="button" class="btn btn-filter mx-1" onclick="selectFilter(this, 'year')">NĂM</button>
                                            <button type="button" class="btn btn-filter mx-1" id="customFilterBtn" onclick="selectFilter(this, 'custom')">TÙY CHỈNH</button>

                                            <!-- Ô nhập ngày, chỉ hiển thị khi nhấn vào "TÙY CHỈNH" -->
                                            <div class="form-inline" id="customDateInputs" style="display: none;">
                                                <div class="input-group col-md-1">
                                                    <label for="ngayBatDau" class="col-form-label">Từ</label>
                                                </div>
                                                <div class="input-group col-md-5" id="inputNgayBatDau" >
                                                    <input type="date" id="ngayBatDau" class="form-control" style="width: 100%;" />
                                                </div>
                                                <div class="input-group col-md-1">
                                                    <label for="ngayKetThuc" class="col-form-label">Đến</label>
                                                </div>
                                                <div class="input-group col-md-5" id="inputNgayKetThuc" >
                                                    <input type="date" id="ngayKetThuc" class="form-control" style="width: 100%;" />
                                                </div>
                                                <button type="button" class="btn btn-filter mx-1" id="customFilterBtn2" onclick="selectFilter(this, 'custom')">XÁC NHẬN</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <canvas id="myLineChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<script>
    const ngayBatDauInput = document.getElementById('ngayBatDau');
    const ngayKetThucInput = document.getElementById('ngayKetThuc');

    async function fetchWeeklyData() {

        const startDate = new Date(getMondayOfCurrentWeek().split('/').reverse().join('-'));

        const dichVuPromises = [];

        // Duyệt qua từng ngày trong tuần để lấy dữ liệu
        for (let i = 0; i < 7; i++) {
            let tongDanhThuNgay = 0;
            let tongTienDichVu = 0;

            // Gọi API để lấy dữ liệu hóa đơn chi tiết cho từng ngày trong tuần
            const response = await fetch(`http://localhost:8080/hoa-don-chi-tiet/khoang-ngay-den-san?startDate=${startDate.toLocaleDateString('en-GB')}&endDate=${startDate.toLocaleDateString('en-GB')}`);

            // Kiểm tra lỗi phản hồi
            if (!response.ok) {
                console.error('Error fetching data for the day', startDate.toLocaleDateString('en-GB'));
                continue; // Bỏ qua nếu có lỗi trong việc fetch dữ liệu
            }

            const data = await response.json();
            const dailyDichVuPromises = []; // Mảng Promise dành cho dịch vụ mỗi ngày

            // Duyệt qua từng hóa đơn trong dữ liệu
            data.forEach(item => {
                if(item.trangThai === "Đã thanh toán"){
                    tongDanhThuNgay += item.tongTienThucTe;
                }

                // Gọi API dịch vụ cho từng hóa đơn
                dailyDichVuPromises.push(
                    fetch(`http://localhost:8080/dich-vu-san-bong/dichVuSanBongTheoHoaDon/${item.id}`)
                        .then(response => response.json())
                        .then(dichVuData => {
                            dichVuData.forEach(dichVu => {
                                tongTienDichVu += dichVu.tongTien || 0;
                            });
                        })
                        .catch(error => console.error('Error fetching service data:', error))
                );
            });

            // Đợi tất cả các Promise dịch vụ hoàn thành
            await Promise.all(dailyDichVuPromises);

            // Lưu tổng doanh thu và tiền dịch vụ vào mảng tương ứng
            dataSets.week.data.push(tongDanhThuNgay);
            dataSets.week.dataSet2.push(tongTienDichVu);

            // Tăng ngày lên 1 ngày cho ngày tiếp theo
            startDate.setDate(startDate.getDate() + 1); // Thêm một ngày vào startDate
        }
    }

    fetchWeeklyData();

    const startDate = new Date(getMondayOfCurrentWeek().split('/').reverse().join('-'));

    const weekLabels = [];

    // Tính toán các ngày trong tuần và thêm vào labels dưới dạng "dd/MM/yyyy"
    for (let i = 0; i < 7; i++) {
        const formattedDate = startDate.toLocaleDateString('en-GB'); // Định dạng ngày theo kiểu "dd/MM/yyyy"
        weekLabels.push(formattedDate);

        // Tăng ngày lên 1 ngày cho ngày tiếp theo
        startDate.setDate(startDate.getDate() + 1);
    }

    async function fetchMonthlyData() {

        const startDate = new Date(getFirstDayOfMonth().split('/').reverse().join('-'));
        console.log("startDate: " + startDate);
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);

        // Duyệt qua từng ngày trong tuần để lấy dữ liệu
        for (let i = 0; i < 5; i++) {
            let tongDanhThuTuan = 0;
            let tongTienDichVuTuan = 0;

            // Gọi API để lấy dữ liệu hóa đơn chi tiết cho từng tuần
            const response = await fetch(`http://localhost:8080/hoa-don-chi-tiet/khoang-ngay-den-san?startDate=${startDate.toLocaleDateString('en-GB')}&endDate=${endDate.toLocaleDateString('en-GB')}`);

            if (!response.ok) {
                console.error('Error fetching data for the week', startDate.toLocaleDateString('en-GB'));
                continue;
            }

            const data = await response.json();

            const weekDichVuPromises = [];

            data.forEach(item => {
                if(item.trangThai === "Đã thanh toán"){
                    tongDanhThuTuan += item.tongTienThucTe;
                }
                weekDichVuPromises.push(
                    fetch(`http://localhost:8080/dich-vu-san-bong/dichVuSanBongTheoHoaDon/${item.id}`)
                        .then(response => response.json())
                        .then(dichVuData => {
                            dichVuData.forEach(dichVu => {
                                tongTienDichVuTuan += dichVu.tongTien || 0;
                            });
                        })
                        .catch(error => console.error('Error fetching service data:', error))
                );
            });

            // Đợi tất cả các Promise dịch vụ hoàn thành
            await Promise.all(weekDichVuPromises);

            dataSets.month.data.push(tongDanhThuTuan);
            dataSets.month.dataSet2.push(tongTienDichVuTuan);

            // Tăng ngày lên 7 ngày cho tuần tiếp theo
            startDate.setDate(startDate.getDate() + 7);
            endDate.setDate(endDate.getDate() + 7);
        }
    }

    fetchMonthlyData();

    const startDateMonth = new Date(getFirstDayOfMonth().split('/').reverse().join('-'));

    const monthLabels = [];

    // Tính toán các ngày trong tuần và thêm vào labels dưới dạng "dd/MM/yyyy"
    for (let i = 0; i < 5; i++) {
        const formattedDate = startDateMonth.toLocaleDateString('en-GB'); // Định dạng ngày theo kiểu "dd/MM/yyyy"
        monthLabels.push(formattedDate);

        // Tăng ngày của `startDateMonth` lên 7 ngày cho tuần tiếp theo
        startDateMonth.setDate(startDateMonth.getDate() + 7);
    }

    async function fetchYearlyData() {
        const currentYear = new Date().getFullYear();
        for (let month = 0; month < 12; month++) {
            const startDate = new Date(currentYear, month, 1); // Ngày đầu tiên của tháng
            const endDate = getLastDayOfMonth2(currentYear, month); // Ngày cuối cùng của tháng

            let tongDanhThuThang = 0;
            let tongTienDichVuThang = 0;

            const response = await fetch(`http://localhost:8080/hoa-don-chi-tiet/khoang-ngay-den-san?startDate=${startDate.toLocaleDateString('en-GB')}&endDate=${endDate.toLocaleDateString('en-GB')}`);

            if (!response.ok) {
                console.error('Error fetching data for the month', startDate.toLocaleDateString('en-GB'));
                continue;
            }

            const data = await response.json();
            const monthDichVuPromises = [];

            data.forEach(item => {
                if(item.trangThai === "Đã thanh toán"){
                    tongDanhThuThang += item.tongTienThucTe;
                }
                monthDichVuPromises.push(
                    fetch(`http://localhost:8080/dich-vu-san-bong/dichVuSanBongTheoHoaDon/${item.id}`)
                        .then(response => response.json())
                        .then(dichVuData => {
                            dichVuData.forEach(dichVu => {
                                tongTienDichVuThang += dichVu.tongTien || 0;
                            });
                        })
                        .catch(error => console.error('Error fetching service data:', error))
                );
            });

            await Promise.all(monthDichVuPromises);

            dataSets.year.data.push(tongDanhThuThang);
            dataSets.year.dataSet2.push(tongTienDichVuThang);
        }
    }

    fetchYearlyData();

    const customLabels = [];

    async function fetchCustomData() {
        // Xóa dữ liệu cũ trước khi fetch mới
        dataSets.custom.data = [];
        dataSets.custom.dataSet2 = [];
        customLabels.length = 0;

        const startDateCustom = formatToFullDate(ngayBatDauInput.value);
        const totalDays = calculateTotalDays(ngayBatDauInput.value, ngayKetThucInput.value);
        const dichVuPromisesCustom = [];

        // Duyệt qua từng ngày trong tuần để lấy dữ liệu
        for (let i = 0; i < totalDays; i++) {
            let tongDanhThuNgayCustom = 0;
            let tongTienDichVuCustom = 0;

            // Gọi API để lấy dữ liệu hóa đơn chi tiết cho từng ngày trong tuần
            const response = await fetch(`http://localhost:8080/hoa-don-chi-tiet/khoang-ngay-den-san?startDate=${startDateCustom.toLocaleDateString('en-GB')}&endDate=${startDateCustom.toLocaleDateString('en-GB')}`);

            // Kiểm tra lỗi phản hồi
            if (!response.ok) {
                console.error('Error fetching data for the day', startDateCustom);
                continue; // Bỏ qua nếu có lỗi trong việc fetch dữ liệu
            }

            const data = await response.json();
            const dailyDichVuPromisesCustom = []; // Mảng Promise dành cho dịch vụ mỗi ngày

            // Duyệt qua từng hóa đơn trong dữ liệu
            data.forEach(item => {
                tongDanhThuNgayCustom += item.tongTienThucTe;

                // Gọi API dịch vụ cho từng hóa đơn
                dailyDichVuPromisesCustom.push(
                    fetch(`http://localhost:8080/dich-vu-san-bong/dichVuSanBongTheoHoaDon/${item.id}`)
                        .then(response => response.json())
                        .then(dichVuData => {
                            dichVuData.forEach(dichVu => {
                                tongTienDichVuCustom += dichVu.tongTien || 0;
                            });
                        })
                        .catch(error => console.error('Error fetching service data:', error))
                );
            });

            // Đợi tất cả các Promise dịch vụ hoàn thành
            await Promise.all(dailyDichVuPromisesCustom);

            // Lưu tổng doanh thu và tiền dịch vụ vào mảng tương ứng
            dataSets.custom.data.push(tongDanhThuNgayCustom);
            dataSets.custom.dataSet2.push(tongTienDichVuCustom);

            const formattedDate = startDateCustom.toLocaleDateString('en-GB'); // Định dạng ngày theo kiểu "dd/MM/yyyy"
            customLabels.push(formattedDate);

            // Tăng ngày lên 1 ngày cho ngày tiếp theo
            startDateCustom.setDate(startDateCustom.getDate() + 1); // Thêm một ngày vào startDate
        }
    }

    const ctx = document.getElementById('myLineChart').getContext('2d');

    // Biểu đồ mặc định (hiển thị dữ liệu theo ngày)
    const myLineChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Tổng doanh thu',
                data: [],
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: false,
                    text: ''
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Dữ liệu mẫu cho từng khoảng thời gian
    const dataSets = {
        week: {
            labels: weekLabels,
            data: [],
            dataSet2: []
        },
        month: {
            labels: monthLabels,
            data: [],
            dataSet2: []
        },
        year: {
            labels: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6', 'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'],
            data: [],
            dataSet2: []
        },
        custom: {
            labels: customLabels,
            data: [],
            dataSet2: []
        }
    };

    // Hàm để cập nhật biểu đồ theo khoảng thời gian được chọn
    function selectFilter(button, timeRange) {
        // Xóa class 'active' khỏi tất cả các nút
        document.querySelectorAll('.btn-filter').forEach(btn => btn.classList.remove('active'));

        // Thêm class 'active' vào nút hiện tại
        button.classList.add('active');

        // Kiểm tra nếu là nút "TÙY CHỈNH" thì hiển thị ô nhập ngày
        var customDateInputs = document.getElementById("customDateInputs");
        var customDiv = document.getElementById("custom-div");
        if (timeRange === 'custom') {
            customDateInputs.style.display = "inline-flex";
            customDiv.style.display = "flex";
        } else {
            customDateInputs.style.display = "none";
            customDiv.style.display = "none";
        }
        const selectedData = dataSets[timeRange];

        // Cập nhật dữ liệu và nhãn cho biểu đồ
        myLineChart.data.labels = selectedData.labels;
        myLineChart.data.datasets[0].data = selectedData.data;

        // Thêm một tập dữ liệu mới nếu cần
        if (myLineChart.data.datasets.length < 2) {
            myLineChart.data.datasets.push({
                label: 'Tổng tiền dịch vụ',
                data: selectedData.dataSet2,
                borderColor: 'rgba(153, 102, 255, 1)',
                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                borderWidth: 2,
                fill: true
            });
        } else {
            myLineChart.data.datasets[1].data = selectedData.dataSet2;
        }

        myLineChart.update();
    }

    document.addEventListener("DOMContentLoaded", function() {

        setTimeout(function () {
            selectFilter(document.querySelector('.btn-filter.active'), 'week');
        }, 3000);

        ngayBatDauInput.addEventListener('change', function () {
            fetchCustomData();
            fetchStatistics2();
        });

        ngayKetThucInput.addEventListener('change', function () {
            fetchCustomData();
            fetchStatistics2();
        });

        flatpickr("#ngayBatDau", {});
        flatpickr("#ngayKetThuc", {});
    });

    // Hàm fetch dữ liệu từ API và cập nhật HTML
    function fetchStatistics() {
        const today = new Date();
        const formattedDate = today.toLocaleDateString('en-GB').split('/').join('/');
        console.log(formattedDate);

        let tongDanhThuNgay = 0;
        let tongTienDichVu = 0;
        let successfulOrdersCount = 0;
        let cancelOrdersCount = 0;
        let totalBookings = 0;

        const dichVuPromises = [];
        fetch(`http://localhost:8080/hoa-don-chi-tiet/khoang-ngay-den-san?startDate=${formattedDate}&endDate=${formattedDate}`)
            .then(response => response.json())
            .then(data => {
                totalBookings = data.length;
                // Duyệt qua từng hóa đơn chi tiết và cộng tổng tiền thực tế
                data.forEach(item => {
                    if (item.trangThai === "Đã thanh toán") {
                        successfulOrdersCount++;
                        tongDanhThuNgay += item.tongTienThucTe;
                    }

                    if (item.trangThai === "Đã hủy") {
                        cancelOrdersCount++;
                        tongDanhThuNgay += item.tienCocHdct;
                    }

                    if (item.trangThai === "Đang hoạt động") {
                        tongDanhThuNgay += item.tienCocHdct;
                    }

                    dichVuPromises.push(
                        fetch(`http://localhost:8080/dich-vu-san-bong/dichVuSanBongTheoHoaDon/${item.id}`)
                            .then(response => response.json())
                            .then(dichVuData => {
                                dichVuData.forEach(dichVu => {
                                    tongTienDichVu += dichVu.tongTien || 0;
                                });
                            })
                    );
                });
                Promise.all(dichVuPromises).then(() =>{
                    document.getElementById("today-revenue").innerText = tongDanhThuNgay.toLocaleString() + ' VNĐ';
                    document.getElementById("today-products").innerText = `${totalBookings}`;
                    document.getElementById("today-success").innerText = `${successfulOrdersCount}`;
                    document.getElementById("today-cancel").innerText = `${cancelOrdersCount}`;
                    document.getElementById("today-return").innerText = tongTienDichVu.toLocaleString() + ' VNĐ';
                });

            })
            .catch(error => console.error('Error fetching data:', error));

        const formattedDateTuan = getMondayOfCurrentWeek();
        const formattedDateTuan2 = getSundayOfCurrentWeek();

        let tongDanhThuTuan = 0;
        let tongTienDichVuTuan = 0;
        let successfulOrdersCountTuan = 0;
        let cancelOrdersCountTuan = 0;
        let totalBookingsTuan = 0;
        const dichVuPromisesTuan = [];
        fetch(`http://localhost:8080/hoa-don-chi-tiet/khoang-ngay-den-san?startDate=${formattedDateTuan}&endDate=${formattedDateTuan2}`)
            .then(response => response.json())
            .then(data => {
                totalBookingsTuan = data.length;
                // Duyệt qua từng hóa đơn chi tiết và cộng tổng tiền thực tế
                data.forEach(item => {
                    if (item.trangThai === "Đã thanh toán") {
                        successfulOrdersCountTuan++;
                        tongDanhThuTuan += item.tongTienThucTe;
                    }

                    if (item.trangThai === "Đã hủy") {
                        cancelOrdersCountTuan++;
                        tongDanhThuTuan += item.tienCocHdct;
                    }

                    if (item.trangThai === "Đang hoạt động") {
                        tongDanhThuTuan += item.tienCocHdct;
                    }

                    dichVuPromisesTuan.push(
                        fetch(`http://localhost:8080/dich-vu-san-bong/dichVuSanBongTheoHoaDon/${item.id}`)
                            .then(response => response.json())
                            .then(dichVuData => {
                                dichVuData.forEach(dichVu => {
                                    tongTienDichVuTuan += dichVu.tongTien || 0;
                                });
                            })
                    );
                });
                Promise.all(dichVuPromisesTuan).then(() =>{
                    document.getElementById("week-revenue").innerText = tongDanhThuTuan.toLocaleString() + ' VNĐ';
                    document.getElementById("week-products").innerText = `${totalBookingsTuan}`;
                    document.getElementById("week-success").innerText = `${successfulOrdersCountTuan}`;
                    document.getElementById("week-cancel").innerText = `${cancelOrdersCountTuan}`;
                    document.getElementById("week-return").innerText = tongTienDichVuTuan.toLocaleString() + ' VNĐ';
                });

            })
            .catch(error => console.error('Error fetching data:', error));

        const formattedDateThang = getFirstDayOfMonth();
        const formattedDateThang2 = getLastDayOfMonth();

        let tongDanhThuThang = 0;
        let tongTienDichVuThang = 0;
        let successfulOrdersCountThang = 0;
        let cancelOrdersCountThang = 0;
        let totalBookingsThang = 0;
        const dichVuPromisesThang = [];
        fetch(`http://localhost:8080/hoa-don-chi-tiet/khoang-ngay-den-san?startDate=${formattedDateThang}&endDate=${formattedDateThang2}`)
            .then(response => response.json())
            .then(data => {
                totalBookingsThang = data.length;
                // Duyệt qua từng hóa đơn chi tiết và cộng tổng tiền thực tế
                data.forEach(item => {
                    if (item.trangThai === "Đã thanh toán") {
                        successfulOrdersCountThang++;
                        tongDanhThuThang += item.tongTienThucTe;
                    }

                    if (item.trangThai === "Đã hủy") {
                        cancelOrdersCountThang++;
                        tongDanhThuThang += item.tienCocHdct;
                    }

                    if (item.trangThai === "Đang hoạt động") {
                        tongDanhThuThang += item.tienCocHdct;
                    }

                    dichVuPromisesThang.push(
                        fetch(`http://localhost:8080/dich-vu-san-bong/dichVuSanBongTheoHoaDon/${item.id}`)
                            .then(response => response.json())
                            .then(dichVuData => {
                                dichVuData.forEach(dichVu => {
                                    tongTienDichVuThang += dichVu.tongTien || 0;
                                });
                            })
                            .catch(error => {
                                console.error(`Error fetching service for id ${item.id}:`, error);
                            })
                    );
                });
                Promise.all(dichVuPromisesThang).then(() =>{
                    document.getElementById("month-revenue").innerText = tongDanhThuThang.toLocaleString() + ' VNĐ';
                    document.getElementById("month-products").innerText = `${totalBookingsThang}`;
                    document.getElementById("month-success").innerText = `${successfulOrdersCountThang}`;
                    document.getElementById("month-cancel").innerText = `${cancelOrdersCountThang}`;
                    document.getElementById("month-return").innerText = tongTienDichVuThang.toLocaleString() + ' VNĐ';
                });
            })
            .catch(error => console.error('Error fetching data:', error));

        const formattedDateNam = getFirstDayOfYear();
        const formattedDateNam2 = getLastDayOfYear();

        let tongDanhThuNam = 0;
        let tongTienDichVuNam = 0;
        let successfulOrdersCountNam = 0;
        let cancelOrdersCountNam = 0;
        let totalBookingsNam = 0;
        const dichVuPromisesNam = [];
        fetch(`http://localhost:8080/hoa-don-chi-tiet/khoang-ngay-den-san?startDate=${formattedDateNam}&endDate=${formattedDateNam2}`)
            .then(response => response.json())
            .then(data => {
                totalBookingsNam = data.length;
                // Duyệt qua từng hóa đơn chi tiết và cộng tổng tiền thực tế
                data.forEach(item => {
                    if (item.trangThai === "Đã thanh toán") {
                        successfulOrdersCountNam++;
                        tongDanhThuNam += item.tongTienThucTe;
                    }

                    if (item.trangThai === "Đã hủy") {
                        cancelOrdersCountNam++;
                        tongDanhThuNam += item.tienCocHdct;
                    }

                    if (item.trangThai === "Đang hoạt động") {
                        tongDanhThuNam += item.tienCocHdct;
                    }

                    dichVuPromisesNam.push(
                        fetch(`http://localhost:8080/dich-vu-san-bong/dichVuSanBongTheoHoaDon/${item.id}`)
                            .then(response => response.json())
                            .then(dichVuData => {
                                dichVuData.forEach(dichVu => {
                                    tongTienDichVuNam += dichVu.tongTien || 0;
                                });
                            })
                            .catch(error => {
                                console.error(`Error fetching service for id ${item.id}:`, error);
                            })
                    );
                });
                Promise.all(dichVuPromisesNam).then(() =>{
                    document.getElementById("year-revenue").innerText = tongDanhThuNam.toLocaleString() + ' VNĐ';
                    document.getElementById("year-products").innerText = `${totalBookingsNam}`;
                    document.getElementById("year-success").innerText = `${successfulOrdersCountNam}`;
                    document.getElementById("year-cancel").innerText = `${cancelOrdersCountNam}`;
                    document.getElementById("year-return").innerText = tongTienDichVuNam.toLocaleString() + ' VNĐ';
                });

            })
            .catch(error => console.error('Error fetching data:', error));
    }

    function fetchStatistics2(){
        const formattedDate = formatDate(ngayBatDauInput.value);
        const formattedDate2 = formatDate(ngayKetThucInput.value);

        let tongDanhThuCustom = 0;
        let tongTienDichVuCustom = 0;
        let successfulOrdersCountCustom = 0;
        let cancelOrdersCountCustom = 0;
        let totalBookingsCustom = 0;

        const dichVuPromisesCustom = [];
        fetch(`http://localhost:8080/hoa-don-chi-tiet/khoang-ngay-den-san?startDate=${formattedDate}&endDate=${formattedDate2}`)
            .then(response => response.json())
            .then(data => {
                totalBookingsCustom = data.length;
                // Duyệt qua từng hóa đơn chi tiết và cộng tổng tiền thực tế
                data.forEach(item => {
                    if (item.trangThai === "Đã thanh toán") {
                        successfulOrdersCountCustom++;
                        tongDanhThuCustom += item.tongTienThucTe;
                    }

                    if (item.trangThai === "Đã hủy") {
                        cancelOrdersCountCustom++;
                    }

                    dichVuPromisesCustom.push(
                        fetch(`http://localhost:8080/dich-vu-san-bong/dichVuSanBongTheoHoaDon/${item.id}`)
                            .then(response => response.json())
                            .then(dichVuData => {
                                dichVuData.forEach(dichVu => {
                                    tongTienDichVuCustom += dichVu.tongTien || 0;
                                });
                            })
                    );
                });
                Promise.all(dichVuPromisesCustom).then(() =>{
                    document.getElementById("custom-revenue").innerText = tongDanhThuCustom.toLocaleString() + ' VNĐ';
                    document.getElementById("custom-products").innerText = `${totalBookingsCustom}`;
                    document.getElementById("custom-success").innerText = `${successfulOrdersCountCustom}`;
                    document.getElementById("custom-cancel").innerText = `${cancelOrdersCountCustom}`;
                    document.getElementById("custom-return").innerText = tongTienDichVuCustom.toLocaleString() + ' VNĐ';
                });

            })
            .catch(error => console.error('Error fetching data:', error));
    }

    // Gọi hàm fetch khi trang được tải
    window.onload = fetchStatistics;

    function getMondayOfCurrentWeek() {
        const today = new Date();
        const day = today.getDay(); // Lấy ngày trong tuần (0 = Chủ nhật, 1 = Thứ hai, ...)
        const distanceToMonday = day === 0 ? 6 : day - 1; // Tính khoảng cách từ ngày hiện tại đến thứ Hai
        const monday = new Date(today); // Tạo bản sao của ngày hiện tại
        monday.setDate(today.getDate() - distanceToMonday); // Lùi ngày đến thứ Hai

        // Định dạng ngày thành dd/MM/yyyy (tuỳ chọn)
        return monday.toLocaleDateString('en-GB'); // Kết quả dạng "dd/MM/yyyy"
    }

    function getSundayOfCurrentWeek() {
        const today = new Date();
        const day = today.getDay(); // Lấy ngày trong tuần (0 = Chủ nhật, 1 = Thứ hai, ...)
        const distanceToSunday = day === 0 ? 0 : 7 - day; // Tính khoảng cách từ ngày hiện tại đến Chủ nhật
        const sunday = new Date(today); // Tạo bản sao của ngày hiện tại
        sunday.setDate(today.getDate() + distanceToSunday); // Tiến ngày đến Chủ nhật

        // Định dạng ngày thành dd/MM/yyyy (tuỳ chọn)
        return sunday.toLocaleDateString('en-GB'); // Kết quả dạng "dd/MM/yyyy"
    }

    function getFirstDayOfMonth() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1); // Ngày đầu tiên của tháng hiện tại

        // Định dạng ngày thành dd/MM/yyyy (tuỳ chọn)
        return firstDay.toLocaleDateString('en-GB'); // Kết quả dạng "dd/MM/yyyy"
    }

    function getLastDayOfMonth() {
        const today = new Date();
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0); // Ngày cuối cùng của tháng hiện tại

        // Định dạng ngày thành dd/MM/yyyy (tuỳ chọn)
        return lastDay.toLocaleDateString('en-GB'); // Kết quả dạng "dd/MM/yyyy"
    }

    function getFirstDayOfYear() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), 0, 1); // Ngày đầu tiên của năm hiện tại

        // Định dạng ngày thành dd/MM/yyyy (tuỳ chọn)
        return firstDay.toLocaleDateString('en-GB'); // Kết quả dạng "dd/MM/yyyy"
    }

    function getLastDayOfYear() {
        const today = new Date();
        const lastDay = new Date(today.getFullYear(), 11, 31); // Ngày cuối cùng của năm hiện tại

        // Định dạng ngày thành dd/MM/yyyy (tuỳ chọn)
        return lastDay.toLocaleDateString('en-GB'); // Kết quả dạng "dd/MM/yyyy"
    }

    function addOneDay(dateString) {
        // Chuyển đổi chuỗi ngày từ định dạng 'dd/MM/yyyy' thành đối tượng Date
        const [day, month, year] = dateString.split('/');
        const date = new Date(year, month - 1, day);  // Lưu ý: tháng bắt đầu từ 0

        // Thêm một ngày
        date.setDate(date.getDate() + 1);

        // Định dạng lại ngày thành 'dd/MM/yyyy'
        const newDay = String(date.getDate()).padStart(2, '0');
        const newMonth = String(date.getMonth() + 1).padStart(2, '0');
        const newYear = date.getFullYear();

        return `${newDay}/${newMonth}/${newYear}`;
    }

    function getLastDayOfMonth2(year, month) {
        return new Date(year, month + 1, 0); // Ngày 0 của tháng tiếp theo là ngày cuối cùng của tháng hiện tại
    }

    function calculateTotalDays(ngayBatDau, ngayKetThuc) {
        const start = new Date(ngayBatDau);
        const end = new Date(ngayKetThuc);
        return Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    }

    function formatDate(inputDate) {
        const [year, month, day] = inputDate.split("-");
        return `${day}/${month}/${year}`;
    }

    function formatToFullDate(inputDate) {
        return new Date(inputDate);
    }


</script>
</body>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<div th:include="fragment/script :: script"></div>
</html>
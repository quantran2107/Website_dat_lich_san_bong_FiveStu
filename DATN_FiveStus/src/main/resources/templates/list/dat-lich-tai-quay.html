<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="~{fragment/head :: head}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
    /* Hover màu xanh cho tất cả các dòng */
    .active-row {
        background-color: #14e34a; /* Màu nền khi được chọn */
    }

    .form-group label {
        font-weight: bold;
    }

    .form-group input {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
    }

    .row {
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    h5.text-primary {
        color: #007bff;
        margin-top: 20px;
    }

    .col-lg-3-dich-vu {
        flex: 0 0 auto;
        width: 30%;
    }

    h5.card-title {
        color: #28a745;
    }

    .text-center {
        text-align: center;
    }

    .hidden-field {
        display: none;
    }

    .form-group label {
        font-weight: bold;
    }

    .form-group input {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
    }

    .row {
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    /*#dichVuDaThueContainer {*/
    /*    padding: 20px; !* Padding cho container *!*/
    /*    max-height: 400px; !* Chiều cao tối đa cho container *!*/
    /*    overflow-y: auto; !* Thêm thanh cuộn dọc khi vượt quá chiều cao *!*/
    /*    border: 1px solid #dee2e6; !* Viền cho container *!*/
    /*    border-radius: 10px; !* Bo tròn góc *!*/
    /*    width: 250px; !* Chiều rộng cho container *!*/
    /*    height: 300px; !* Chiều cao cho container *!*/
    /*}*/

    #colTest {
        display: flex;
        flex-direction: column;
    }

    .card-body {
        flex: 1;
    }

    .d-flex {
        flex-wrap: wrap;
    }

    #dichVuDaThueContainer {
        flex: 0 0 250px; /* Set width to 250px */
    }


    #dichVuThueList {
        overflow-y: auto;
        padding: 10px;
    }


    /*#colTest {*/
    /*    display: flex;*/
    /*    flex-direction: column;*/
    /*    height: 250px; !* Set height to 330px *!*/
    /*}*/

    /*.card-body {*/
    /*    flex: 1;*/
    /*}*/

    /*.d-flex {*/
    /*    flex-wrap: wrap;*/
    /*}*/

    /*#dichVuDaThueContainer {*/
    /*    flex: 0 0 250px; !* Set width to 250px *!*/
    /*}*/

    /*#dichVuThueList {*/
    /*    overflow-y: auto; !* Enable vertical scrolling if content overflows *!*/
    /*    padding: 10px;*/
    /*    height: calc(250px  !* Height of other elements if any *!);*/
    /*}*/

    #filter {
        padding: 8px;
        margin-right: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 14px;
        color: #333;
    }

</style>
<body class="vertical light">
<div class="wrapper">
    <div th:include="~{fragment/navbar :: navbar}"></div>
    <div th:include="~{fragment/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <main class="main-content" role="main">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <h2 class="page-title">Đặt lịch</h2>
                </div>
            </div>

            <div class="row mt-4" id="content-dat-lich">
                <!--Phần NỘI DUNG trái-->
                <div class="col-md-7">
                    <!--Phần trên bên trái-->
                    <div class="row">
                        <!-- Phần Danh Sách Hóa Đơn -->
                        <div class="col-12 mb-3">
                            <div class="card shadow h-100">
                                <div class="card-body">
                                    <h5 class="card-title text-success">Danh sách hóa đơn</h5>
                                    <!-- Tìm kiếm -->
                                    <div class="toolbar row mb-3 mt-3">
                                        <div class="col-md-12">
                                            <form class="form-inline" id="filterForm"
                                                  style="display: flex; align-items: center;">
                                                <label class="me-2" for="search">Tìm kiếm</label>
                                                <input class="form-control me-2" id="search"
                                                       placeholder="Tìm kiếm theo mã hóa đơn, số điện thoại, tên, email khách hàng,..."
                                                       style="width: 400px;" type="text">
                                                <button class="btn btn-primary me-2" onclick="resetFilters('search')"
                                                        type="button">
                                                    <span class="fe fe-refresh-ccw"></span>
                                                </button>
                                                <button class="btn btn-warning " onclick="showCheckInList()"
                                                        title="Danh sách sân check-in" type="button">
                                                    <span class="fe fe-grid"></span>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    <!-- Hiển thị bảng -->
                                    <table class="table mt-2">
                                        <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Mã</th>
                                            <th>Tên KH</th>
                                            <th>SDT</th>
                                            <th>Email</th>
                                            <th>Sân ca</th>
                                            <th>Thời gian</th>
                                            <th>Ngày đặt lịch</th>
                                            <th>Hành động</th>
                                        </tr>
                                        </thead>
                                        <tbody id="dang-hoat-dong-table">
                                        <!-- Dữ liệu bảng -->
                                        </tbody>
                                    </table>
                                    <div class="pagination-container mt-3 d-flex justify-content-end align-items-center"
                                         id="pagination-container">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--End-->

                    <!--Phần dưới bên trái-->

                    <div class="row" id="colTest">
                        <div class="col-12">
                            <div class="card shadow">
                                <div class="card-body">
                                    <!-- Tiêu đề của box -->
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5>Dịch Vụ Đã Thuê</h5>
                                        <button class="btn btn-outline-success" title="Thêm dịch vụ" type="button"
                                                id="openServiceModal">
                                            <span class="fe fe-plus"></span>
                                        </button>
                                    </div>
                                    <div id="dichVuDaThueContainer" class="mt-4">
                                        <div id="dichVuThueList" class="row"
                                             style="max-height: 600px; overflow-y: auto;">
                                            <div class="col-12">
                                                <!-- Nội dung dịch vụ đã thuê sẽ ở đây -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--                End-->
                </div>

                <!--Modal dịch vụ-->
                <div class="modal fade" id="serviceModal" tabindex="-1" role="dialog"
                     aria-labelledby="serviceModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl" role="document">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title" id="serviceModalLabel">Thêm Dịch Vụ</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <ul class="nav nav-tabs flex" id="serviceTabs" role="tablist">
                                    <li class="nav-item flex-grow-1">
                                        <a class="nav-link active" id="tab1" data-toggle="tab" href="#doThueTab"
                                           role="tab">Đồ Thuê</a>

                                    </li>
                                    <li class="nav-item flex-grow-1">
                                        <a class="nav-link" id="tab2" data-toggle="tab" href="#nuocUongTab" role="tab">Nước
                                            Uống</a>

                                    </li>
                                </ul>
                                <input type="text" class="form-control search-input" placeholder="Tìm kiếm">
                                <div id="selectedServices"></div> <!-- Div để hiển thị dịch vụ đã chọn -->

                                <div class="tab-content" id="serviceTabContent"
                                     style="max-height: 600px; overflow-y: auto;">
                                    <div class="tab-pane fade show active row" id="doThueTab" role="tabpanel">
                                        <div class="search-results"></div>
                                    </div>
                                    <div class="tab-pane fade row" id="nuocUongTab" role="tabpanel">
                                        <div class="search-results"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phần Nội dung bên phải -->

            </div>
        </div>
    </main>

    <!--    Modal table check-in-->
    <div class="modal fade" id="checkInListModal" tabindex="-1" aria-labelledby="checkInListModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="checkInListModalLabel">Danh Sách Sân Chờ Nhận</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Input tìm kiếm -->
                    <div class="mb-3 d-flex">
                        <input type="text" id="checkInSearch" class="form-control me-2"
                               placeholder="Tìm kiếm theo mã hóa đơn, số điện thoại, tên, email khách hàng,..."
                               style="width: 400px;">
                        <button class="btn btn-primary me-2" onclick="resetFilters('checkInSearch')"
                                type="button">
                            <span class="fe fe-refresh-ccw"></span>
                        </button>
                    </div>
                    <table class="table ">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Mã</th>
                            <th>Tên KH</th>
                            <th>SDT</th>
                            <th>Email</th>
                            <th>Sân ca</th>
                            <th>Thời gian</th>
                            <th>Ngày đặt lịch</th>
                            <th>Hành động</th>
                        </tr>
                        </thead>
                        <tbody id="checkInListTable">
                        <!-- Nội dung sẽ được điền ở đây -->
                        </tbody>
                    </table>
                    <div id="modal-pagination-container"
                         class="d-flex justify-content-end align-items-center mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!--    End Modal-->

    <!-- Modal để thêm phụ phí -->
    <div id="phuPhiModal" class="modal fade" tabindex="-1"
         aria-labelledby="phuPhiModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="phuPhiModalLabel">Thêm Phụ Phí</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

                </div>
                <div class="modal-body">
                    <form id="phuPhiForm">
                        <div class="form-group mb-3">
                            <label for="tenPhuPhi">Tên Phụ Phí</label>
                            <input type="text" id="tenPhuPhi" class="form-control"
                                   placeholder="Tên Phụ Phí" required>
                        </div>
                        <div class="form-group mb-3">
                            <label for="giaPhuPhi">Giá Phụ Phí</label>
                            <div class="input-group">
                                <input type="number" id="giaPhuPhi" class="form-control"
                                       placeholder="0" required>
                                <span class="input-group-text">VND</span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-success" id="btnThemPhuPhi">
                            Thêm Phụ Phí
                        </button>
                    </form>
                    <table class="table mt-3">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Tên Phụ Phí</th>
                            <th>Giá Phụ Phí</th>
                            <th>Chọn</th>
                        </tr>
                        </thead>
                        <tbody id="phuPhiList">
                        <tr>
                            <!--                                Hiển thị phụ phí hóa đơn-->
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!--    End Modal-->
    <div th:include="~{fragment/modal :: modal}"></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script th:include="~{fragment/script :: script}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    //Hàm thông báo
    function showSuccessToast(message) {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            style: {
                background: "#4CAF50",
            },
            stopOnFocus: true
        }).showToast();
    }

    function showErrorToast(message) {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "center",
            style: {
                background: "#f44336",
            },
            stopOnFocus: true
        }).showToast();
    }

    //Nút reset
    function resetFilters(inputId) {
        const inputElement = document.getElementById(inputId);
        if (inputElement) {
            inputElement.value = ''; // Xóa nội dung trong ô input
        }

        // Kiểm tra xem đang reset ở bảng "Đang hoạt động" hay modal "Chờ nhận sân"
        if (inputId === 'search') {
            fetchData(0, '', "Đang hoạt động", 'dang-hoat-dong-table', 'pagination-container', false);
        } else if (inputId === 'checkInSearch') {
            fetchData(0, '', "Chờ nhận sân", 'checkInListTable', 'modal-pagination-container', true);
        }
    }

    let selectedInvoiceId = null; // Biến lưu trữ ID hóa đơn chi tiết được chọn

    // Lắng nghe sự kiện click trên bảng "Đang Hoạt Động"
    document.getElementById('dang-hoat-dong-table').addEventListener('click', function (event) {
        const clickedRow = event.target.closest('tr'); // Lấy dòng được click
        if (clickedRow) {
            // Xóa lớp `table-active` khỏi tất cả các dòng
            const rows = document.querySelectorAll('#dang-hoat-dong-table tr');
            rows.forEach(row => row.classList.remove('table-active'));

            // Thêm lớp `table-active` vào dòng được click
            clickedRow.classList.add('table-active');

            // Lưu lại ID hóa đơn chi tiết
            selectedInvoiceId = clickedRow.getAttribute('data-id'); // Lấy ID từ data-id
            console.log(selectedInvoiceId)
            // Hiển thị dịch vụ liên quan đến hóa đơn được chọn
            fillDichVuChoHoaDon(selectedInvoiceId);
        }
    });
    //End

    //Code table bên trái

    let currentPage = 0;
    let totalPages = 0;

    // Hàm fetch data từ server và hiển thị ra bảng
    async function fetchData(page = 0, keyWord = '', trangThai = "Đang hoạt động", tableBodyId = 'dang-hoat-dong-table', paginationContainerId = 'pagination-container', isModal = false) {
        try {
            const pageSize = 5;
            const url = `http://localhost:8080/hoa-don-chi-tiet/trang-thai?trangThai=${encodeURIComponent(trangThai)}&page=${page}&size=${pageSize}&keyWord=${encodeURIComponent(keyWord)}`;

            const response = await fetch(url);
            if (!response.ok) throw new Error(`Error ${response.status}: ${await response.text()}`);

            const data = await response.json();

            currentPage = data.number;
            totalPages = data.totalPages;

            const tableBody = document.getElementById(tableBodyId);
            if (!tableBody) return;

            tableBody.innerHTML = ''; // Xóa nội dung cũ của bảng

            // Hiển thị dữ liệu trong bảng
            if (Array.isArray(data.content) && data.content.length > 0) {
                data.content.forEach((item, index) => {
                    const thoiGianBatDau = new Date(item.thoiGianBatDauCa).toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const thoiGianKetThuc = new Date(item.thoiGianKetThucCa).toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', item.id);
                    row.innerHTML = `
                    <td>${index + 1 + (page * pageSize)}</td>
                    <td>${item.maHoaDonChiTiet || ''}</td>
                    <td>${item.hoVaTenKhachHang || ''}</td>
                    <td>${item.soDienThoaiKhachHang || ''}</td>
                    <td>${item.emailKhachHang || ''}</td>
                    <td>${item.tenSanBong || ''}</td>
                    <td>${thoiGianBatDau} - ${thoiGianKetThuc}</td>
                    <td>${item.ngayDenSan || ''}</td>
                    ${trangThai === "Chờ nhận sân" && isModal ? `<td>
                        <button class="btn btn-outline-success check-in-btn" title="Check in"  onclick="checkIn('${item.id}')">
                            <span class="fe fe-check-circle"></span>
                        </button>
                    </td>` : ''}
                `;
                    tableBody.appendChild(row);
                });
            } else {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="9" class="text-center">Không có dữ liệu</td>`;
                tableBody.appendChild(emptyRow);
            }

            // Cập nhật phân trang
            if (paginationContainerId) {
                updatePagination(currentPage, totalPages, keyWord, trangThai, tableBodyId, paginationContainerId, isModal);
            }

            // Ẩn cột "Hành động" nếu không phải trạng thái "Chờ nhận sân"
            if (!isModal) {
                const actionColumn = document.querySelector(`table thead th:nth-child(9)`);
                if (actionColumn) {
                    actionColumn.style.display = trangThai === "Chờ nhận sân" ? '' : 'none';
                }
            }

        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    // Hàm cập nhật phân trang
    function updatePagination(currentPage, totalPages, keyWord, trangThai, tableBodyId, paginationContainerId, isModal) {
        const paginationContainer = document.getElementById(paginationContainerId);
        if (!paginationContainer) return;

        paginationContainer.innerHTML = ''; // Xóa nội dung cũ

        // Nút Previous
        if (currentPage > 0) {
            const prevButton = document.createElement('button');
            prevButton.className = 'btn btn-success me-2';
            prevButton.textContent = '<';
            prevButton.onclick = () => {
                fetchData(currentPage - 1, keyWord, trangThai, tableBodyId, paginationContainerId, isModal);
            };
            paginationContainer.appendChild(prevButton);
        }

        // Hiển thị số trang hiện tại
        const pageDisplay = document.createElement('span');
        pageDisplay.className = 'btn btn-outline-secondary';
        pageDisplay.textContent = `Trang ${currentPage + 1}`;
        paginationContainer.appendChild(pageDisplay);

        // Nút Next
        if (currentPage < totalPages - 1) {
            const nextButton = document.createElement('button');
            nextButton.className = 'btn btn-success ms-2';
            nextButton.textContent = '>';
            nextButton.onclick = () => {
                fetchData(currentPage + 1, keyWord, trangThai, tableBodyId, paginationContainerId, isModal);
            };
            paginationContainer.appendChild(nextButton);
        }
    }

    document.getElementById('search').addEventListener('input', function () {
        const searchValue = this.value.trim();
        fetchData(0, searchValue, "Đang hoạt động", 'dang-hoat-dong-table', 'pagination-container', false);
    });

    // Gọi hàm fetchData ban đầu
    document.addEventListener('DOMContentLoaded', () => {
        fetchData(0, '', "Đang hoạt động", 'dang-hoat-dong-table', 'pagination-container', false);
    });

    //End table Đang hoạt động

    //Code modal chờ nhận sân

    function showCheckInList() {
        fetchData(0, '', "Chờ nhận sân", 'checkInListTable', 'modal-pagination-container', true);
        const checkInListModal = new bootstrap.Modal(document.getElementById('checkInListModal'));
        checkInListModal.show();
    }

    document.getElementById('checkInSearch').addEventListener('input', function () {
        const searchValue = this.value.trim();
        fetchData(0, searchValue, "Chờ nhận sân", 'checkInListTable', 'modal-pagination-container', true);
    });

    //Nút check-in trong modal
    async function checkIn(id) {
        try {
            // Hiển thị SweetAlert để xác nhận
            const result = await Swal.fire({
                title: 'Xác nhận',
                text: "Bạn có chắc chắn muốn check-in không?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có',
                cancelButtonText: 'Không'
            });

            // Nếu người dùng hủy bỏ, thoát khỏi hàm
            if (!result.isConfirmed) {
                return;
            }

            // Gửi yêu cầu API để cập nhật trạng thái
            const response = await fetch(`http://localhost:8080/hoa-don-chi-tiet/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({trangThai: 'Đang hoạt động'})
            });

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${await response.text()}`);
            }

            // Hiển thị thông báo thành công
            showSuccessToast('Check-in thành công.');

            // Tắt modal
            const checkInListModal = bootstrap.Modal.getInstance(document.getElementById('checkInListModal'));
            checkInListModal.hide();

            // Làm mới bảng dữ liệu "Đang hoạt động"
            fetchData(0, '', "Đang hoạt động", 'dang-hoat-dong-table', 'pagination-container', false);

        } catch (error) {
            console.error('Error during check-in:', error);
            showErrorToast('Có lỗi xảy ra khi check-in.');
        }
    }

    // Code phần dưới bên trái (DỊCH VỤ)
    //Hàm hiển thị dữ liệu trong modal
    function fetchAndRenderServices(apiUrl, containerId, itemFields) {
        $.ajax({
            url: apiUrl,
            type: 'GET',
            success: function (data) {
                if (!data || data.length === 0) {
                    $(`#${containerId}`).html('<p>Không có dịch vụ nào được tìm thấy.</p>');
                    return;
                }

                let content = '<div class="row" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">';

                data.forEach(item => {
                    const imageUrl = item[itemFields.imageField] || '';
                    const serviceName = item[itemFields.ten] || '';
                    const stock = item[itemFields.soLuong] || 0;
                    const price = item[itemFields.donGia] ? item[itemFields.donGia].toLocaleString() : '0';
                    content += `
                <div class="product-card" style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 250px; background-color: #ffffff; padding: 15px; text-align: center; position: relative;">
                    <div class="price-tag" style="position: absolute; top: 10px; right: 10px; background-color: #ff4d4d; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 14px;">
                        ${price} VND
                    </div>
                    <img src="${imageUrl}" class="card-img-top" alt="${serviceName}" style="width: 100%; height: 160px; object-fit: cover; border-radius: 5px; margin-bottom: 10px;">
                    <h5 class="card-title" style="margin: 10px 0; font-size: 18px; font-weight: bold; color: #333;">${serviceName}</h5>
                    <p class="card-text kho-con" style="margin: 5px 0; font-size: 14px; color: #666;" >Kho Còn: ${stock}</p>
                    <div class="input-group" style="margin: 10px 0;">
                        <input type="number" class="form-control quantity-input" value="0" min="0" style="width: 60px; display: inline-block;">
                    </div>
                    <div class="input-group-append" style="margin-top: 10px;">
                        <button class="btn btn-success add-btn" data-id="${item[itemFields.id]}"  data-price="${item[itemFields.donGia]}" data-name="${serviceName}" data-so-luong="${item[itemFields.soLuong]}" type="button" style="width: 100%; margin-bottom: 5px;">Thêm</button>
                    </div>
                </div>`;
                });

                content += '</div>';
                $(`#${containerId}`).html(content);
            },
            error: function (error) {
                console.error('Lỗi khi lấy dữ liệu dịch vụ:', error);
                $(`#${containerId}`).html('<p style="color: red;">Không thể tải dữ liệu. Vui lòng thử lại sau.</p>');
                Swal.fire('Lỗi!', 'Không thể tải dữ liệu.', 'error');
            }
        });
    }

    //Khi mở modal THêm dịch vụ
    $('#openServiceModal').on('click', function () {
        if (!selectedInvoiceId) {
            Swal.fire({
                icon: 'warning',
                title: 'Chưa chọn hóa đơn!',
                text: 'Vui lòng chọn một hóa đơn chi tiết trước khi thêm dịch vụ.',
            });
            return;
        }

        // Hiển thị danh sách "Đồ Thuê"
        fetchAndRenderServices(
            'http://localhost:8080/do_thue/searchTenDoThue?tenDoThue=',
            'doThueTab',
            {ten: 'tenDoThue', donGia: 'donGias', imageField: 'imageData', soLuong: 'soLuongs' , id : 'id'}
        );

        // Hiển thị danh sách "Nước Uống"
        fetchAndRenderServices(
            'http://localhost:8080/nuoc_uong/searchTenNuocUong?tenNuocUong=',
            'nuocUongTab',
            {ten: 'tenNuocUong', donGia: 'donGias', imageField: 'imageData', soLuong: 'soLuongs', id : 'id'}
        );

        $('#serviceModal').modal('show');
    });

    document.addEventListener('click', async (event) => {
        if (event.target.classList.contains('add-btn')) {
            const button = event.target;
            const id = parseInt(button.getAttribute('data-id'), 10); // ID dịch vụ
            const soLuongInput = button.closest('.product-card').querySelector('.quantity-input');
            const soLuong = parseInt(soLuongInput.value, 10); // Số lượng nhập từ input
            const soLuongTonKho = parseInt(button.getAttribute('data-so-luong'), 10); // Số lượng tồn kho ban đầu
            const idTabActive = document.querySelector('#serviceTabs .nav-link.active').id; // Tab hiện tại
            const trangThai = "Đã đặt";
            const idHoaDonChiTiet = selectedInvoiceId; // ID hóa đơn chi tiết đã chọn

            if (!idHoaDonChiTiet) {
                showErrorToast('Không thể thêm dịch vụ. ID hóa đơn chi tiết không hợp lệ!');
                return;
            }

            // URL kiểm tra tồn tại
            const checkUrl = idTabActive === 'tab1'
                ? `http://localhost:8080/dich-vu-san-bong/tim-dvsb-do-thue?idHDCT=${idHoaDonChiTiet}&idDoThue=${id}`
                : `http://localhost:8080/dich-vu-san-bong/tim-dvsb-nuoc-uong?idHDCT=${idHoaDonChiTiet}&idNuocUong=${id}`;

            // Gửi API kiểm tra
            fetch(checkUrl)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 400) {
                        return null;
                    }
                    throw new Error('Error checking service existence.');
                })
                .then(data => {
                    if (data) {
                        // Đã tồn tại: Cộng dồn số lượng và cập nhật
                        const soLuongMoi = data.soLuong + soLuong;
                        const tongTien = soLuongMoi * data.donGia;

                        const updatePayload = {
                            idDoThue: idTabActive === 'tab1' ? id : null,
                            idNuocUong: idTabActive === 'tab2' ? id : null,
                            idHoaDonChiTiet: idHoaDonChiTiet,
                            soLuong: soLuongMoi,
                            trangThai: trangThai,
                            tongTien: tongTien,
                            deletedAt: false,
                        };

                        const updateUrl = `http://localhost:8080/dich-vu-san-bong/${data.id}`;
                        return fetch(updateUrl, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updatePayload),
                        });
                    } else {
                        // Chưa tồn tại: Thêm mới dịch vụ
                        const donGia = parseFloat(button.getAttribute('data-don-gia')); // Giá đơn vị
                        const payload = {
                            idDoThue: idTabActive === 'tab1' ? id : null,
                            idNuocUong: idTabActive === 'tab2' ? id : null,
                            idHoaDonChiTiet,
                            soLuong,
                            trangThai,
                            tongTien: soLuong * donGia,
                            deletedAt: false,
                        };

                        return fetch('http://localhost:8080/dich-vu-san-bong', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload),
                        });
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Error processing service.');
                    console.log('Xử lý dịch vụ thành công!');
                    fillDichVuChoHoaDon(selectedInvoiceId);

                    // Tính toán số lượng tồn kho còn lại
                    const soLuongConLai = soLuongTonKho - soLuong;
                    const updateStockUrl = idTabActive === 'tab1'
                        ? `http://localhost:8080/do_thue/updateSoLuong/${id}`
                        : `http://localhost:8080/nuoc_uong/updateSoLuong/${id}`;
                    return fetch(updateStockUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ soLuongs: soLuongConLai }),
                    });
                })
                .then(response => {
                    if (!response.ok) throw new Error('Error updating stock.');
                    console.log('Cập nhật tồn kho thành công!');
                    showSuccessToast('Thêm dịch vụ và cập nhật tồn kho thành công!');

                    // Cập nhật UI
                    const khoConElement = button.closest('.product-card').querySelector('.kho-con');
                    if (khoConElement) {
                        khoConElement.textContent = `Kho Còn: ${soLuongTonKho - soLuong}`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorToast('Có lỗi xảy ra khi xử lý dịch vụ!');
                });
        }

        if (event.target.classList.contains('update-btn')) {
            const button = event.target;
            const idDichVu = button.getAttribute('data-id'); // ID dịch vụ
            const idHoaDonChiTiet = button.getAttribute('data-id-hdct'); // ID hóa đơn chi tiết
            const soLuongInput = button.closest('.product-card').querySelector('.quantity-input');
            const soLuongThem = parseInt(soLuongInput.value, 10); // Số lượng nhập thêm

            if (!soLuongThem || soLuongThem <= 0) {
                showErrorToast('Vui lòng nhập số lượng hợp lệ!');
                return;
            }

            try {
                // 1. Gọi API để lấy thông tin chi tiết dịch vụ
                const detailUrl = `http://localhost:8080/dich-vu-san-bong/${idDichVu}`;
                const detailResponse = await fetch(detailUrl);

                if (!detailResponse.ok) throw new Error('Không lấy được thông tin dịch vụ.');
                const detailData = await detailResponse.json();

                const idDoThue = detailData.idDoThue;
                const idNuocUong = detailData.idNuocUong;
                const soLuongTonKho = idDoThue ? detailData.soLuongsDoThue : detailData.soLuongsNuocUong;

                // 2. Xây dựng URL kiểm tra tồn tại
                const checkUrl = idDoThue
                    ? `http://localhost:8080/dich-vu-san-bong/tim-dvsb-do-thue?idHDCT=${idHoaDonChiTiet}&idDoThue=${idDoThue}`
                    : `http://localhost:8080/dich-vu-san-bong/tim-dvsb-nuoc-uong?idHDCT=${idHoaDonChiTiet}&idNuocUong=${idNuocUong}`;

                // 3. Gọi API kiểm tra tồn tại
                const checkResponse = await fetch(checkUrl);

                let checkData = null; // Định nghĩa checkData ở đây
                if (checkResponse.ok) {
                    // Dịch vụ đã tồn tại, thực hiện cập nhật số lượng
                    checkData = await checkResponse.json();

                    const updatePayload = {
                        idDoThue: idDoThue || null,
                        idNuocUong: idNuocUong || null,
                        idHoaDonChiTiet,
                        soLuong: soLuongThem,
                        trangThai: checkData.trangThai,
                    };

                    const updateUrl = `http://localhost:8080/dich-vu-san-bong/${idDichVu}`;
                    const updateResponse = await fetch(updateUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatePayload),
                    });

                    if (!updateResponse.ok) throw new Error('Cập nhật số lượng thất bại.');
                    showSuccessToast('Cập nhật số lượng thành công!');
                } else if (checkResponse.status === 400) {
                    // Dịch vụ chưa tồn tại, thực hiện thêm mới
                    const addPayload = {
                        idHoaDonChiTiet,
                        soLuong: soLuongThem,
                        idDoThue: idDoThue || null,
                        idNuocUong: idNuocUong || null,
                    };

                    const addResponse = await fetch('http://localhost:8080/dich-vu-san-bong', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(addPayload),
                    });

                    if (!addResponse.ok) throw new Error('Thêm dịch vụ thất bại.');
                    fillDichVuChoHoaDon(selectedInvoiceId);
                    showSuccessToast('Thêm dịch vụ thành công!');
                } else {
                    throw new Error('Lỗi kiểm tra dịch vụ.');
                }

                // 4. Cập nhật số lượng tồn kho
                const soLuongHienTai = checkData ? checkData.soLuong : 0; // Lấy số lượng hiện tại từ checkData
                const chenhLechSoLuong = soLuongThem - soLuongHienTai; // Tính chênh lệch số lượng

                if (chenhLechSoLuong !== 0) {
                    const soLuongConLai = soLuongTonKho - chenhLechSoLuong; // Điều chỉnh tồn kho dựa trên chênh lệch

                    const updateStockUrl = idDoThue
                        ? `http://localhost:8080/do_thue/updateSoLuong/${idDoThue}`
                        : `http://localhost:8080/nuoc_uong/updateSoLuong/${idNuocUong}`;

                    const updateStockPayload = {
                        soLuongs: soLuongConLai, // Số lượng tồn kho mới
                    };

                    const stockResponse = await fetch(updateStockUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updateStockPayload),
                    });

                    if (!stockResponse.ok) throw new Error('Cập nhật tồn kho thất bại.');

                    // Cập nhật hiển thị kho
                    const khoConElement = button.closest('.product-card').querySelector('.kho-con');
                    if (khoConElement) {
                        khoConElement.textContent = `Kho Còn: ${soLuongConLai}`;
                    }

                    console.log('Cập nhật tồn kho thành công!');
                    showSuccessToast('Cập nhật số lượng và tồn kho thành công!');
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorToast('Có lỗi xảy ra khi xử lý dịch vụ!');
            }
        }

        if (event.target.classList.contains('cancel-btn')) {
            const button = event.target;
            const idDichVu = button.getAttribute('data-id'); // ID dịch vụ
            const idHoaDonChiTiet = selectedInvoiceId;

            try {
                // 1. Gọi API để lấy thông tin chi tiết dịch vụ
                const detailUrl = `http://localhost:8080/dich-vu-san-bong/${idDichVu}`;
                const detailResponse = await fetch(detailUrl);

                if (!detailResponse.ok) throw new Error('Không lấy được thông tin dịch vụ.');
                const detailData = await detailResponse.json();

                const idDoThue = detailData.idDoThue;
                const idNuocUong = detailData.idNuocUong;
                const soLuongTonKho = idDoThue ? detailData.soLuongsDoThue : detailData.soLuongsNuocUong;

                // 2. Xây dựng URL kiểm tra tồn tại
                const checkUrl = idDoThue
                    ? `http://localhost:8080/dich-vu-san-bong/tim-dvsb-do-thue?idHDCT=${idHoaDonChiTiet}&idDoThue=${idDoThue}`
                    : `http://localhost:8080/dich-vu-san-bong/tim-dvsb-nuoc-uong?idHDCT=${idHoaDonChiTiet}&idNuocUong=${idNuocUong}`;

                // 3. Gọi API kiểm tra tồn tại
                const checkResponse = await fetch(checkUrl);

                let checkData = null; // Định nghĩa checkData ở đây
                if (checkResponse.ok) {
                    // Dịch vụ đã tồn tại, thực hiện cập nhật số lượng về 0
                    checkData = await checkResponse.json();

                    const updatePayload = {
                        idDoThue: idDoThue || null,
                        idNuocUong: idNuocUong || null,
                        idHoaDonChiTiet,
                        soLuong: 0, // Số lượng hủy bỏ
                        trangThai: checkData.trangThai,
                        deletedAt: true,
                    };

                    const updateUrl = `http://localhost:8080/dich-vu-san-bong/${idDichVu}`;
                    const updateResponse = await fetch(updateUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatePayload),
                    });

                    if (!updateResponse.ok) throw new Error('Cập nhật số lượng thất bại.');
                    fillDichVuChoHoaDon(selectedInvoiceId);
                    showSuccessToast('Số lượng đã được hủy thành công!');
                } else if (checkResponse.status === 400) {
                    // Dịch vụ chưa tồn tại trong giỏ hàng
                    showErrorToast('Dịch vụ chưa được thêm vào giỏ hàng.');
                } else {
                    throw new Error('Lỗi kiểm tra dịch vụ.');
                }

                // 4. Cập nhật số lượng tồn kho (số lượng được hủy bỏ sẽ không làm thay đổi tồn kho)
                const soLuongHienTai = checkData ? checkData.soLuong : 0; // Lấy số lượng hiện tại từ checkData
                const soLuongConLai = soLuongTonKho + soLuongHienTai;

                const updateStockUrl = idDoThue
                    ? `http://localhost:8080/do_thue/updateSoLuong/${idDoThue}`
                    : `http://localhost:8080/nuoc_uong/updateSoLuong/${idNuocUong}`;

                const updateStockPayload = {
                    soLuongs: soLuongConLai, // Cập nhật lại số lượng tồn kho
                };

                const stockResponse = await fetch(updateStockUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateStockPayload),
                });

                if (!stockResponse.ok) throw new Error('Cập nhật tồn kho thất bại.');

                // Cập nhật hiển thị kho
                const khoConElement = button.closest('.product-card').querySelector('.kho-con');
                if (khoConElement) {
                    khoConElement.textContent = `Kho Còn: ${soLuongConLai}`;
                }

                console.log('Cập nhật tồn kho thành công!');
                showSuccessToast('Cập nhật số lượng và tồn kho thành công!');
            } catch (error) {
                console.error('Error:', error);
                showErrorToast('Có lỗi xảy ra khi hủy dịch vụ!');
            }
        }
    });

    function fillDichVuChoHoaDon(idHDCT) {
        $.ajax({
            url: `http://localhost:8080/dich-vu-san-bong/tim-theo-idhdct/${idHDCT}`,
            type: 'GET',
            success: function (data) {
                if (!data || data.length === 0) {
                    $('#dichVuThueList').html('<p>Chưa có dịch vụ nào được thêm vào hóa đơn.</p>');
                    return;
                }

                let content = '<div class="row" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">';
                data.forEach(item => {
                    const imageUrl = item.idDoThue ? item.imageDataDoThue : item.imageDataNuocUong || '';
                    const serviceName = item.idDoThue ? item.tenDoThue : item.tenNuocUong || '';
                    const price = item.idDoThue ? item.donGiasDoThue : item.donGiasNuocUong;
                    const formattedPrice = price ? price.toLocaleString() : '0';
                    const idDoThue = item.idDoThue || null;
                    const idNuocUong = item.idNuocUong || null;

                    content += `
                <div class="product-card" style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 250px; background-color: #ffffff; padding: 15px; text-align: center; position: relative;">
                    <div class="price-tag" style="position: absolute; top: 10px; right: 10px; background-color: #ff4d4d; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 14px;">
                        ${formattedPrice} VND
                    </div>
                    <img src="${imageUrl}" class="card-img-top" alt="${serviceName}" style="width: 100%; height: 160px; object-fit: cover; border-radius: 5px; margin-bottom: 10px;">
                    <h5 class="card-title" style="margin: 10px 0; font-size: 18px; font-weight: bold; color: #333;">${serviceName}</h5>
                    <div class="input-group">
                        <input type="number" class="form-control quantity-input" value="${item.soLuong}" min="0" data-id="${item.id}" data-id-hdct="${idHDCT}" data-id-do-thue="${idDoThue}" data-id-nuoc-uong="${idNuocUong}" style="width: 100px; margin: auto;">
                    </div>
                    <div class="d-flex justify-content-between" style="margin-top: 10px;">
                        <button class="btn btn-danger cancel-btn" data-id="${item.id}" type="button" style="width: 48%;">Hủy</button>
                        <button class="btn btn-success update-btn" data-id="${item.id}" data-id-hdct="${idHDCT}" type="button" style="width: 48%;">Cập nhật</button>
                    </div>
                </div>`;
                });

                content += '</div>';
                $('#dichVuThueList').html(content);
            },
            error: function (error) {
                console.error('Lỗi khi lấy dữ liệu dịch vụ:', error);
                showErrorToast('Không thể lấy danh sách dịch vụ.');
            }
        });
    }

</script>
</body>
</html>

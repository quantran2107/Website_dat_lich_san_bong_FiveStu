<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="~{fragment/head :: head}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
    /* Hover màu xanh cho tất cả các dòng */
    .active-row {
        background-color: #14e34a; /* Màu nền khi được chọn */
    }

    .form-group label {
        font-weight: bold;
    }

    .form-group input {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
    }

    .row {
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    h5.text-primary {
        color: #007bff;
        margin-top: 20px;
    }

    .col-lg-3-dich-vu {
        flex: 0 0 auto;
        width: 30%;
    }

    h5.card-title {
        color: #28a745;
    }

    .text-center {
        text-align: center;
    }

    .hidden-field {
        display: none;
    }

    .form-group label {
        font-weight: bold;
    }

    .form-group input {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
    }

    .row {
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    /*#dichVuDaThueContainer {*/
    /*    padding: 20px; !* Padding cho container *!*/
    /*    max-height: 400px; !* Chiều cao tối đa cho container *!*/
    /*    overflow-y: auto; !* Thêm thanh cuộn dọc khi vượt quá chiều cao *!*/
    /*    border: 1px solid #dee2e6; !* Viền cho container *!*/
    /*    border-radius: 10px; !* Bo tròn góc *!*/
    /*    width: 250px; !* Chiều rộng cho container *!*/
    /*    height: 300px; !* Chiều cao cho container *!*/
    /*}*/

    #colTest {
        display: flex;
        flex-direction: column;
    }

    .card-body {
        flex: 1;
    }

    .d-flex {
        flex-wrap: wrap;
    }

    #dichVuDaThueContainer {
        flex: 0 0 250px; /* Set width to 250px */
    }


    #dichVuThueList {
        overflow-y: auto;
        padding: 10px;
    }


    /*#colTest {*/
    /*    display: flex;*/
    /*    flex-direction: column;*/
    /*    height: 250px; !* Set height to 330px *!*/
    /*}*/

    /*.card-body {*/
    /*    flex: 1;*/
    /*}*/

    /*.d-flex {*/
    /*    flex-wrap: wrap;*/
    /*}*/

    /*#dichVuDaThueContainer {*/
    /*    flex: 0 0 250px; !* Set width to 250px *!*/
    /*}*/

    /*#dichVuThueList {*/
    /*    overflow-y: auto; !* Enable vertical scrolling if content overflows *!*/
    /*    padding: 10px;*/
    /*    height: calc(250px  !* Height of other elements if any *!);*/
    /*}*/

    #filter {
        padding: 8px;
        margin-right: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 14px;
        color: #333;
    }

</style>
<body class="vertical light">
<div class="wrapper">
    <div th:include="~{fragment/navbar :: navbar}"></div>
    <div th:include="~{fragment/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <main class="main-content" role="main">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <h2 class="page-title">Đặt lịch</h2>
                </div>
            </div>

            <div class="row mt-4" id="content-dat-lich">
                <!--Phần NỘI DUNG trái-->
                <div class="col-md-7">
                    <!--Phần trên bên trái-->
                    <div class="row">
                        <!-- Phần Danh Sách Hóa Đơn -->
                        <div class="col-12 mb-3">
                            <div class="card shadow h-100">
                                <div class="card-body">
                                    <h5 class="card-title text-success">Danh sách hóa đơn</h5>
                                    <!-- Tìm kiếm -->
                                    <div class="toolbar row mb-3 mt-3">
                                        <div class="col-md-12">
                                            <form class="form-inline" id="filterForm"
                                                  style="display: flex; align-items: center;">
                                                <label class="me-2" for="search">Tìm kiếm</label>
                                                <input class="form-control me-2" id="search"
                                                       placeholder="Tìm kiếm theo mã hóa đơn, số điện thoại, tên, email khách hàng,..."
                                                       style="width: 400px;" type="text">
                                                <button class="btn btn-primary me-2" onclick="resetFilters('search')"
                                                        type="button">
                                                    <span class="fe fe-refresh-ccw"></span>
                                                </button>
                                                <button class="btn btn-warning " onclick="showCheckInList()"
                                                        title="Danh sách sân check-in" type="button">
                                                    <span class="fe fe-grid"></span>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    <!-- Hiển thị bảng -->
                                    <table class="table mt-2">
                                        <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Mã</th>
                                            <th>Tên KH</th>
                                            <th>SDT</th>
                                            <th>Email</th>
                                            <th>Sân ca</th>
                                            <th>Thời gian</th>
                                            <th>Ngày đặt lịch</th>
                                            <th>Hành động</th>
                                        </tr>
                                        </thead>
                                        <tbody id="dang-hoat-dong-table">
                                        <!-- Dữ liệu bảng -->
                                        </tbody>
                                    </table>
                                    <div class="pagination-container mt-3 d-flex justify-content-end align-items-center"
                                         id="pagination-container">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--End-->

                    <!--Phần dưới bên trái-->

                    <div class="row" id="colTest">
                        <div class="col-12">
                            <div class="card shadow">
                                <div class="card-body">
                                    <!-- Tiêu đề của box -->
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5>Dịch Vụ Đã Thuê</h5>
                                        <button class="btn btn-outline-success" title="Thêm dịch vụ" type="button"
                                                id="openServiceModal">
                                            <span class="fe fe-plus"></span>
                                        </button>
                                    </div>
                                    <div id="dichVuDaThueContainer" class="mt-4">
                                        <div id="dichVuThueList" class="row"
                                             style="max-height: 600px; overflow-y: auto;">
                                            <div class="col-12">
                                                <!-- Nội dung dịch vụ đã thuê sẽ ở đây -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--End-->
                </div>

                <!--Modal dịch vụ-->
                <div class="modal fade" id="serviceModal" tabindex="-1" role="dialog"
                     aria-labelledby="serviceModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl" role="document">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title" id="serviceModalLabel">Thêm Dịch Vụ</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <ul class="nav nav-tabs flex" id="serviceTabs" role="tablist">
                                    <li class="nav-item flex-grow-1">
                                        <a class="nav-link active" id="tab1" data-toggle="tab" href="#doThueTab"
                                           role="tab">Đồ Thuê</a>

                                    </li>
                                    <li class="nav-item flex-grow-1">
                                        <a class="nav-link" id="tab2" data-toggle="tab" href="#nuocUongTab" role="tab">Nước
                                            Uống</a>
                                    </li>
                                </ul>
                                <input type="text" class="form-control search-input" placeholder="Tìm kiếm">
                                <div id="selectedServices"></div> <!-- Div để hiển thị dịch vụ đã chọn -->

                                <div class="tab-content" id="serviceTabContent"
                                     style="max-height: 600px; overflow-y: auto;">
                                    <div class="tab-pane fade show active row" id="doThueTab" role="tabpanel">
                                        <div class="search-results"></div>
                                    </div>
                                    <div class="tab-pane fade row" id="nuocUongTab" role="tabpanel">
                                        <div class="search-results"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phần Tabs và Nội dung Tabs bên phải -->
                <div class="col-md-5">
                    <div class="card shadow h-100">
                        <div class="card-body">
                            <!-- Tiêu đề của box -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Tiêu đề của box -->
                                <h4 class="card-title text-success mb-3">Thông tin hóa đơn</h4>
                                <!-- Khung chứa các nút nằm bên phải -->
                                <div class="d-flex">
                                    <!-- Nút Thêm hóa đơn -->
                                    <button id="addInvoiceButton" class="btn btn-outline-primary me-2"
                                            title="Thêm hóa đơn"
                                            type="button">
                                        <span class="fe fe-plus"></span>
                                    </button>
                                </div>
                            </div>
                            <!-- Phần Tabs nằm ngang -->
                            <ul class="nav nav-tabs" id="tabListRight">
                                <!-- Tabs sẽ được tạo động tại đây -->
                            </ul>
                            <!-- Phần Nội dung Tabs nằm bên dưới -->
                            <div class="tab-content" id="tabContentRight">
                                <!-- Nội dung các tab sẽ được tạo động tại đây -->
                                <form>
                                    <div class="row">
                                        <div class="col-md-6" hidden >
                                            <div class="form-group mb-3" >
                                                <label for="id">ID</label>
                                                <input type="text" id="id" class="form-control" readonly >
                                            </div>
                                            <div class="form-group mb-3" hidden>
                                                <label for="idHoaDon">ID Hóa đơn</label>
                                                <input type="text" id="idHoaDon" class="form-control" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6" hidden>
                                            <div class="form-group mb-3">
                                                <label for="maHoaDon">Mã hóa đơn</label>
                                                <input type="text" id="maHoaDon" class="form-control" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6" hidden>
                                            <div class="form-group mb-3">
                                                <label for="maHoaDonChiTiet">Mã hóa đơn chi tiết</label>
                                                <input type="text" id="maHoaDonChiTiet" class="form-control" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Tên Khách Hàng -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="hoVaTenKhachHang">Tên khách hàng</label>
                                                <input type="text" id="hoVaTenKhachHang" class="form-control" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="soDienThoaiKhachHang">Số Điện Thoại</label>
                                                <input class="form-control" id="soDienThoaiKhachHang" type="text" readonly placeholder="Chưa có dữ liệu">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6" hidden>
                                            <div class="form-group mb-3">
                                                <label for="trangThai">Trạng thái</label>
                                                <input class="form-control" id="trangThai" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="form-group mb-3">
                                                <label for="tenSanBong">Tên sân</label>
                                                <input class="form-control" id="tenSanBong" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="thoiGianBatDauCa">Thời gian bắt đầu</label>
                                                <input class="form-control" id="thoiGianBatDauCa" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="thoiGianKetThucCa">Thời gian kết thúc</label>
                                                <input class="form-control" id="thoiGianKetThucCa" type="text" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="ngayTaoHoaDon">Ngày tạo hóa đơn</label>
                                                <input class="form-control" id="ngayTaoHoaDon" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="ngayDenSan">Ngày check-in</label>
                                                <input class="form-control" id="ngayDenSan" type="text" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="tienSan">Giá sân</label>
                                                <input class="form-control" id="tienSan" type="text" readonly >
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="tienCoc">Tiền cọc Sân</label>
                                                <input class="form-control" id="tienCoc" type="text" readonly >
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="giaDichVu">Giá dịch Vụ</label>
                                                <input class="form-control" id="giaDichVu" type="text" readonly >
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="tienPhuPhi">Tiền phụ Phí</label>
                                                <input class="form-control" id="tienPhuPhi" type="text" readonly >
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group mb-3">
                                                <label for="phuPhiSelect">Phụ phí hóa đơn</label>
                                                <div class="input-group mb-3">
                                                    <!-- Dropdown danh sách phụ phí -->
                                                    <select id="phuPhiSelect" class="form-control">
                                                        <option value="">Chưa có phụ phí hóa đơn !!!</option>
                                                    </select>
                                                    <button class="btn btn-outline-success" type="button" id="btnAddPhuPhi" data-invoice-id="${invoiceId}">+</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group mb-3">
                                                <label for="tongTien">Tổng tiền</label>
                                                <input class="form-control" id="tongTien" type="text" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <h4 class="text-success">Thanh Toán</h4>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label for="phieuGiamGia">Phiếu Giảm Giá</label>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="form-group mb-3">
                                                <div class="input-group mb-3">
                                                    <input class="form-control" id="phieuGiamGia" type="text" placeholder="Phiếu Giảm Giá" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label for="tienGiam">Số tiền giảm</label>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="form-group mb-3">
                                                <div class="input-group mb-3">
                                                    <input class="form-control" id="tienGiam" type="text" placeholder="Số tiền giảm" readonly>
                                                    <span class="input-group-text">VND</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label for="tongTienPhaiTra">Tổng tiền phải trả:</label>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="form-group mb-3">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="tongTienPhaiTra" readonly>
                                                    <span class="input-group-text">VND</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label for="tienKhachDua">Tiền khách đưa</label>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="form-group mb-3">
                                                <div class="input-group mb-3" >
                                                    <!--     nút mở modal-->
                                                    <div class="form-group mb-3" style="display: flex;align-items: center">
                                                        <button type="button" class="btn-outline-warning"
                                                                style="display: flex; align-items: center; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;"
                                                                data-toggle="modal" data-target="#exampleModal" title="Tiền khách đưa">
                                                            <i class="fas fa-credit-card" style="margin-right: 5px;"></i>
                                                        </button>

                                                        <input type="text" style="margin-left: 82px" class="form-control" id="tienKhachDua" readonly >
                                                        <span class="input-group-text">VND</span>
                                                    </div>
                                                </div>
                                                <!-- ket thuc nut modal-->
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label for="tienTraLai">Tiền trả lại</label>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="form-group mb-3">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="tienTraLai" readonly>
                                                    <span class="input-group-text">VND</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--         Modal-->
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-12 text-center">
                                            <button class="btn btn-success" type="button" onclick="thanhToan(${invoiceId})">Thanh toán</button>
                                        </div>
                                    </div>

                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!--    Modal table check-in-->
    <div class="modal fade" id="checkInListModal" tabindex="-1"
         aria-labelledby="checkInListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="checkInListModalLabel">Danh Sách Sân Chờ Nhận</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>                </div>
                <div class="modal-body">
                    <!-- Input tìm kiếm -->
                    <div class="mb-3 d-flex">
                        <input type="text" id="checkInSearch" class="form-control me-2"
                               placeholder="Tìm kiếm theo mã hóa đơn, số điện thoại, tên, email khách hàng,..."
                               style="width: 400px;">
                        <button class="btn btn-primary me-2" onclick="resetFilters('checkInSearch')"
                                type="button">
                            <span class="fe fe-refresh-ccw"></span>
                        </button>
                    </div>
                    <table class="table ">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Mã</th>
                            <th>Tên KH</th>
                            <th>SDT</th>
                            <th>Email</th>
                            <th>Sân ca</th>
                            <th>Thời gian</th>
                            <th>Ngày đặt lịch</th>
                            <th>Hành động</th>
                        </tr>
                        </thead>
                        <tbody id="checkInListTable">
                        <!-- Nội dung sẽ được điền ở đây -->
                        </tbody>
                    </table>
                    <div id="modal-pagination-container"
                         class="d-flex justify-content-end align-items-center mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!--    End Modal-->

    <!-- Modal để thêm phụ phí -->
    <div id="phuPhiModal" class="modal fade" tabindex="-1"
         aria-labelledby="phuPhiModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="phuPhiModalLabel">Thêm Phụ Phí</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="phuPhiForm">
                        <div class="form-group mb-3">
                            <label for="tenPhuPhi">Tên Phụ Phí</label>
                            <input type="text" id="tenPhuPhi" class="form-control"
                                   placeholder="Tên Phụ Phí" >
                            <div id="errorTenPhuPhi" class="text-danger" style="display: none;">Vui lòng nhập tên phụ phí.</div> <!-- Thông báo lỗi -->

                        </div>
                        <div class="form-group mb-3">
                            <label for="giaPhuPhi">Giá Phụ Phí</label>
                            <div class="input-group">
                                <input type="number" id="giaPhuPhi" class="form-control"
                                       placeholder="0" >
                                <span class="input-group-text">VND</span>
                            </div>
                            <div id="errorGiaPhuPhi" class="text-danger" style="display: none;">Vui lòng nhập giá phụ phí.</div> <!-- Thông báo lỗi -->
                        </div>
                        <button type="button" class="btn btn-success" id="btnThemPhuPhi">
                            Thêm Phụ Phí
                        </button>
                    </form>
                    <table class="table mt-3">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Tên Phụ Phí</th>
                            <th>Giá Phụ Phí</th>
                            <th>Chọn</th>
                        </tr>
                        </thead>
                        <tbody id="phuPhiList">
                        <tr>
                            <!--                                Hiển thị phụ phí hóa đơn-->
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!--    End Modal-->

<!--    Modal để thực hiện hình thức thanh toán-->
    <div class="modal fade" id="exampleModal" tabindex="-1"
         aria-labelledby="exampleModalLabel" aria-hidden="true" >
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header"style="background-color: #198754; color: white">
                    <h3 class="modal-title" id="exampleModalLabel"
                        style="text-align: center ;flex: 1">Thanh toán</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!--Nội dung của Modal-->
                    <div style="align-items: center;justify-content: center;">
                        <div style="display: flex;margin-bottom: 10px">
                            <label style="flex:1"><h5>Tổng tiền hàng</h5></label>
                            <h5 id="tongTienHang"  style="float: right"></h5>
                            <h5>VND</h5>
                        </div>
                        <div style="display: flex;justify-content: center; margin-bottom: 10px">
                            <button type="button" id="btnChuyenKhoan" class="btn btn-outline-success" style="margin-right: 5px;" data-id-hinh-thuc-thanh-toan="1" >
                                Chuyển khoản <i class="fas fa-university" style="margin-left: 5px"></i>
                            </button>
                            <!-- Nút Tiền mặt -->
                            <button type="button" id="btnTienMat" class="btn btn-outline-success" data-id-hinh-thuc-thanh-toan="2" >
                                Tiền mặt <i class="fas fa-money-bill-wave" style="margin-left: 5px"></i>
                            </button>
                        </div>
                        <div style="margin-bottom: 10px">
                            <label for="khachDua" style="font-weight: bold;">Tiền
                                khách đưa:</label>
                            <div style="display: flex">
                                <input type="number"
                                       id="khachDua"
                                       class="form-control"
                                       placeholder="Nhập tiền khách đưa"
                                       style="border: none; border-bottom: 2px solid #007bff; outline: none; box-shadow: none;  ">
                                <input type="text"
                                       id="maGD"
                                       class="form-control"
                                       placeholder="Mã giao dịch"
                                       style="border: none; border-bottom: 2px solid #007bff; outline: none; box-shadow: none; display: none">
                            </div>
                        </div>
                        <div style="margin-bottom: 60px; margin-top: 60px" >
                            <table class="table table-hover">
                                <thead >

                                <th>STT</th>
                                <th>Mã giao dịch</th>
                                <th>Phương thức</th>
                                <th>Số tiền</th>
                                <th>Hành động</th>

                                </thead>
                                <tbody id="tbodyCTHTTT">
                                <tr>
                                    <td style=" text-align: center" colspan="5">Chưa có thông tin</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div style="display: flex" >
                            <label style="flex:1" ><h5>Tiền còn thiếu</h5></label>
                            <h5 id="tienConThieu" style="float: right" ></h5>
                            <h5>VND</h5>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success" id="btnXacNhanThanhToan">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>
<!--    End-->
    <div th:include="~{fragment/modal :: modal}"></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script th:include="~{fragment/script :: script}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    //Hàm thông báo
    function showSuccessToast(message) {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            style: {
                background: "#4CAF50",
            },
            stopOnFocus: true
        }).showToast();
    }

    function showErrorToast(message) {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "center",
            style: {
                background: "#f44336",
            },
            stopOnFocus: true
        }).showToast();
    }

    //Nút reset
    function resetFilters(inputId) {
        const inputElement = document.getElementById(inputId);
        if (inputElement) {
            inputElement.value = ''; // Xóa nội dung trong ô input
        }

        // Kiểm tra xem đang reset ở bảng "Đang hoạt động" hay modal "Chờ nhận sân"
        if (inputId === 'search') {
            fetchData(0, '', "Đang hoạt động", 'dang-hoat-dong-table', 'pagination-container', false);
        } else if (inputId === 'checkInSearch') {
            fetchData(0, '', "Chờ nhận sân", 'checkInListTable', 'modal-pagination-container', true);
        }
    }

    let selectedInvoiceId = null; // Biến lưu trữ ID hóa đơn chi tiết được chọn

    // Lắng nghe sự kiện click trên bảng "Đang Hoạt Động"
    document.getElementById('dang-hoat-dong-table').addEventListener('click', function (event) {
        const clickedRow = event.target.closest('tr'); // Lấy dòng được click
        if (clickedRow) {
            // Xóa lớp `table-active` khỏi tất cả các dòng
            const rows = document.querySelectorAll('#dang-hoat-dong-table tr');
            rows.forEach(row => row.classList.remove('table-active'));

            // Thêm lớp `table-active` vào dòng được click
            clickedRow.classList.add('table-active');

            // Lưu lại ID hóa đơn chi tiết
            selectedInvoiceId = clickedRow.getAttribute('data-id'); // Lấy ID từ data-id
            // Hiển thị dịch vụ liên quan đến hóa đơn được chọn
            fillDichVuChoHoaDon(selectedInvoiceId);
            // Gọi hàm để hiển thị thông tin hóa đơn bên phải
            loadInvoiceDetails(selectedInvoiceId);
        }
    });
    //End

    //Code table bên trái

    let currentPage = 0;
    let totalPages = 0;

    // Hàm fetch data từ server và hiển thị ra bảng
    async function fetchData(page = 0, keyWord = '', trangThai = "Đang hoạt động", tableBodyId = 'dang-hoat-dong-table', paginationContainerId = 'pagination-container', isModal = false) {
        try {
            const pageSize = 5;
            const url = `http://localhost:8080/hoa-don-chi-tiet/trang-thai?trangThai=${encodeURIComponent(trangThai)}&page=${page}&size=${pageSize}&keyWord=${encodeURIComponent(keyWord)}`;

            const response = await fetch(url);

            const data = await response.json();

            currentPage = data.number;
            totalPages = data.totalPages;

            const tableBody = document.getElementById(tableBodyId);
            if (!tableBody) return;

            tableBody.innerHTML = ''; // Xóa nội dung cũ của bảng

            // Hiển thị dữ liệu trong bảng
            if (Array.isArray(data.content) && data.content.length > 0) {
                data.content.forEach((item, index) => {
                    const thoiGianBatDau = new Date(item.thoiGianBatDauCa).toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const thoiGianKetThuc = new Date(item.thoiGianKetThucCa).toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', item.id);
                    row.innerHTML = `
                    <td>${index + 1 + (page * pageSize)}</td>
                    <td>${item.maHoaDonChiTiet || ''}</td>
                    <td>${item.hoVaTenKhachHang || ''}</td>
                    <td>${item.soDienThoaiKhachHang || ''}</td>
                    <td>${item.emailKhachHang || ''}</td>
                    <td>${item.tenSanBong || ''}</td>
                    <td>${thoiGianBatDau} - ${thoiGianKetThuc}</td>
                    <td>${item.ngayDenSan || ''}</td>
                    ${trangThai === "Chờ nhận sân" && isModal ? `<td>
                        <button class="btn btn-outline-success check-in-btn" title="Check in"  onclick="checkIn('${item.id}')">
                            <span class="fe fe-check-circle"></span>
                        </button>
                    </td>` : ''}
                `;
                    tableBody.appendChild(row);
                });
            } else {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="9" class="text-center"></td>`;
                tableBody.appendChild(emptyRow);
            }

            // Cập nhật phân trang
            if (paginationContainerId) {
                updatePagination(currentPage, totalPages, keyWord, trangThai, tableBodyId, paginationContainerId, isModal);
            }

            // Ẩn cột "Hành động" nếu không phải trạng thái "Chờ nhận sân"
            if (!isModal) {
                const actionColumn = document.querySelector(`table thead th:nth-child(9)`);
                if (actionColumn) {
                    actionColumn.style.display = trangThai === "Chờ nhận sân" ? '' : 'none';
                }
            }

        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    // Hàm cập nhật phân trang
    function updatePagination(currentPage, totalPages, keyWord, trangThai, tableBodyId, paginationContainerId, isModal) {
        const paginationContainer = document.getElementById(paginationContainerId);
        if (!paginationContainer) return;

        paginationContainer.innerHTML = ''; // Xóa nội dung cũ

        // Nút Previous
        if (currentPage > 0) {
            const prevButton = document.createElement('button');
            prevButton.className = 'btn btn-success me-2';
            prevButton.textContent = '<';
            prevButton.onclick = () => {
                fetchData(currentPage - 1, keyWord, trangThai, tableBodyId, paginationContainerId, isModal);
            };
            paginationContainer.appendChild(prevButton);
        }

        // Hiển thị số trang hiện tại
        const pageDisplay = document.createElement('span');
        pageDisplay.className = 'btn btn-outline-secondary';
        pageDisplay.textContent = `Trang ${currentPage + 1}`;
        paginationContainer.appendChild(pageDisplay);

        // Nút Next
        if (currentPage < totalPages - 1) {
            const nextButton = document.createElement('button');
            nextButton.className = 'btn btn-success ms-2';
            nextButton.textContent = '>';
            nextButton.onclick = () => {
                fetchData(currentPage + 1, keyWord, trangThai, tableBodyId, paginationContainerId, isModal);
            };
            paginationContainer.appendChild(nextButton);
        }
    }

    document.getElementById('search').addEventListener('input', function () {
        const searchValue = this.value.trim();
        fetchData(0, searchValue, "Đang hoạt động", 'dang-hoat-dong-table', 'pagination-container', false);
    });

    // Gọi hàm fetchData ban đầu
    document.addEventListener('DOMContentLoaded', () => {
        fetchData(0, '', "Đang hoạt động", 'dang-hoat-dong-table', 'pagination-container', false);
    });

    //End table Đang hoạt động

    //Code modal chờ nhận sân

    function showCheckInList() {
        fetchData(0, '', "Chờ nhận sân", 'checkInListTable', 'modal-pagination-container', true);
        const checkInListModal = new bootstrap.Modal(document.getElementById('checkInListModal'));
        checkInListModal.show();
    }

    document.getElementById('checkInSearch').addEventListener('input', function () {
        const searchValue = this.value.trim();
        fetchData(0, searchValue, "Chờ nhận sân", 'checkInListTable', 'modal-pagination-container', true);
    });

    //Nút check-in trong modal
    async function checkIn(id) {
        try {
            // Hiển thị SweetAlert để xác nhận
            const result = await Swal.fire({
                title: 'Xác nhận',
                text: "Bạn có chắc chắn muốn check-in không?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có',
                cancelButtonText: 'Không'
            });

            // Nếu người dùng hủy bỏ, thoát khỏi hàm
            if (!result.isConfirmed) {
                return;
            }

            // Gửi yêu cầu API để cập nhật trạng thái
            const response = await fetch(`http://localhost:8080/hoa-don-chi-tiet/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({trangThai: 'Đang hoạt động'})
            });

            // Hiển thị thông báo thành công
            showSuccessToast('Check-in thành công.');

            // Tắt modal
            const checkInListModal = bootstrap.Modal.getInstance(document.getElementById('checkInListModal'));
            checkInListModal.hide();

            // Làm mới bảng dữ liệu "Đang hoạt động"
            fetchData(0, '', "Đang hoạt động", 'dang-hoat-dong-table', 'pagination-container', false);

        } catch (error) {
            console.error('Error during check-in:', error);
            showErrorToast('Có lỗi xảy ra khi check-in.');
        }
    }

    // Hàm gọi API để lấy tỷ lệ tiền cọc
    async function fetchDepositRate() {
        const response = await fetch('http://localhost:8080/tham-so/searchMaFake/TSTIEN_COC');
        const data = await response.json();
        return {
            value: data.giaTri,  // Giá trị tỷ lệ tiền cọc
            type: data.typeGiaTri // Loại tỷ lệ (% hoặc giá trị cố định)
        };
    }

    // Hàm tính toán tiền cọc
    async function calculateDeposit(giaSan) {
        const depositRate = await fetchDepositRate();  // Lấy tỷ lệ tiền cọc

        let deposit = 0;
        if (depositRate.type === '%') {
            deposit = (giaSan * depositRate.value) / 100; // Tính theo phần trăm
        } else {
            deposit = depositRate.value; // Giá trị cố định
        }

        return deposit;
    }

    //Code phần phụ phí

    // Hàm gọi API để lấy tiền phụ phí từ API và hiển thị lên ô input
    async function fetchTienPhuPhi(invoiceId) {
        try {
            const response = await fetch(`http://localhost:8080/api/phu-phi-hoa-don/${invoiceId}`);
            if (!response.ok) {
                throw new Error('Không thể lấy dữ liệu phụ phí.');
            }

            const data = await response.json();

            // Kiểm tra nếu có phụ phí trong mảng và lấy tổng tiền phụ phí
            if (Array.isArray(data) && data.length > 0) {
                return data.reduce((total, phuPhi) => total + phuPhi.tienPhuPhi, 0); // Tính tổng tiền phụ phí
            } else {
                return 0; // Nếu không có phụ phí, trả về 0
            }

        } catch (error) {
            return 0; // Nếu có lỗi, trả về 0
        }
    }

    // Hàm tải các phụ phí có sẵn và hiển thị trong modal
    async function loadAvailablePhuPhi(invoiceId) {
        try {
            const response = await fetch(`http://localhost:8080/api/phu-phi-hoa-don/${invoiceId}`);
            if (!response.ok) {
                throw new Error('Không thể tải danh sách phụ phí.');
            }
            const data = await response.json();

            // Xử lý dropdown "Phụ phí hóa đơn"
            const phuPhiSelect = document.getElementById('phuPhiSelect');
            phuPhiSelect.innerHTML = ''; // Xóa các option cũ trong dropdown

            if (data.length > 0) {
                // Thêm các phụ phí vào dropdown
                data.forEach(phuPhi => {
                    const option = document.createElement('option');
                    option.value = phuPhi.id;
                    option.textContent = `${phuPhi.ten} - ${phuPhi.tienPhuPhi.toLocaleString()} VND`;
                    phuPhiSelect.appendChild(option);
                });
            } else {
                // Nếu không có phụ phí, hiển thị thông báo
                phuPhiSelect.innerHTML = '<option value="">Không có phụ phí nào</option>';
            }

            // Hiển thị các phụ phí trong bảng trong modal
            const phuPhiList = document.getElementById('phuPhiList');
            phuPhiList.innerHTML = ''; // Xóa các hàng cũ trong bảng

            if (data.length > 0) {
                data.forEach((phuPhi, index) => {
                    // Tạo một hàng mới cho bảng phụ phí
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${phuPhi.ten}</td>
                    <td>${phuPhi.tienPhuPhi.toLocaleString()} VND</td>
                    <td>
                    <button class="btn mb-2 mr-1 btn-outline-danger" type="button" data-phuPhi-id="${phuPhi.id}" title="Xóa phụ phí">
                        <span class="fe fe-trash-2"></span>
                    </button>
                    </td>
                `;
                    phuPhiList.appendChild(row);
                    // Gắn sự kiện click cho mỗi nút "Xóa phụ phí" sau khi phần tử được thêm vào DOM
                    const deleteButton = row.querySelector('.btn-outline-danger');
                    deleteButton.addEventListener('click', function() {
                        const phuPhiId = this.getAttribute('data-phuPhi-id');
                        handleDeletePhuPhi(phuPhiId, selectedInvoiceId); // Xử lý xóa phụ phí
                    });
                });
            } else {
                // Nếu không có phụ phí, hiển thị dòng thông báo trong bảng
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" class="text-center">Không có phụ phí nào để chọn</td>`;
                phuPhiList.appendChild(row);

            }
        } catch (error) {
            // console.error(error);
            // showErrorToast('Không thể tải dữ liệu phụ phí.');
        }
    }

    // Hàm xử lý thêm phụ phí vào hóa đơn
    document.getElementById('btnThemPhuPhi').addEventListener('click', async function() {
        const tenPhuPhi = document.getElementById('tenPhuPhi').value.trim();
        const giaPhuPhi = document.getElementById('giaPhuPhi').value.trim();

        // Ẩn thông báo lỗi trước khi kiểm tra
        document.getElementById('errorTenPhuPhi').style.display = 'none';
        document.getElementById('errorGiaPhuPhi').style.display = 'none';

        let isValid = true;

        // Kiểm tra tên phụ phí
        if (!tenPhuPhi) {
            document.getElementById('errorTenPhuPhi').style.display = 'block'; // Hiển thị thông báo lỗi
            isValid = false;
        }

        // Kiểm tra giá phụ phí (phải là một số và lớn hơn 0)
        if (!giaPhuPhi || isNaN(giaPhuPhi) || parseFloat(giaPhuPhi) <= 0) {
            document.getElementById('errorGiaPhuPhi').textContent = 'Giá phụ phí không hợp lệ'; // Thông báo lỗi cụ thể
            document.getElementById('errorGiaPhuPhi').style.display = 'block'; // Hiển thị thông báo lỗi
            isValid = false;
        }

        // Nếu có lỗi, không gửi yêu cầu POST
        if (!isValid) {
            return; // Dừng thực hiện nếu có lỗi
        }

        const phuPhiData = {
            hoaDonChiTietId: selectedInvoiceId,      // ID hóa đơn chi tiết
            ten: tenPhuPhi,                  // Tên phụ phí
            tienPhuPhi: parseFloat(giaPhuPhi), // Giá phụ phí
            trangThai: "Đã thêm",         // Trạng thái
            deletedAt: false                 // Đảm bảo không bị xóa
        };

        try {
            // Gửi yêu cầu POST để thêm phụ phí
            const response = await fetch('http://localhost:8080/api/phu-phi-hoa-don/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(phuPhiData)
            });

            if (!response.ok) {
                throw new Error('Không thể thêm phụ phí.');
            }

            const data = await response.json();

            // Cập nhật lại bảng phụ phí sau khi thêm mới
            await loadAvailablePhuPhi(selectedInvoiceId);  // Chờ cập nhật bảng và dropdown

            // Lấy lại tổng tiền phụ phí và cập nhật ô input
            const totalTienPhuPhi = await fetchTienPhuPhi(selectedInvoiceId);
            document.getElementById('tienPhuPhi').value = totalTienPhuPhi.toLocaleString() + ' VND'; // Cập nhật ô input

            // Chờ dữ liệu được cập nhật rồi mới đóng modal
            $('#phuPhiModal').modal('hide'); // Đóng modal sau khi hoàn thành

            showSuccessToast('Thêm phụ phí thành công.');

            // Reset form khi modal đóng
            $('#phuPhiModal').on('hidden.bs.modal', function () {
                document.getElementById('tenPhuPhi').value = '';   // Xóa tên phụ phí
                document.getElementById('giaPhuPhi').value = '';   // Xóa giá phụ phí
                document.getElementById('errorTenPhuPhi').style.display = 'none'; // Ẩn thông báo lỗi
                document.getElementById('errorGiaPhuPhi').style.display = 'none'; // Ẩn thông báo lỗi
            });

        } catch (error) {
            console.error(error);
            showErrorToast('Không thể thêm phụ phí.');
        }
    });

    // Lắng nghe sự kiện khi modal đóng (bao gồm khi ấn ra ngoài hoặc ấn nút X)
    $('#phuPhiModal').on('hidden.bs.modal', function () {
        // Reset các trường nhập liệu
        document.getElementById('tenPhuPhi').value = '';   // Xóa tên phụ phí
        document.getElementById('giaPhuPhi').value = '';   // Xóa giá phụ phí

        // Ẩn các thông báo lỗi
        document.getElementById('errorTenPhuPhi').style.display = 'none';
        document.getElementById('errorGiaPhuPhi').style.display = 'none';
    });

    // Mở modal khi nhấn nút + và hiển thị phụ phí có sẵn
    document.getElementById('btnAddPhuPhi').addEventListener('click', async function() {
        // Mở modal để thêm phụ phí
        $('#phuPhiModal').modal('show');
        // Tải danh sách phụ phí có sẵn trong modal
        await loadAvailablePhuPhi(selectedInvoiceId);  // Hàm để lấy và hiển thị danh sách phụ phí
    });

    // Hàm xử lý xóa phụ phí
    async function handleDeletePhuPhi(phuPhiId, invoiceId) {
        try {
            // Hiển thị xác nhận xóa
            const result = await Swal.fire({
                title: 'Xác nhận',
                text: 'Bạn có chắc chắn muốn xóa phụ phí này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            });

            if (!result.isConfirmed) {
                return; // Nếu người dùng hủy, không làm gì
            }

            // Gửi yêu cầu PUT để xóa phụ phí
            const response = await fetch(`http://localhost:8080/api/phu-phi-hoa-don/delete/${phuPhiId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error('Không thể xóa phụ phí.');
            }

            // Hiển thị thông báo thành công
            showSuccessToast('Xóa phụ phí thành công.');

            // Cập nhật lại bảng phụ phí và số tiền sau khi xóa
            await loadAvailablePhuPhi(invoiceId);  // Cập nhật bảng phụ phí
            const totalTienPhuPhi = await fetchTienPhuPhi(invoiceId); // Cập nhật tổng tiền phụ phí
            document.getElementById('tienPhuPhi').value = totalTienPhuPhi.toLocaleString() + ' VND'; // Cập nhật ô input

        } catch (error) {
            console.error(error);
            showErrorToast('Không thể xóa phụ phí.');
        }
    }

    //End phụ phí

    // Code phần xử lý hình thức thanh toán

    // Đảm bảo khi click vào nút "Tiền khách đưa" sẽ mở modal
    document.querySelectorAll('.btn-outline-warning').forEach(button => {
        button.addEventListener('click', async function () {
            const modalId = `#exampleModal`; // ID của modal
            $(modalId).modal('show'); // Mở modal
            // Reset trạng thái ban đầu của modal
            resetModalState();
            if (selectedInvoiceId) {
                await loadChiTietHTTTTable(selectedInvoiceId);
            } else {
                showErrorToast('Không xác định được hóa đơn chi tiết.');
            }
        });
    });
    // Hàm reset trạng thái modal
    function resetModalState() {
        // Chọn nút "Tiền mặt" làm mặc định
        const chuyenKhoanButton = document.getElementById('btnChuyenKhoan');
        const tienMatButton = document.getElementById('btnTienMat');

        tienMatButton.classList.add('btn-success');
        tienMatButton.style.color = 'white';

        chuyenKhoanButton.classList.remove('btn-success');
        chuyenKhoanButton.classList.add('btn-outline-success');
        chuyenKhoanButton.style.color = '';

        // Ẩn input "Mã giao dịch"
        maGDInput(false);

        // Reset các input
        document.getElementById('khachDua').value = ''; // Reset tiền khách đưa
        document.getElementById('maGD').value = ''; // Reset mã giao dịch
    }
    // Hàm để xử lý hiển thị/ẩn input Mã giao dịch và điều chỉnh layout khi chọn "Chuyển khoản" hoặc "Tiền mặt"
    function maGDInput(check) {
        const maGDInput = document.getElementById('maGD');  // Input Mã giao dịch
        const khachDuaInput = document.getElementById('khachDua');  // Input Tiền khách đưa

        // Nếu chọn Chuyển khoản, hiển thị Mã giao dịch
        if (check) {
            maGDInput.style.display = "block";  // Hiển thị Mã giao dịch
            khachDuaInput.style.width = "50%";  // Điều chỉnh chiều rộng của "Tiền khách đưa"
        } else {
            maGDInput.style.display = "none";  // Ẩn Mã giao dịch
            khachDuaInput.style.width = "100%";  // Chiều rộng của "Tiền khách đưa" đầy đủ
        }
    }

    // Gắn sự kiện click cho các nút "Chuyển khoản" và "Tiền mặt"
    document.getElementById('btnChuyenKhoan').addEventListener('click', function() {
        // Xóa lớp "active" (btn-success) khỏi cả hai nút
        document.getElementById('btnChuyenKhoan').classList.add('btn-success');
        document.getElementById('btnChuyenKhoan').style.color = 'white';  // Thêm màu chữ trắng
        document.getElementById('btnTienMat').classList.remove('btn-success');
        document.getElementById('btnTienMat').style.color = '';  // Đặt lại màu chữ của Tiền mặt

        // Hiển thị input mã giao dịch khi chọn "Chuyển khoản"
        maGDInput(true);
    });

    document.getElementById('btnTienMat').addEventListener('click', function() {
        // Xóa lớp "active" (btn-success) khỏi cả hai nút
        document.getElementById('btnTienMat').classList.add('btn-success');
        document.getElementById('btnTienMat').style.color = 'white';  // Thêm màu chữ trắng
        document.getElementById('btnChuyenKhoan').classList.remove('btn-success');
        document.getElementById('btnChuyenKhoan').style.color = '';  // Đặt lại màu chữ của Chuyển khoản

        // Ẩn input mã giao dịch khi chọn "Tiền mặt"
        maGDInput(false);
    });

    // Hàm hiển thị danh sách chi tiết hình thức thanh toán lên bảng
    async function loadChiTietHTTTTable(invoiceId) {
        try {
            // Gọi API lấy danh sách chi tiết hình thức thanh toán
            const response = await fetch(`http://localhost:8080/chi-tiet-hinh-thuc-thanh-toan/find-by-id-hdct/${invoiceId}`);
            if (!response.ok) {
                throw new Error('Không thể tải dữ liệu chi tiết hình thức thanh toán.');
            }

            const data = await response.json();

            // Lấy bảng hiển thị danh sách
            const tbody = document.getElementById(`tbodyCTHTTT`);
            tbody.innerHTML = ''; // Xóa nội dung cũ trong bảng

            if (data.length > 0) {
                // Duyệt qua danh sách và thêm từng hàng vào bảng
                data.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.maGiaoDich || ''}</td>
                    <td>${item.idHinhThucThanhToan === 1 ? 'Chuyển khoản' : 'Tiền mặt'}</td>
                    <td>${item.soTien.toLocaleString()} VND</td>
                    <td>
                        <button type="button" class="btn btn-outline-danger btnDeleteHTTT"
                                data-id="${item.id}"
                                title="Xóa">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                    tbody.appendChild(row);
                });

                // Gắn sự kiện cho các nút "Xóa" sau khi thêm hàng
                document.querySelectorAll('.btnDeleteHTTT').forEach(button => {
                    button.addEventListener('click', async function () {
                        const htttId = this.getAttribute('data-id');
                        await deleteChiTietHTTT(htttId, selectedInvoiceId);
                    });
                });
            } else {
                // Hiển thị thông báo nếu không có dữ liệu
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5" class="text-center">Không có dữ liệu</td>`;
                tbody.appendChild(row);
            }
        } catch (error) {
            // console.error(error);
            // showErrorToast('Lỗi khi tải dữ liệu chi tiết hình thức thanh toán.');
        }
    }

    // Hàm xóa chi tiết hình thức thanh toán
    async function deleteChiTietHTTT(htttId, invoiceId) {
        try {
            // Hiển thị xác nhận trước khi xóa
            const result = await Swal.fire({
                title: 'Xác nhận xóa',
                text: 'Bạn có chắc chắn muốn xóa chi tiết này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy',
            });

            if (!result.isConfirmed) return;
            // Gửi yêu cầu xóa tới API
            const response = await fetch(`http://localhost:8080/chi-tiet-hinh-thuc-thanh-toan/xoa/${htttId}`, {
                method: 'PUT',
            });

            if (!response.ok) {
                throw new Error('Không thể xóa chi tiết hình thức thanh toán.');
            }

            // Tải lại danh sách sau khi xóa
            await loadChiTietHTTTTable(invoiceId);
            showSuccessToast('Xóa thành công.');
        } catch (error) {
            console.error(error);
            showErrorToast('Lỗi khi xóa chi tiết hình thức thanh toán.');
        }
    }


    //Thêm hình thức thanh toán
    document.getElementById('btnXacNhanThanhToan').addEventListener('click', async function () {
        const khachDua = document.getElementById('khachDua').value.trim();
        const maGD = document.getElementById('maGD').value.trim();
        const chuyenKhoanButton = document.getElementById('btnChuyenKhoan');
        const tienMatButton = document.getElementById('btnTienMat');

        // Xác định idHinhThucThanhToan
        let idHinhThucThanhToan = null;
        if (chuyenKhoanButton.classList.contains('btn-success')) {
            idHinhThucThanhToan = chuyenKhoanButton.getAttribute('data-id-hinh-thuc-thanh-toan');
        } else if (tienMatButton.classList.contains('btn-success')) {
            idHinhThucThanhToan = tienMatButton.getAttribute('data-id-hinh-thuc-thanh-toan');
        }

        // Kiểm tra đầu vào
        if (!khachDua || isNaN(khachDua) || parseFloat(khachDua) <= 0) {
            return showErrorToast('Số tiền khách đưa không hợp lệ.');
        }
        if (idHinhThucThanhToan === "1" && !maGD) {
            return showErrorToast('Mã giao dịch không được bỏ trống khi chọn Chuyển khoản.');
        }

        // Chuẩn bị dữ liệu để gửi
        const payload = {
            idHinhThucThanhToan: parseInt(idHinhThucThanhToan),
            soTien: parseFloat(khachDua),
            maGiaoDich: idHinhThucThanhToan === "1" ? maGD : null,
            idHoaDonChiTiet: selectedInvoiceId,
            trangThai: "Đã thêm",
        };

        try {
            const response = await fetch('http://localhost:8080/chi-tiet-hinh-thuc-thanh-toan/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                throw new Error('Không thể lưu chi tiết hình thức thanh toán.');
            }

            const data = await response.json();
            await loadChiTietHTTTTable(selectedInvoiceId); // Tải lại bảng chi tiết hình thức thanh toán
            showSuccessToast('Lưu thông tin thanh toán thành công!');

            // **RESET INPUTS SAU KHI LƯU THÀNH CÔNG**
            document.getElementById('khachDua').value = ''; // Xóa tiền khách đưa
            document.getElementById('maGD').value = '';     // Xóa mã giao dịch
            resetModalState();
        } catch (error) {
            console.error(error);
            showErrorToast('Lỗi khi lưu thông tin thanh toán.');
        }
    });

    //End hình thức thanh toán

    //Code phần bên phải (Thanh toán)
    async function loadInvoiceDetails(invoiceId) {
        try {
            // Gọi API lấy thông tin chi tiết hóa đơn
            const response = await fetch(`http://localhost:8080/hoa-don-chi-tiet/${invoiceId}`);

            const data = await response.json();

            // Điền thông tin vào các ô input trong phần bên phải
            document.getElementById('id').value = data.id || 'Chưa có dữ liệu';
            document.getElementById('idHoaDon').value = data.idHoaDon || 'Chưa có dữ liệu';
            document.getElementById('maHoaDon').value = data.maHoaDon || 'Chưa có dữ liệu';
            document.getElementById('maHoaDonChiTiet').value = data.maHoaDonChiTiet || 'Chưa có dữ liệu';
            document.getElementById('hoVaTenKhachHang').value = data.hoVaTenKhachHang || 'Chưa có dữ liệu';
            document.getElementById('soDienThoaiKhachHang').value = data.soDienThoaiKhachHang || 'Chưa có dữ liệu';
            // document.getElementById('trangThai').value = data.trangThai || 'Chưa có dữ liệu';
            document.getElementById('tenSanBong').value = data.tenSanBong || 'Chưa có dữ liệu';
            document.getElementById('thoiGianBatDauCa').value = data.thoiGianBatDauCa
                ? new Date(data.thoiGianBatDauCa).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                : '';
            document.getElementById('thoiGianKetThucCa').value = data.thoiGianKetThucCa
                ? new Date(data.thoiGianKetThucCa).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                : '';
            document.getElementById('ngayTaoHoaDon').value = data.ngayTaoHoaDon || 'Chưa có dữ liệu';
            document.getElementById('ngayDenSan').value = data.ngayDenSan || 'Chưa có dữ liệu';
            document.getElementById('tienSan').value = data.giaSanCa?.toLocaleString() + ' VND' || 'Chưa có dữ liệu';
            // Tính toán tiền cọc từ tiền sân
            const deposit = await calculateDeposit(data.giaSanCa || 0);
            document.getElementById('tienCoc').value = deposit.toLocaleString() + ' VND'; // Cập nhật tiền cọc
            // Gọi API để lấy tiền phụ phí và hiển thị lên ô input
            const tienPhuPhi = await fetchTienPhuPhi(invoiceId);
            document.getElementById('tienPhuPhi').value = tienPhuPhi.toLocaleString() + ' VND'; // Hiển thị tiền phụ phí
            await loadAvailablePhuPhi(selectedInvoiceId);
            // document.getElementById('giaDichVu').value = data.giaDichVu?.toLocaleString() + ' VND' || 'Chưa có dữ liệu';

            // Tính toán tổng tiền phải trả và hiển thị
            const tongTien = (data.giaSan || 0) + (data.giaDichVu || 0) - (data.phieuGiamGia || 0) + (data.tienPhuPhi || 0);
            document.getElementById('tongTien').textContent = tongTien.toLocaleString() + ' VND';

        } catch (error) {
            // console.error('Error fetching invoice details:', error);
        }
    }

    // Code phần dưới bên trái (DỊCH VỤ)
    //Hàm hiển thị dữ liệu trong modal
    function fetchAndRenderServices(apiUrl, containerId, itemFields) {
        $.ajax({
            url: apiUrl,
            type: 'GET',
            success: function (data) {
                if (!data || data.length === 0) {
                    $(`#${containerId}`).html('<p>Không có dịch vụ nào được tìm thấy.</p>');
                    return;
                }

                let content = '<div class="row" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">';

                data.forEach(item => {
                    const imageUrl = item[itemFields.imageField] || '';
                    const serviceName = item[itemFields.ten] || '';
                    const stock = item[itemFields.soLuong] || 0;
                    const price = item[itemFields.donGia] ? item[itemFields.donGia].toLocaleString() : '0';
                    content += `
                <div class="product-card" style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 250px; background-color: #ffffff; padding: 15px; text-align: center; position: relative;">
                    <div class="price-tag" style="position: absolute; top: 10px; right: 10px; background-color: #ff4d4d; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 14px;">
                        ${price} VND
                    </div>
                    <img src="${imageUrl}" class="card-img-top" alt="${serviceName}" style="width: 100%; height: 160px; object-fit: cover; border-radius: 5px; margin-bottom: 10px;">
                    <h5 class="card-title" style="margin: 10px 0; font-size: 18px; font-weight: bold; color: #333;">${serviceName}</h5>
                    <p class="card-text kho-con" style="margin: 5px 0; font-size: 14px; color: #666;" >Kho Còn: ${stock}</p>
                    <div class="input-group" style="margin: 10px 0;">
                        <input type="number" class="form-control quantity-input" value="0" min="0" style="width: 60px; display: inline-block;">
                    </div>
                    <div class="input-group-append" style="margin-top: 10px;">
                        <button class="btn btn-success add-btn" data-id="${item[itemFields.id]}"  data-price="${item[itemFields.donGia]}" data-name="${serviceName}" data-so-luong="${item[itemFields.soLuong]}" type="button" style="width: 100%; margin-bottom: 5px;">Thêm</button>
                    </div>
                </div>`;
                });

                content += '</div>';
                $(`#${containerId}`).html(content);
            },
        });
    }

    //Khi mở modal THêm dịch vụ
    $('#openServiceModal').on('click', function () {
        if (!selectedInvoiceId) {
            Swal.fire({
                icon: 'warning',
                title: 'Chưa chọn hóa đơn!',
                text: 'Vui lòng chọn một hóa đơn chi tiết trước khi thêm dịch vụ.',
            });
            return;
        }

        // Hiển thị danh sách "Đồ Thuê"
        fetchAndRenderServices(
            'http://localhost:8080/do_thue/searchTenDoThue?tenDoThue=',
            'doThueTab',
            {ten: 'tenDoThue', donGia: 'donGias', imageField: 'imageData', soLuong: 'soLuongs' , id : 'id'}
        );

        // Hiển thị danh sách "Nước Uống"
        fetchAndRenderServices(
            'http://localhost:8080/nuoc_uong/searchTenNuocUong?tenNuocUong=',
            'nuocUongTab',
            {ten: 'tenNuocUong', donGia: 'donGias', imageField: 'imageData', soLuong: 'soLuongs', id : 'id'}
        );

        $('#serviceModal').modal('show');
    });

    document.addEventListener('click', async (event) => {
        if (event.target.classList.contains('add-btn')) {
            const button = event.target;
            const id = parseInt(button.getAttribute('data-id'), 10); // ID dịch vụ
            const soLuongInput = button.closest('.product-card').querySelector('.quantity-input');
            const soLuong = parseInt(soLuongInput.value, 10); // Số lượng nhập từ input
            const soLuongTonKho = parseInt(button.getAttribute('data-so-luong'), 10); // Số lượng tồn kho ban đầu
            const idTabActive = document.querySelector('#serviceTabs .nav-link.active').id; // Tab hiện tại
            const trangThai = "Đã đặt";
            const idHoaDonChiTiet = selectedInvoiceId; // ID hóa đơn chi tiết đã chọn

            if (!idHoaDonChiTiet) {
                showErrorToast('Không thể thêm dịch vụ. ID hóa đơn chi tiết không hợp lệ!');
                return;
            }

            // Gán dữ liệu DTO
            const dichVuSanBongDTO = {
                idDoThue: idTabActive === 'tab1' ? id : null,
                idNuocUong: idTabActive === 'tab2' ? id : null,
                idHoaDonChiTiet: idHoaDonChiTiet,
                soLuong: soLuong,
                trangThai: trangThai,
                deletedAt: false,
            };

            console.log('Dữ liệu gửi đi:', dichVuSanBongDTO);

            try {
                // Gửi API POST
                const postResponse = await fetch('http://localhost:8080/dich-vu-san-bong', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dichVuSanBongDTO),
                });

                if (!postResponse.ok) throw new Error(`POST error: ${await postResponse.text()}`);

                console.log('Thêm dịch vụ thành công!');

                // Tính toán số lượng còn lại
                const soLuongConLai = soLuongTonKho - soLuong; // Số lượng còn lại = Tồn kho ban đầu - Số lượng nhập

                // Tạo DTO cho API PUT
                const updateSoLuongDTO = {
                    soLuongs: soLuongConLai, // Số lượng còn lại
                };

                console.log('Số lượng tồn kho ban đầu:', soLuongTonKho);
                console.log('Số lượng khách nhập:', soLuong);
                console.log('Số lượng còn lại (gửi đi):', soLuongConLai);

                // Xác định URL PUT API dựa trên tab
                const updateUrl = idTabActive === 'tab1'
                    ? `http://localhost:8080/do_thue/updateSoLuong/${id}`
                    : `http://localhost:8080/nuoc_uong/updateSoLuong/${id}`;

                // Gửi API PUT để cập nhật tồn kho
                const putResponse = await fetch(updateUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateSoLuongDTO),
                });

                if (!putResponse.ok) throw new Error(`PUT error: ${await putResponse.text()}`);

                console.log('Cập nhật tồn kho thành công!');
                showSuccessToast('Thêm dịch vụ và cập nhật tồn kho thành công!');

                // Cập nhật lại số lượng còn trong box sản phẩm (modal)
                const khoConElement = button.closest('.product-card').querySelector('.kho-con');
                if (khoConElement) {
                    khoConElement.textContent = `Kho Còn: ${soLuongConLai}`;
                }

            } catch (error) {
                console.error('Error:', error);
                showErrorToast('Có lỗi xảy ra khi thêm dịch vụ hoặc cập nhật tồn kho!');
            }
        }
    });

    function fillDichVuChoHoaDon(idHDCT) {
        $.ajax({
            url: `http://localhost:8080/dich-vu-san-bong/tim-theo-idhdct/${idHDCT}`,
            type: 'GET',
            success: function (data) {
                if (!data || data.length === 0) {
                    $('#dichVuThueList').html('<p>Chưa có dịch vụ nào được thêm vào hóa đơn.</p>');
                    return;
                }

                let content = '<div class="row" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">';
                data.forEach(item => {
                    const imageUrl = item.idDoThue ? item.imageDataDoThue : item.imageDataNuocUong || '';
                    const serviceName = item.idDoThue ? item.tenDoThue : item.tenNuocUong || '';
                    const price = item.idDoThue ? item.donGiasDoThue : item.donGiasNuocUong;
                    const formattedPrice = price ? price.toLocaleString() : '0';
                    const idDoThue = item.idDoThue || null;
                    const idNuocUong = item.idNuocUong || null;

                    content += `
                <div class="product-card" style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 250px; background-color: #ffffff; padding: 15px; text-align: center; position: relative;">
                    <div class="price-tag" style="position: absolute; top: 10px; right: 10px; background-color: #ff4d4d; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 14px;">
                        ${formattedPrice} VND
                    </div>
                    <img src="${imageUrl}" class="card-img-top" alt="${serviceName}" style="width: 100%; height: 160px; object-fit: cover; border-radius: 5px; margin-bottom: 10px;">
                    <h5 class="card-title" style="margin: 10px 0; font-size: 18px; font-weight: bold; color: #333;">${serviceName}</h5>
                    <div class="input-group">
                        <input type="number" class="form-control quantity-input" value="${item.soLuong}" min="0" data-id="${item.id}" data-id-hdct="${idHDCT}" data-id-do-thue="${idDoThue}" data-id-nuoc-uong="${idNuocUong}" style="width: 100px; margin: auto;">
                    </div>
                    <div class="d-flex justify-content-between" style="margin-top: 10px;">
                        <button class="btn btn-danger cancel-btn" data-id="${item.id}" type="button" style="width: 48%;">Hủy</button>
                        <button class="btn btn-success update-btn" data-id="${item.id}" data-id-hdct="${idHDCT}" type="button" style="width: 48%;">Cập nhật</button>
                    </div>
                </div>`;
                });

                content += '</div>';
                $('#dichVuThueList').html(content);
            },
            error: function (error) {
                console.error('Lỗi khi lấy dữ liệu dịch vụ:', error);
                showErrorToast('Không thể lấy danh sách dịch vụ.');
            }
        });
    }

</script>
</body>
</html>

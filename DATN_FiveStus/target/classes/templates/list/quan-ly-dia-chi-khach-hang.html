<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

<head th:include="fragment/head :: head">
</head>
<style>
    .address-container {
        display: flex;
        flex-direction: column; /* Đặt các phần tử theo chiều dọc */
        justify-content: flex-start; /* Canh lề phía trên */
    }
    .pagination-container {
        margin-top: 20px; /* Khoảng cách giữa danh sách địa chỉ và phân trang */
    }

    .pagination {
        display: flex;
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    .pagination .page-item {
        margin: 0 5px; /* Khoảng cách giữa các item phân trang */
    }
    .pagination .page-item a {
        text-decoration: none; /* Bỏ gạch dưới */
    }
    /* Ẩn nút tăng giảm trên trình duyệt Webkit (Chrome, Safari, Edge) */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Ẩn nút tăng giảm trên Firefox */
    input[type="number"] {
        -moz-appearance: textfield;
    }

</style>
<body class="vertical light">
<div class="wrapper">
    <div th:include="fragment/navbar :: navbar"></div>
    <div th:include="fragment/sidebar :: sidebar"></div>
    <main role="main" class="main-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-body">
                            <!-- Customer information -->
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-container" id="formKhachHang">
                                        <h4 class="page-title">Thông tin khách hàng</h4>
                                        <form th:action="@{/quan-ly-khach-hang/cap-nhat}" method="post"
                                              class="updateKhachHang" style="margin-top: 70px" novalidate>
                                            <input type="hidden" th:name="id" th:value="${khachHang.id}">

                                            <div class="mb-3">
                                                <label for="maKhachHang" class="form-label">Mã khách hàng</label>
                                                <input type="text" class="form-control" id="maKhachHang"
                                                       name="maKhachHang"
                                                       th:value="${khachHang.maKhachHang}"  disabled>
                                            </div>

                                            <div class="mb-3">
                                                <label for="hoVaTen" class="form-label">Họ và tên</label>
                                                <input type="text" class="form-control" id="hoVaTen" name="hoVaTen"
                                                       th:value="${khachHang.hoVaTen}" >
                                            </div>

                                            <div class="mb-3">
                                                <label for="email" class="form-label">Email</label>
                                                <input type="text" class="form-control" id="email" name="email"
                                                       th:value="${khachHang.email}" >
                                            </div>

                                            <div class="mb-3">
                                                <label for="soDienThoai" class="form-label">Số điện thoại</label>
                                                <input type="number" class="form-control" id="soDienThoai"
                                                       name="soDienThoai"
                                                       th:value="${khachHang.soDienThoai}" >
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">Giới tính</label><br>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" id="gioiTinhNam"
                                                           name="gioiTinh"
                                                           value="true" th:checked="${khachHang.gioiTinh == true}">
                                                    <label class="form-check-label" for="gioiTinhNam">Nam</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" id="gioiTinhNu"
                                                           name="gioiTinh"
                                                           value="false" th:checked="${khachHang.gioiTinh == false}">
                                                    <label class="form-check-label" for="gioiTinhNu">Nữ</label>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label for="trangThai" class="form-label">Trạng thái</label>
                                                <select class="form-control" id="trangThai" name="trangThai">
                                                    <option value="active"
                                                            th:selected="${khachHang.trangThai == 'active'}">Hoạt động
                                                    </option>
                                                    <option value="inactive"
                                                            th:selected="${khachHang.trangThai == 'inactive'}">Không
                                                        hoạt động
                                                    </option>
                                                </select>
                                            </div>

                                            <div class="mb-3 text-center">
                                                <button type="submit" class="btn btn-success">Cập nhật</button>
                                                <a href="/quan-ly-khach-hang" class="btn btn-primary ms-2">Quay
                                                    lại</a>
                                            </div>
                                        </form>
                                        <!--                                        </div>-->
                                    </div>
                                </div>
                                <!-- Add address form and address list -->
                                <div class="col-md-8">
                                    <div class="form-container" id="formDiaChi">
                                        <div class="row">
                                            <div class="col-12">
                                                <h4 class="page-title">Danh sách địa chỉ của khách hàng</h4>
                                            </div>
                                        </div>
                                        <div class="accordion" id="accordionAddAddress">
                                            <div class="accordion-item add-address-item" style="margin-top: 60px; margin-bottom: 70px">
                                                <h2 class="accordion-header" id="headingAddAddress">
                                                    <button class="accordion-button add-new-address-button" type="button"style="background: #f2f2f2;color: #4bd81a" onclick="toggleForm()">
                                                        <b>+Tạo địa chỉ mới</b>
                                                    </button>
                                                </h2>
                                                <div id="collapseAddAddress" class="accordion-collapse collapse" aria-labelledby="headingAddAddress"
                                                     data-bs-parent="#accordionAddAddress">
                                                    <div class="accordion-body">
                                                        <form th:action="@{/quan-ly-khach-hang/them-dia-chi}" method="post" class="add-address-form"
                                                              id="addAddressForm">
                                                            <input type="hidden" th:name="idKhachHang" th:value="${khachHang.id}">
                                                            <div class="form-group">
                                                                <label for="tenDiaChi">Địa chỉ cụ thể</label>
                                                                <input type="text" class="form-control" id="tenDiaChi" name="diaChiCuThe"
                                                                       placeholder="Nhập địa chỉ cụ thể">
                                                            </div>
                                                            <div class="form-row">
                                                                <div class="form-group col-md-4">
                                                                    <label for="city">Tỉnh thành</label>
                                                                    <select id="city" class="form-control" name="thanhPho" >
                                                                        <option value="" selected>Chọn tỉnh thành</option>
                                                                        <!-- Các option của tỉnh thành -->
                                                                    </select>
                                                                </div>
                                                                <div class="form-group col-md-4">
                                                                    <label for="district">Quận huyện</label>
                                                                    <select id="district" class="form-control" name="quanHuyen" >
                                                                        <option value="" selected>Chọn Quận Huyện</option>
                                                                        <!-- Các option của quận huyện -->
                                                                    </select>
                                                                </div>
                                                                <div class="form-group col-md-4">
                                                                    <label for="ward">Phường xã</label>
                                                                    <select id="ward" class="form-control" name="phuongXa" >
                                                                        <option value="" selected>Chọn Phường Xã</option>
                                                                        <!-- Các option của phường xã -->
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            <div class="form-group">
                                                                <label for="ghiChu">Ghi chú</label>
                                                                <input type="text" class="form-control" id="ghiChu" name="ghiChu" placeholder="Nhập ghi chú (Có thể để trống)">
                                                            </div>
                                                            <button type="submit" class="btn btn-primary">Thêm</button>
                                                            <button type="button" class="btn btn-secondary" onclick="toggleForm()">Đóng</button>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Danh sách địa chỉ -->
<!--                                        <div th:if="${#lists.isEmpty(diaChiList)}">-->
<!--                                            &lt;!&ndash; Hiển thị thông báo khi không có địa chỉ &ndash;&gt;-->
<!--                                            <p class="text-danger text-center">Chưa có địa chỉ</p>-->
<!--                                        </div>-->
                                        <input type="hidden" id="khachHangId" th:value="${khachHang.id}">
                                        <div class="address-container">
                                            <div id="address-list">
                                                <!-- Danh sách địa chỉ sẽ được thêm vào đây thông qua JavaScript -->
                                            </div>

                                            <!-- Thêm một container bao bọc để dễ dàng căn chỉnh -->
                                            <div class="pagination-container">
                                                <ul class="pagination justify-content-end mb-0">
                                                    <li class="page-item" id="prevPageButton">
                                                        <a class="btn btn-success" href="#" onclick="changePage(currentPage - 1)" aria-label="Previous">
                                                            <span aria-hidden="true">&lt;</span>
                                                        </a>
                                                    </li>

                                                    <li class="page-item">
                                                        <select class="custom-select" id="pageDropdown" onchange="changePageFromDropdown(this)">
                                                            <!-- Options for page numbers will be inserted dynamically -->
                                                        </select>
                                                    </li>

                                                    <li class="page-item" id="nextPageButton">
                                                        <a class="btn btn-success" href="#" onclick="changePage(currentPage + 1)" aria-label="Next">
                                                            <span aria-hidden="true">&gt;</span>
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

    </main>
    <div th:include="fragment/script :: script"></div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script>
        let currentPage = 0; // Trang hiện tại
        let totalPages = 1;  // Tổng số trang

        async function fetchAddresses(khachHangId, page = 0) {
            try {
                // Gửi yêu cầu với tham số phân trang
                const response = await fetch(`/dia-chi/khachhang/${khachHangId}?page=${page}&size=2`);
                if (!response.ok) {
                    throw new Error("Không thể tải dữ liệu từ server.");
                }
                const data = await response.json();
                totalPages = data.totalPages; // Lấy tổng số trang từ API
                currentPage = data.number; // Cập nhật trang hiện tại
                renderAddresses(data.content); // Gọi renderAddresses để hiển thị
                updatePagination(); // Cập nhật giao diện phân trang
            } catch (error) {
                console.error("Lỗi khi lấy danh sách địa chỉ:", error);
            }
        }


        async function renderAddresses(addressList) {
            const addressContainer = document.getElementById("address-list");
            addressContainer.innerHTML = ""; // Xóa nội dung cũ

            // Tính toán số bắt đầu của địa chỉ cho trang hiện tại
            const pageStartIndex = currentPage * 2; // 2 là số lượng địa chỉ mỗi trang

            // Nếu không có địa chỉ, hiển thị thông báo "Chưa có địa chỉ" và ẩn phân trang
            if (addressList.length === 0) {
                const noAddressMessage = `
            <p style="font-weight: bold; text-align: center;">Chưa có địa chỉ</p>
        `;
                addressContainer.innerHTML = noAddressMessage;
                // Ẩn phân trang
                document.querySelector('.pagination-container').style.display = 'none';
            } else {
                // Hiển thị danh sách địa chỉ nếu có
                for (const [index, address] of addressList.entries()) {
                    const actualIndex = pageStartIndex + index; // Tính số thứ tự thực của địa chỉ

                    const accordionId = `accordion${actualIndex}`;
                    const headingId = `heading${actualIndex}`;
                    const collapseId = `collapse${actualIndex}`;
                    const addressHTML = `
                <div class="accordion customer-address-accordion" id="${accordionId}">
                    <div class="accordion-item" style="margin-top: 20px">
                        <h2 class="accordion-header" id="${headingId}">
                            <button class="accordion-button customer-address-button" type="button" onclick="toggleAccordion('${collapseId}')">
                                <b>Địa chỉ ${actualIndex + 1}</b>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse show" aria-labelledby="${headingId}">
                            <div class="accordion-body">
                                <form class="update-address-form" data-index="${actualIndex}" onsubmit="updateAddress(event, ${actualIndex})">
                                    <input type="hidden" name="id" value="${address.id}">
                                    <div class="form-group">
                                        <label for="updateTenDiaChi${actualIndex}">Địa chỉ cụ thể</label>
                                        <input type="text" class="form-control" id="updateTenDiaChi${actualIndex}" name="diaChiCuThe" value="${address.diaChiCuThe}">
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <label>Tỉnh thành</label>
                                            <select class="form-control city-select" name="thanhPho" data-index="${actualIndex}" onchange="fetchDistricts(this, ${actualIndex})">
                                                <option value="">Chọn Tỉnh Thành</option>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label>Quận huyện</label>
                                            <select class="form-control district-select" name="quanHuyen" data-index="${actualIndex}" onchange="fetchWards(this, ${actualIndex})">
                                                <option value="">Chọn Quận Huyện</option>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-4">
                                            <label>Phường xã</label>
                                            <select class="form-control ward-select" name="phuongXa" data-index="${actualIndex}">
                                                <option value="">Chọn Phường Xã</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="updateGhiChu${actualIndex}">Ghi chú</label>
                                        <input type="text" class="form-control" id="updateGhiChu${actualIndex}" name="ghiChu" value="${address.ghiChu || ''}" placeholder="Không có ghi chú">
                                    </div>
                                    <div class="text-right">
                                        <button type="submit" class="btn btn-outline-success">
                                            <span class="fe fe-edit-3"></span>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                    addressContainer.insertAdjacentHTML("beforeend", addressHTML);

                    // Fetch options for select inputs
                    await fetchProvinces(actualIndex, address.thanhPho, address.quanHuyen, address.phuongXa);
                }

                // Hiển thị phân trang nếu có địa chỉ
                document.querySelector('.pagination-container').style.display = 'block';
            }
        }



        function updatePagination() {
            const pageDropdown = document.getElementById("pageDropdown");
            pageDropdown.innerHTML = ""; // Xóa các option cũ

            // Cập nhật dropdown với các số trang
            for (let i = 0; i < totalPages; i++) {
                const option = document.createElement("option");
                option.value = i;
                option.textContent = `Trang ${i + 1}`;
                if (i === currentPage) option.selected = true;
                pageDropdown.appendChild(option);
            }

            // Hiển thị/Ẩn nút "Lùi" và "Tiến" khi cần
            const prevButton = document.getElementById("prevPageButton");
            const nextButton = document.getElementById("nextPageButton");

            if (currentPage === 0) {
                prevButton.style.display = "none"; // Ẩn nút "Lùi" nếu ở trang đầu tiên
            } else {
                prevButton.style.display = ""; // Hiện nút "Lùi"
            }

            if (currentPage === totalPages - 1) {
                nextButton.style.display = "none"; // Ẩn nút "Tiến" nếu ở trang cuối cùng
            } else {
                nextButton.style.display = ""; // Hiện nút "Tiến"
            }
        }

        function changePage(page) {
            if (page < 0 || page >= totalPages) return;
            fetchAddresses(document.getElementById("khachHangId").value, page);
        }

        function changePageFromDropdown(dropdown) {
            const selectedPage = parseInt(dropdown.value, 10);
            fetchAddresses(document.getElementById("khachHangId").value, selectedPage);
        }



        let locationData = []; // Lưu trữ dữ liệu địa phương

        async function fetchLocationData() {
            try {
                const response = await fetch("https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json");
                locationData = await response.json();
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu địa phương:", error);
            }
        }

        async function fetchProvinces(index, selectedProvince, selectedDistrict, selectedWard) {
            try {
                if (!locationData.length) await fetchLocationData();

                const citySelect = document.querySelector(`.city-select[data-index="${index}"]`);
                const districtSelect = document.querySelector(`.district-select[data-index="${index}"]`);
                const wardSelect = document.querySelector(`.ward-select[data-index="${index}"]`);

                // Reset dropdown Quận/Huyện và Phường/Xã
                districtSelect.innerHTML = `<option value="">Chọn Quận Huyện</option>`;
                wardSelect.innerHTML = `<option value="">Chọn Phường Xã</option>`;

                // Populate Tỉnh/Thành phố
                citySelect.innerHTML = `<option value="">Chọn Tỉnh Thành</option>`; // Reset
                locationData.forEach((city) => {
                    const selected = city.Id === selectedProvince ? "selected" : "";
                    citySelect.innerHTML += `<option value="${city.Id}" ${selected}>${city.Name}</option>`;
                });

                if (selectedProvince) {
                    await fetchDistricts(citySelect, index, selectedDistrict, selectedWard);
                }
            } catch (error) {
                console.error("Lỗi khi tải tỉnh/thành phố:", error);
            }
        }

        async function fetchDistricts(citySelect, index, selectedDistrict, selectedWard) {
            const provinceId = citySelect.value || citySelect.options[citySelect.selectedIndex]?.value;
            if (!provinceId) return;

            const city = locationData.find((city) => city.Id === provinceId);
            if (!city) return;

            const districtSelect = document.querySelector(`.district-select[data-index="${index}"]`);
            const wardSelect = document.querySelector(`.ward-select[data-index="${index}"]`);

            // Reset dropdown Quận/Huyện và Phường/Xã
            districtSelect.innerHTML = `<option value="">Chọn Quận Huyện</option>`;
            wardSelect.innerHTML = `<option value="">Chọn Phường Xã</option>`;

            // Populate Quận/Huyện
            city.Districts.forEach((district) => {
                const selected = district.Id === selectedDistrict ? "selected" : "";
                districtSelect.innerHTML += `<option value="${district.Id}" ${selected}>${district.Name}</option>`;
            });

            if (selectedDistrict) {
                const districtOption = districtSelect.querySelector(`option[value="${selectedDistrict}"]`);
                if (districtOption) districtOption.selected = true;
                await fetchWards(districtSelect, index, selectedWard);
            }
        }

        async function fetchWards(districtSelect, index, selectedWard) {
            const districtId = districtSelect.value || districtSelect.options[districtSelect.selectedIndex]?.value;
            if (!districtId) return;

            const provinceId = document.querySelector(`.city-select[data-index="${index}"]`).value;
            const city = locationData.find((city) => city.Id === provinceId);
            if (!city) return;

            const district = city.Districts.find((district) => district.Id === districtId);
            if (!district) return;

            const wardSelect = document.querySelector(`.ward-select[data-index="${index}"]`);
            wardSelect.innerHTML = `<option value="">Chọn Phường Xã</option>`; // Reset
            district.Wards.forEach((ward) => {
                const selected = ward.Id === selectedWard ? "selected" : "";
                wardSelect.innerHTML += `<option value="${ward.Id}" ${selected}>${ward.Name}</option>`;
            });
        }




        function toggleAccordion(collapseId) {
            const element = document.getElementById(collapseId);
            if (element.classList.contains("show")) {
                element.classList.remove("show");
            } else {
                element.classList.add("show");
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const khachHangId = document.getElementById("khachHangId").value;
            fetchAddresses(khachHangId);
        });
        function toggleForm() {
            var form = document.getElementById('collapseAddAddress');
            if (form.classList.contains('show')) {
                form.classList.remove('show');
            } else {
                form.classList.add('show');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const closeButtons = document.querySelectorAll('.btn-secondary[data-bs-toggle="collapse"]');
            closeButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const target = button.getAttribute('data-bs-target');
                    const collapseElement = document.querySelector(target);
                    const bsCollapse = bootstrap.Collapse.getInstance(collapseElement);
                    if (bsCollapse) {
                        bsCollapse.hide();
                    }
                });
            });
        });

        document.addEventListener('DOMContentLoaded', function () {
            const closeButtons = document.querySelectorAll('.btn-secondary[data-bs-toggle="collapse"]');
            closeButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const target = button.getAttribute('data-bs-target');
                    const collapseElement = document.querySelector(target);
                    const bsCollapse = bootstrap.Collapse.getInstance(collapseElement);
                    if (bsCollapse) {
                        bsCollapse.hide();
                    }
                });
            });

            const citySelect = document.getElementById("city");
            const districtSelect = document.getElementById("district");
            const wardSelect = document.getElementById("ward");

            let locationData = []; // Biến lưu trữ dữ liệu địa phương

            // Hàm tải dữ liệu từ URL
            async function fetchData() {
                try {
                    const response = await axios.get(
                        "https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json"
                    );
                    locationData = response.data;
                    resetSelect(citySelect, "Chọn Tỉnh Thành");
                    renderOptions(citySelect, locationData, "Name", "Id"); // Render tỉnh/thành phố
                } catch (error) {
                    console.error("Lỗi khi tải dữ liệu địa chỉ:", error);
                }
            }

            // Hàm render options cho dropdown
            function renderOptions(selectElement, data, textKey = "Name", valueKey = "Id") {
                data.forEach((item) => {
                    const option = document.createElement("option");
                    option.value = item[valueKey];
                    option.textContent = item[textKey];
                    selectElement.appendChild(option);
                });
            }

            // Hàm reset dropdown
            function resetSelect(selectElement, placeholder = "Chọn") {
                selectElement.innerHTML = `<option value="">${placeholder}</option>`;
            }

            // Sự kiện khi chọn tỉnh/thành phố
            citySelect.addEventListener("change", function () {
                const selectedCityId = this.value;
                const districts = locationData.find((city) => city.Id === selectedCityId)?.Districts || [];
                resetSelect(districtSelect, "Chọn Quận Huyện");
                resetSelect(wardSelect, "Chọn Phường Xã");
                renderOptions(districtSelect, districts, "Name", "Id");
            });

            // Sự kiện khi chọn quận/huyện
            districtSelect.addEventListener("change", function () {
                const selectedCityId = citySelect.value;
                const selectedDistrictId = this.value;
                const wards =
                    locationData
                        .find((city) => city.Id === selectedCityId)
                        ?.Districts.find((district) => district.Id === selectedDistrictId)?.Wards || [];
                resetSelect(wardSelect, "Chọn Phường Xã");
                renderOptions(wardSelect, wards, "Name", "Id");
            });

            // Khởi chạy
            fetchData();
            document.getElementById("addAddressForm").addEventListener("submit", function (event) {
                event.preventDefault(); // Ngăn chặn hành động mặc định của submit form

                Swal.fire({
                    title: 'Xác nhận',
                    text: 'Bạn chắc chắn muốn thêm địa chỉ này không?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes',
                    cancelButtonText: 'Cancel',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        let formData = new FormData(this);

                        fetch('/quan-ly-khach-hang/them-dia-chi', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => response.text()) // Xử lý phản hồi dưới dạng văn bản
                            .then(text => {
                                // Hiển thị thông báo thành công
                                Swal.fire({
                                    title: 'Thành công!',
                                    text: text,
                                    icon: 'success'
                                }).then(() => {
                                    // Reset form
                                    const addAddressForm = document.getElementById("addAddressForm");
                                    addAddressForm.reset(); // Reset toàn bộ form
                                    resetSelect(districtSelect, "Chọn Quận Huyện");
                                    resetSelect(wardSelect, "Chọn Phường Xã");
                                    toggleForm();

                                    // Tải lại danh sách địa chỉ nếu cần (Ví dụ: fetchAddresses(khachHangId))
                                    const khachHangId = document.getElementById("khachHangId").value; // Lấy ID khách hàng (nếu cần)
                                    fetchAddresses(khachHangId); // Gọi hàm lấy lại địa chỉ của khách hàng
                                });
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                Swal.fire({
                                    title: 'Lỗi!',
                                    text: 'Đã xảy ra lỗi khi thêm địa chỉ',
                                    icon: 'error'
                                });
                            });
                    }
                });
            });
        });

        // Hàm gửi yêu cầu PUT để cập nhật địa chỉ
        async function updateAddress(event, index) {
            event.preventDefault(); // Ngừng hành động mặc định của form submit

            const form = event.target;
            const formData = new FormData(form); // Lấy dữ liệu từ form

            const addressId = formData.get('id'); // Lấy ID địa chỉ
            const diaChiCuThe = formData.get('diaChiCuThe');
            const thanhPho = formData.get('thanhPho');
            const quanHuyen = formData.get('quanHuyen');
            const phuongXa = formData.get('phuongXa');
            const ghiChu = formData.get('ghiChu');

            const updatedAddress = {
                diaChiCuThe,
                thanhPho,
                quanHuyen,
                phuongXa,
                ghiChu,
            };

            try {
                const response = await fetch(`/dia-chi/${addressId}`, {
                    method: 'PUT', // Phương thức PUT
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updatedAddress),
                });

                if (response.ok) {
                    // Nếu cập nhật thành công, bạn có thể gọi lại fetchAddresses để tải lại danh sách địa chỉ
                    Swal.fire({
                        title: 'Cập nhật thành công',
                        icon: 'success',
                    });
                    const khachHangId = document.getElementById('khachHangId').value;
                    fetchAddresses(khachHangId);
                } else {
                    throw new Error('Không thể cập nhật địa chỉ');
                }
            } catch (error) {
                Swal.fire({
                    title: 'Lỗi!',
                    text: error.message,
                    icon: 'error',
                });
            }
        }

        document.querySelectorAll(".updateKhachHang").forEach(function (form) {
            // Lưu giá trị gốc khi trang được tải
            const originalValues = {
                maKhachHang: document.getElementById("maKhachHang").value.trim(),
                hoVaTen: document.getElementById("hoVaTen").value.trim(),
                email: document.getElementById("email").value.trim(),
                soDienThoai: document.getElementById("soDienThoai").value.trim(),
                gioiTinh: document.querySelector('input[name="gioiTinh"]:checked')?.value ?? '',
                trangThai: document.getElementById("trangThai").value.trim()
            };

            form.addEventListener("submit", function (event) {
                event.preventDefault(); // Ngăn chặn hành động mặc định của submit form

                let isValid = true;
                let hasChanges = false;

                // Lấy giá trị hiện tại từ các trường input
                let maKhachHang = document.getElementById("maKhachHang").value.trim();
                let hoVaTen = document.getElementById("hoVaTen").value.trim();
                let email = document.getElementById("email").value.trim();
                let soDienThoai = document.getElementById("soDienThoai").value.trim();
                let gioiTinh = document.querySelector('input[name="gioiTinh"]:checked')?.value ?? '';
                let trangThai = document.getElementById("trangThai").value.trim();

                // Kiểm tra sự thay đổi
                hasChanges = email !== originalValues.email ||
                    soDienThoai !== originalValues.soDienThoai ||
                    maKhachHang !== originalValues.maKhachHang ||
                    hoVaTen !== originalValues.hoVaTen ||
                    gioiTinh !== originalValues.gioiTinh ||
                    trangThai !== originalValues.trangThai;

                // Xóa các thông báo lỗi trước khi kiểm tra lại
                document.querySelectorAll('.is-invalid').forEach((element) => {
                    element.classList.remove('is-invalid');
                });
                document.querySelectorAll('.invalid-feedback').forEach((element) => {
                    element.remove();
                });

                if (hoVaTen === '') {
                    let hoVaTenInput = document.getElementById("hoVaTen");
                    hoVaTenInput.classList.add('is-invalid');
                    hoVaTenInput.insertAdjacentHTML('afterend', '<div class="invalid-feedback">Vui lòng nhập họ và tên.</div>');
                    isValid = false;
                } else if (!/^[a-zA-ZÀ-Ỹà-ỹ\s]+$/.test(hoVaTen)) {
                    let hoVaTenInput = document.getElementById("hoVaTen");
                    hoVaTenInput.classList.add('is-invalid');
                    hoVaTenInput.insertAdjacentHTML('afterend', '<div class="invalid-feedback">Họ và tên không được chứa ký tự đặc biệt hoặc số.</div>');
                    isValid = false;
                }

                if (email === '') {
                    let emailInput = document.getElementById("email");
                    emailInput.classList.add('is-invalid');
                    emailInput.insertAdjacentHTML('afterend', '<div class="invalid-feedback">Vui lòng nhập email.</div>');
                    isValid = false;
                } else if (!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)) {
                    let emailInput = document.getElementById("email");
                    emailInput.classList.add('is-invalid');
                    emailInput.insertAdjacentHTML('afterend', '<div class="invalid-feedback">Email sai định dạng! Vui lòng nhập lại.</div>');
                    isValid = false;
                }

                if (soDienThoai === '') {
                    let soDienThoaiInput = document.getElementById("soDienThoai");
                    soDienThoaiInput.classList.add('is-invalid');
                    soDienThoaiInput.insertAdjacentHTML('afterend', '<div class="invalid-feedback">Vui lòng nhập số điện thoại.</div>');
                    isValid = false;
                } else if (!/^[0-9]{10,15}$/.test(soDienThoai)) {
                    let soDienThoaiInput = document.getElementById("soDienThoai");
                    soDienThoaiInput.classList.add('is-invalid');
                    soDienThoaiInput.insertAdjacentHTML('afterend', '<div class="invalid-feedback">Số điện thoại sai định dạng! Vui lòng nhập lại (10-15 chữ số).</div>');
                    isValid = false;
                }

                if (!gioiTinh) {
                    let gioiTinhInputs = document.querySelectorAll('input[name="gioiTinh"]');
                    gioiTinhInputs.forEach(input => {
                        input.parentElement.classList.add('is-invalid');
                    });
                    document.querySelector('form').insertAdjacentHTML('beforeend', '<div class="invalid-feedback">Vui lòng chọn giới tính.</div>');
                    isValid = false;
                }

                // Nếu không có thay đổi
                if (!hasChanges) {
                    Swal.fire({
                        title: 'Thông báo!',
                        text: 'Bạn chưa sửa gì.',
                        icon: 'info'
                    });
                    return;
                }

                // Nếu tất cả các trường đều hợp lệ, kiểm tra trùng lặp mã khách hàng, email và số điện thoại
                if (isValid) {
                    let maKhachHangChanged = maKhachHang !== originalValues.maKhachHang;
                    let emailChanged = email !== originalValues.email;
                    let phoneChanged = soDienThoai !== originalValues.soDienThoai;

                    // Kiểm tra trùng lặp nếu mã khách hàng, email hoặc số điện thoại thay đổi
                    Promise.all([
                        maKhachHangChanged ? fetch(`/quan-ly-khach-hang/kiem-tra-ma-khach-hang?maKhachHang=${encodeURIComponent(maKhachHang)}`).then(response => response.json()) : Promise.resolve(false),
                        emailChanged ? fetch(`/quan-ly-khach-hang/kiem-tra-email?email=${encodeURIComponent(email)}`).then(response => response.json()) : Promise.resolve(false),
                        phoneChanged ? fetch(`/quan-ly-khach-hang/kiem-tra-so-dien-thoai?soDienThoai=${encodeURIComponent(soDienThoai)}`).then(response => response.json()) : Promise.resolve(false)
                    ]).then(([maKhachHangExists, emailExists, soDienThoaiExists]) => {
                        if (!maKhachHangExists && !emailExists && !soDienThoaiExists) {
                            // Hiển thị hộp thoại xác nhận
                            Swal.fire({
                                title: 'Xác nhận',
                                text: 'Bạn chắc chắn muốn cập nhật thông tin này không?',
                                icon: 'question',
                                showCancelButton: true,
                                confirmButtonText: 'Yes',
                                cancelButtonText: 'Cancel',
                                reverseButtons: true
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    // Gửi yêu cầu AJAX để cập nhật thông tin khách hàng
                                    fetch(this.action, {
                                        method: 'POST',
                                        body: new FormData(this)
                                    })
                                        .then(response => response.text())
                                        .then(text => {
                                            Swal.fire({
                                                title: 'Thành công!',
                                                text: text,
                                                icon: 'success'
                                            }).then(() => {
                                                window.location.reload(); // Tải lại trang sau khi cập nhật thành công
                                            });
                                        })
                                        .catch(error => {
                                            console.error('Error:', error);
                                            Swal.fire({
                                                title: 'Lỗi!',
                                                text: 'Đã xảy ra lỗi khi cập nhật thông tin.',
                                                icon: 'error'
                                            });
                                        });
                                }
                            });
                        } else {
                            let errorMessage = '';
                            if (maKhachHangExists) errorMessage += 'Mã khách hàng đã tồn tại. ';
                            if (emailExists) errorMessage += 'Email đã tồn tại. ';
                            if (soDienThoaiExists) errorMessage += 'Số điện thoại đã tồn tại.';
                            Swal.fire({
                                title: 'Lỗi!',
                                text: errorMessage,
                                icon: 'error'
                            });
                        }
                    });
                }
            });
        });

    </script>
</div>
</body>
</html>
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:include="~{fragment/head :: head}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
    /* Hover màu xanh cho tất cả các dòng */
    .active-row {
        background-color: #14e34a; /* Màu nền khi được chọn */
    }

    .form-group label {
        font-weight: bold;
    }

    .form-group input {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
    }

    .row {
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    h5.text-primary {
        color: #007bff;
        margin-top: 20px;
    }

    .col-lg-3-dich-vu {
        flex: 0 0 auto;
        width: 30%;
    }

    h5.card-title {
        color: #28a745;
    }

    .text-center {
        text-align: center;
    }

    .hidden-field {
        display: none;
    }

    .form-group label {
        font-weight: bold;
    }

    .form-group input {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
    }

    .row {
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    /*#dichVuDaThueContainer {*/
    /*    padding: 20px; !* Padding cho container *!*/
    /*    max-height: 400px; !* Chiều cao tối đa cho container *!*/
    /*    overflow-y: auto; !* Thêm thanh cuộn dọc khi vượt quá chiều cao *!*/
    /*    border: 1px solid #dee2e6; !* Viền cho container *!*/
    /*    border-radius: 10px; !* Bo tròn góc *!*/
    /*    width: 250px; !* Chiều rộng cho container *!*/
    /*    height: 300px; !* Chiều cao cho container *!*/
    /*}*/

    #colTest {
        display: flex;
        flex-direction: column;
    }

    .card-body {
        flex: 1;
    }

    .d-flex {
        flex-wrap: wrap;
    }

    #dichVuDaThueContainer {
        flex: 0 0 250px; /* Set width to 250px */
    }


    #dichVuThueList {
        overflow-y: auto;
        padding: 10px;
    }


    /*#colTest {*/
    /*    display: flex;*/
    /*    flex-direction: column;*/
    /*    height: 250px; !* Set height to 330px *!*/
    /*}*/

    /*.card-body {*/
    /*    flex: 1;*/
    /*}*/

    /*.d-flex {*/
    /*    flex-wrap: wrap;*/
    /*}*/

    /*#dichVuDaThueContainer {*/
    /*    flex: 0 0 250px; !* Set width to 250px *!*/
    /*}*/

    /*#dichVuThueList {*/
    /*    overflow-y: auto; !* Enable vertical scrolling if content overflows *!*/
    /*    padding: 10px;*/
    /*    height: calc(250px  !* Height of other elements if any *!);*/
    /*}*/

    #filter {
        padding: 8px;
        margin-right: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-size: 14px;
        color: #333;
    }

</style>
<body class="vertical light">
<div class="wrapper">
    <div th:include="~{fragment/navbar :: navbar}"></div>
    <div th:include="~{fragment/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <main class="main-content" role="main">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <h2 class="page-title">Đặt lịch</h2>
                </div>
            </div>

            <div class="row mt-4" id="content-dat-lich">
                <!--Phần NỘI DUNG trái-->
                <div class="col-md-7">
                    <!--Phần trên bên trái-->
                    <div class="row">
                        <!-- Phần Danh Sách Hóa Đơn -->
                        <div class="col-12 mb-3">
                            <div class="card shadow h-100">
                                <div class="card-body">
                                    <h5 class="card-title text-success">Danh sách hóa đơn</h5>
                                    <!-- Tìm kiếm -->
                                    <div class="toolbar row mb-3 mt-3">
                                        <div class="col-md-12">
                                            <form class="form-inline" id="filterForm"
                                                  style="display: flex; align-items: center;">
                                                <label class="me-2" for="search">Tìm kiếm</label>
                                                <input class="form-control me-2" id="search"
                                                       placeholder="Tìm kiếm theo mã hóa đơn, số điện thoại, tên, email khách hàng,..."
                                                       style="width: 400px;" type="text">
                                                <button class="btn btn-primary me-2" onclick="resetFilters('search')"
                                                        type="button">
                                                    <span class="fe fe-refresh-ccw"></span>
                                                </button>
                                                <button class="btn btn-warning " onclick="showCheckInList()"
                                                        title="Danh sách sân check-in" type="button">
                                                    <span class="fe fe-grid"></span>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                    <!-- Hiển thị bảng -->
                                    <table class="table mt-2">
                                        <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Mã</th>
                                            <th>Tên KH</th>
                                            <th>SDT</th>
                                            <th>Email</th>
                                            <th>Sân ca</th>
                                            <th>Thời gian</th>
                                            <th>Ngày đặt lịch</th>
                                            <th>Hành động</th>
                                        </tr>
                                        </thead>
                                        <tbody id="dang-hoat-dong-table">
                                        <!-- Dữ liệu bảng -->
                                        </tbody>
                                    </table>
                                    <div class="pagination-container mt-3 d-flex justify-content-end align-items-center"
                                         id="pagination-container">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--End-->

                    <!--Phần dưới bên trái-->

                    <div class="row" id="colTest">
                        <div class="col-12">
                            <div class="card shadow">
                                <div class="card-body">
                                    <!-- Tiêu đề của box -->
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5>Dịch Vụ Đã Thuê</h5>
                                        <button class="btn btn-outline-success" title="Thêm dịch vụ" type="button"
                                                id="openServiceModal">
                                            <span class="fe fe-plus"></span>
                                        </button>
                                    </div>
                                    <div id="dichVuDaThueContainer" class="mt-4">
                                        <div id="dichVuThueList" class="row"
                                             style="max-height: 600px; overflow-y: auto;">
                                            <div class="col-12">
                                                <!-- Nội dung dịch vụ đã thuê sẽ ở đây -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--End-->
                </div>

                <!--Modal dịch vụ-->
                <div class="modal fade" id="serviceModal" tabindex="-1" role="dialog"
                     aria-labelledby="serviceModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl" role="document">
                        <div class="modal-content">
                            <div class="modal-header bg-warning">
                                <h5 class="modal-title" id="serviceModalLabel">Thêm Dịch Vụ</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <ul class="nav nav-tabs flex" id="serviceTabs" role="tablist">
                                    <li class="nav-item flex-grow-1">
                                        <a class="nav-link active" id="tab1" data-toggle="tab" href="#doThueTab"
                                           role="tab">Đồ Thuê</a>

                                    </li>
                                    <li class="nav-item flex-grow-1">
                                        <a class="nav-link" id="tab2" data-toggle="tab" href="#nuocUongTab" role="tab">Nước
                                            Uống</a>
                                    </li>
                                </ul>
                                <input type="text" class="form-control search-input" placeholder="Tìm kiếm">
                                <div id="selectedServices"></div> <!-- Div để hiển thị dịch vụ đã chọn -->

                                <div class="tab-content" id="serviceTabContent"
                                     style="max-height: 600px; overflow-y: auto;">
                                    <div class="tab-pane fade show active row" id="doThueTab" role="tabpanel">
                                        <div class="search-results"></div>
                                    </div>
                                    <div class="tab-pane fade row" id="nuocUongTab" role="tabpanel">
                                        <div class="search-results"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Phần Tabs và Nội dung Tabs bên phải -->
                <div class="col-md-5">
                    <div class="card shadow h-100">
                        <div class="card-body">
                            <!-- Tiêu đề của box -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <!-- Tiêu đề của box -->
                                <h4 class="card-title text-success mb-3">Thông tin hóa đơn</h4>
                                <!-- Khung chứa các nút nằm bên phải -->
                                <div class="d-flex">
                                    <!-- Nút Thêm hóa đơn -->
                                    <button id="addInvoiceButton" class="btn btn-outline-primary me-2"
                                            title="Thêm hóa đơn"
                                            type="button">
                                        <span class="fe fe-plus"></span>
                                    </button>
                                </div>
                            </div>
                            <!-- Phần Nội dung Tabs nằm bên dưới -->
                            <div class="tab-content" id="tabContentRight">
                                <!-- Nội dung các tab sẽ được tạo động tại đây -->
                                <form id="paymentForm">
                                    <div class="row">
                                        <div class="col-md-6" hidden>
                                            <div class="form-group mb-3">
                                                <label for="id">ID</label>
                                                <input type="text" id="id" class="form-control" readonly>
                                            </div>
                                            <div class="form-group mb-3" hidden>
                                                <label for="idHoaDon">ID Hóa đơn</label>
                                                <input type="text" id="idHoaDon" class="form-control" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6" hidden>
                                            <div class="form-group mb-3">
                                                <label for="maHoaDon">Mã hóa đơn</label>
                                                <input type="text" id="maHoaDon" class="form-control" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6" hidden>
                                            <div class="form-group mb-3">
                                                <label for="maHoaDonChiTiet">Mã hóa đơn chi tiết</label>
                                                <input type="text" id="maHoaDonChiTiet" class="form-control" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Tên Khách Hàng -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="hoVaTenKhachHang">Tên khách hàng</label>
                                                <input type="text" id="hoVaTenKhachHang" class="form-control" readonly>
                                                <input type="text" id="idKhachHang" class="form-control" readonly
                                                       hidden>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="soDienThoaiKhachHang">Số Điện Thoại</label>
                                                <input class="form-control" id="soDienThoaiKhachHang" type="text"
                                                       readonly placeholder="Chưa có dữ liệu">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6" hidden>
                                            <div class="form-group mb-3">
                                                <label for="trangThai">Trạng thái</label>
                                                <input class="form-control" id="trangThai" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="form-group mb-3">
                                                <label for="tenSanBong">Tên sân</label>
                                                <input class="form-control" id="tenSanBong" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="thoiGianBatDauCa">Thời gian bắt đầu</label>
                                                <input class="form-control" id="thoiGianBatDauCa" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="thoiGianKetThucCa">Thời gian kết thúc</label>
                                                <input class="form-control" id="thoiGianKetThucCa" type="text" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="ngayTaoHoaDon">Ngày tạo hóa đơn</label>
                                                <input class="form-control" id="ngayTaoHoaDon" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="ngayDenSan">Ngày check-in</label>
                                                <input class="form-control" id="ngayDenSan" type="text" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="tienSan">Giá sân</label>
                                                <input class="form-control" id="tienSan" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="tienCoc">Tiền cọc Sân</label>
                                                <input class="form-control" id="tienCoc" type="text" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="giaDichVu">Giá dịch Vụ</label>
                                                <input class="form-control" id="giaDichVu" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-3">
                                                <label for="tienPhuPhi">Tiền phụ Phí</label>
                                                <input class="form-control" id="tienPhuPhi" type="text" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group mb-3">
                                                <label for="phuPhiSelect">Phụ phí hóa đơn</label>
                                                <div class="input-group mb-3">
                                                    <!-- Dropdown danh sách phụ phí -->
                                                    <select id="phuPhiSelect" class="form-control">
                                                        <option value="">Chưa có phụ phí hóa đơn !!!</option>
                                                    </select>
                                                    <button class="btn btn-outline-success" type="button"
                                                            id="btnAddPhuPhi">+
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="form-group mb-3">
                                                <label for="tongTien">Tổng tiền</label>
                                                <input class="form-control" id="tongTien" type="text" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-12">
                                            <h4 class="text-success">Thanh Toán</h4>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label for="phieuGiamGia">Phiếu Giảm Giá</label>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="form-group mb-3">
                                                <div class="input-group mb-3">
                                                    <input class="form-control" id="phieuGiamGia" type="text"
                                                           placeholder="Phiếu Giảm Giá" readonly>
                                                    <button class="btn btn-outline-success" id="btnShowModal"
                                                            type="button" title="Chọn phiếu giảm giá">+
                                                    </button>
                                                </div>
                                                <input class="form-control" id="idPhieuGiamGia" hidden type="text"
                                                       placeholder="Phiếu Giảm Giá" readonly>
                                                <input class="form-control" id="idPhieuGiamGiaChiTiet" hidden type="text"
                                                       placeholder="Phiếu Giảm Giá" readonly>
                                                <input class="form-control" id="soLuongPhieuGiamGia" hidden type="text"
                                                       placeholder="Phiếu Giảm Giá" readonly>
                                                <input class="form-control" id="trangThaiPhieuGiamGia" hidden type="text"
                                                       placeholder="Phiếu Giảm Giá" readonly>
                                            </div>
                                        </div>
                                    </div>


                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label for="tienGiam">Số tiền giảm</label>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="form-group mb-3">
                                                <div class="input-group mb-3">
                                                    <input class="form-control" id="tienGiam" type="text"
                                                           placeholder="Số tiền giảm" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label for="tongTienPhaiTra">Tổng tiền phải trả:</label>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="form-group mb-3">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="tongTienPhaiTra"
                                                           readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label for="tienKhachDua">Tiền khách đưa</label>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="form-group mb-3">
                                                <div class="input-group mb-3">
                                                    <!--     nút mở modal-->
                                                    <div class="form-group mb-3"
                                                         style="display: flex;align-items: center">
                                                        <button type="button" class="btn-outline-warning"
                                                                style="display: flex; align-items: center; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;"
                                                                data-toggle="modal" data-target="#exampleModal"
                                                                title="Tiền khách đưa" id="btnTienKhachDua">
                                                            <i class="fas fa-credit-card"
                                                               style="margin-right: 5px;"></i>
                                                        </button>
                                                        <input type="text" style="margin-left: 82px"
                                                               class="form-control" id="tienKhachDua" readonly>
                                                    </div>
                                                </div>
                                                <!-- ket thuc nut modal-->
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="form-group mb-3">
                                                <label for="tienTraLai">Tiền trả lại</label>
                                            </div>
                                        </div>
                                        <div class="col-md-8">
                                            <div class="form-group mb-3">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="tienTraLai" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--         Modal-->
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-12 text-center">
                                            <button class="btn btn-success" type="button"
                                                    onclick="thanhToan()" id="thanhToanHoaDon">Thanh toán
                                            </button>
                                        </div>
                                    </div>

                                </form>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!--    Modal table check-in-->
    <div class="modal fade" id="checkInListModal" tabindex="-1"
         aria-labelledby="checkInListModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="checkInListModalLabel">Danh Sách Sân Chờ Nhận</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Input tìm kiếm -->
                    <div class="mb-3 d-flex">
                        <input type="text" id="checkInSearch" class="form-control me-2"
                               placeholder="Tìm kiếm theo mã hóa đơn, số điện thoại, tên, email khách hàng,..."
                               style="width: 400px;">
                        <button class="btn btn-primary me-2" onclick="resetFilters('checkInSearch')"
                                type="button">
                            <span class="fe fe-refresh-ccw"></span>
                        </button>
                    </div>
                    <table class="table ">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Mã</th>
                            <th>Tên KH</th>
                            <th>SDT</th>
                            <th>Email</th>
                            <th>Sân ca</th>
                            <th>Thời gian</th>
                            <th>Ngày đặt lịch</th>
                            <th>Hành động</th>
                        </tr>
                        </thead>
                        <tbody id="checkInListTable">
                        <!-- Nội dung sẽ được điền ở đây -->
                        </tbody>
                    </table>
                    <div id="modal-pagination-container"
                         class="d-flex justify-content-end align-items-center mt-3"></div>
                </div>
            </div>
        </div>
    </div>
    <!--    End Modal-->

    <!-- Modal để thêm phụ phí -->
    <div id="phuPhiModal" class="modal fade" tabindex="-1"
         aria-labelledby="phuPhiModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="phuPhiModalLabel">Thêm Phụ Phí</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="phuPhiForm">
                        <div class="form-group mb-3">
                            <label for="tenPhuPhi">Tên Phụ Phí</label>
                            <input type="text" id="tenPhuPhi" class="form-control"
                                   placeholder="Tên Phụ Phí">
                            <div id="errorTenPhuPhi" class="text-danger" style="display: none;">Vui lòng nhập tên phụ
                                phí.
                            </div> <!-- Thông báo lỗi -->

                        </div>
                        <div class="form-group mb-3">
                            <label for="giaPhuPhi">Giá Phụ Phí</label>
                            <div class="input-group">
                                <input type="number" id="giaPhuPhi" class="form-control"
                                       placeholder="0">
                                <span class="input-group-text">VND</span>
                            </div>
                            <div id="errorGiaPhuPhi" class="text-danger" style="display: none;">Vui lòng nhập giá phụ
                                phí.
                            </div> <!-- Thông báo lỗi -->
                        </div>
                        <button type="button" class="btn btn-success" id="btnThemPhuPhi">
                            Thêm Phụ Phí
                        </button>
                    </form>
                    <table class="table mt-3">
                        <thead>
                        <tr>
                            <th>#</th>
                            <th>Tên Phụ Phí</th>
                            <th>Giá Phụ Phí</th>
                            <th>Chọn</th>
                        </tr>
                        </thead>
                        <tbody id="phuPhiList">
                        <tr>
                            <!--                                Hiển thị phụ phí hóa đơn-->
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!--    End Modal-->
    <!--    Modal chọn phiếu giảm giá-->
    <!-- Modal -->
    <div class="modal fade" id="modalPhieuGiamGia" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLabel">Chọn Phiếu Giảm Giá</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Search bar -->
                    <div class="mb-3">
                        <input type="text" class="form-control" id="searchPhieuGiamGia"
                               placeholder="Tìm kiếm phiếu giảm giá">
                    </div>
                    <!-- Table -->
                    <table class="table table-bordered">
                        <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã Phiếu Giảm Giá</th>
                            <th>Tên Phiếu Giảm Giá</th>
                            <th>Loại</th>
                            <th>Mức giảm</th>
                            <th>Giá trị tối đa</th>
<!--                            <th>Số Lượng</th>-->
                            <th>Hành Động</th>
                        </tr>
                        </thead>
                        <tbody id="tablePhieuGiamGiaBody">
                        <!-- Dữ liệu sẽ được thêm bởi JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <div id="pagination" class="d-flex justify-content-center"></div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="khongApDungPGG">Không áp dụng</button>
                </div>
            </div>
        </div>
    </div>
    <!--    End-->
    <!--    Modal để thực hiện hình thức thanh toán-->
    <div class="modal fade" id="exampleModal" tabindex="-1"
         aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #198754; color: white">
                    <h3 class="modal-title" id="exampleModalLabel"
                        style="text-align: center ;flex: 1">Thanh toán</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!--Nội dung của Modal-->
                    <div style="align-items: center;justify-content: center;">
                        <div style="display: flex;margin-bottom: 10px">
                            <label style="flex:1"><h5>Tổng tiền hàng</h5></label>
                            <h5 id="tongTienHang" style="float: right"></h5>
                            <h5>VND</h5>
                        </div>
                        <div style="display: flex;justify-content: center; margin-bottom: 10px">
                            <button type="button" id="btnChuyenKhoan" class="btn btn-outline-success"
                                    style="margin-right: 5px;" data-id-hinh-thuc-thanh-toan="1">
                                Chuyển khoản <i class="fas fa-university" style="margin-left: 5px"></i>
                            </button>
                            <!-- Nút Tiền mặt -->
                            <button type="button" id="btnTienMat" class="btn btn-outline-success"
                                    data-id-hinh-thuc-thanh-toan="2">
                                Tiền mặt <i class="fas fa-money-bill-wave" style="margin-left: 5px"></i>
                            </button>
                        </div>
                        <div style="margin-bottom: 10px">
                            <label for="khachDua" style="font-weight: bold;">Tiền
                                khách đưa:</label>
                            <div style="display: flex">
                                <div id="khachDuaDiv">
                                    <input type="number"
                                           id="khachDua"
                                           class="form-control"
                                           placeholder="Nhập tiền khách đưa"
                                           style="border: none; border-bottom: 2px solid #007bff; outline: none; box-shadow: none;  ">
                                    <div id="errorTienKhachDua" style="color: red; display: none;">Tiền khách đưa không
                                        hợp lệ!
                                    </div>
                                </div>
                                <div id="maGDDiv" style=" display: none">
                                    <input type="text"
                                           id="maGD"
                                           class="form-control"
                                           placeholder="Mã giao dịch"
                                           style="border: none; border-bottom: 2px solid #007bff; outline: none; box-shadow: none;">
                                    <div id="errorMaGD" style="color: red; display: none;">Vui lòng nhập mã giao dịch!
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div style="margin-bottom: 60px; margin-top: 60px">
                            <table class="table table-hover">
                                <thead>

                                <th>STT</th>
                                <th>Mã giao dịch</th>
                                <th>Phương thức</th>
                                <th>Số tiền</th>
                                <th>Hành động</th>

                                </thead>
                                <tbody id="tbodyCTHTTT">
                                <tr>
                                    <td style=" text-align: center" colspan="5">Chưa có thông tin</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div style="display: flex">
                            <label style="flex:1"><h5>Tiền còn thiếu</h5></label>
                            <h5 id="tienConThieu" style="float: right"></h5>
                            <h5>VND</h5>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success" id="btnXacNhanThanhToan">Xác nhận</button>
                </div>
            </div>
        </div>
    </div>
    <!--    End-->
    <div th:include="~{fragment/modal :: modal}"></div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
<script th:include="~{fragment/script :: script}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>

    $(document).ready(function () {
        $('#addInvoiceButton').on('click', function () {
            // Thay toàn bộ nội dung của trang bằng URL mới
            window.location.href = 'http://localhost:8080/list-san-ca';
        });
    });

    //Hàm thông báo
    function showSuccessToast(message) {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            style: {
                background: "#4CAF50",
            },
            stopOnFocus: true
        }).showToast();
    }

    function showErrorToast(message) {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "center",
            style: {
                background: "#f44336",
            },
            stopOnFocus: true
        }).showToast();
    }

    //Nút reset
    function resetFilters(inputId) {
        const inputElement = document.getElementById(inputId);
        if (inputElement) {
            inputElement.value = ''; // Xóa nội dung trong ô input
        }

        // Kiểm tra xem đang reset ở bảng "Đang hoạt động" hay modal "Chờ nhận sân"
        if (inputId === 'search') {
            fetchData(0, '', "Đang hoạt động", 'dang-hoat-dong-table', 'pagination-container', false);
        } else if (inputId === 'checkInSearch') {
            fetchData(0, '', "Chờ nhận sân", 'checkInListTable', 'modal-pagination-container', true);
        }
    }

    let selectedInvoiceId = null; // Biến lưu trữ ID hóa đơn chi tiết được chọn

    // Lắng nghe sự kiện click trên bảng "Đang Hoạt Động"
    document.addEventListener('DOMContentLoaded', function () {
        // Disable tất cả các ô input trong form
        const formElements = document.querySelectorAll('#paymentForm input');
        formElements.forEach(element => {
            element.disabled = true;  // Disable tất cả các input
        });

        // Disable button thanh toán
        document.getElementById('thanhToanHoaDon').disabled = true;
        document.getElementById('btnAddPhuPhi').disabled = true;
        document.getElementById('btnTienKhachDua').disabled = true;
        document.getElementById('btnShowModal').disabled = true;

        // Lắng nghe sự kiện click trên bảng "Đang Hoạt Động"
        document.getElementById('dang-hoat-dong-table').addEventListener('click', async function (event) {
            const clickedRow = event.target.closest('tr'); // Lấy dòng được click
            if (clickedRow) {
                // Xóa lớp `table-active` khỏi tất cả các dòng
                const rows = document.querySelectorAll('#dang-hoat-dong-table tr');
                rows.forEach(row => row.classList.remove('table-active'));

                // Thêm lớp `table-active` vào dòng được click
                clickedRow.classList.add('table-active');

                // Lưu lại ID hóa đơn chi tiết
                selectedInvoiceId = clickedRow.getAttribute('data-id'); // Lấy ID từ data-id

                // Enable các ô input trong form
                const formElements = document.querySelectorAll('#paymentForm input');
                formElements.forEach(element => {
                    element.disabled = false;  // Enable tất cả các input
                });

                // Enable button thanh toán
                document.getElementById('thanhToanHoaDon').disabled = false;
                document.getElementById('btnAddPhuPhi').disabled = false;
                document.getElementById('btnTienKhachDua').disabled = false;
                document.getElementById('btnShowModal').disabled = false;

                // Gọi hàm để hiển thị thông tin hóa đơn bên phải
                await loadInvoiceDetails(selectedInvoiceId);
                await fillDichVuChoHoaDon(selectedInvoiceId);

                // Gọi hàm để cập nhật tiền khách đưa (bảng chi tiết hình thức thanh toán)
                await loadChiTietHTTTTable(selectedInvoiceId);  // Lấy tổng tiền từ bảng chi tiết thanh toán
                calculateBestDiscount()
                tinhTongThanhToan()

            }
        });
    });
    //End

    //Code table bên trái

    let currentPage = 0;
    let totalPages = 0;

    // Hàm fetch data từ server và hiển thị ra bảng
    async function fetchData(page = 0, keyWord = '', trangThai = "Đang hoạt động", tableBodyId = 'dang-hoat-dong-table', paginationContainerId = 'pagination-container', isModal = false) {
        try {
            const pageSize = 5;
            const url = `http://localhost:8080/hoa-don-chi-tiet/trang-thai?trangThai=${encodeURIComponent(trangThai)}&page=${page}&size=${pageSize}&keyWord=${encodeURIComponent(keyWord)}`;

            const response = await fetch(url);
            const data = await response.json();

            currentPage = data.number;
            totalPages = data.totalPages;

            const tableBody = document.getElementById(tableBodyId);
            if (!tableBody) return;

            tableBody.innerHTML = ''; // Xóa nội dung cũ của bảng

            // Lấy thông số thời gian check-in
            const checkInParam = await fetchCheckInTimeParam();
            const {value: maxTime, type: timeUnit} = checkInParam;

            const currentTime = new Date();
            const currentTotalMinutes = currentTime.getHours() * 60 + currentTime.getMinutes();

            // Hiển thị dữ liệu trong bảng
            if (Array.isArray(data.content) && data.content.length > 0) {
                for (const item of data.content) {
                    const index = data.content.indexOf(item);
                    const thoiGianBatDau = new Date(item.thoiGianBatDauCa);
                    const thoiGianKetThuc = new Date(item.thoiGianKetThucCa);

                    const startTotalMinutes = thoiGianBatDau.getHours() * 60 + thoiGianBatDau.getMinutes();

                    // Tính toán chênh lệch thời gian
                    let timeDifference = currentTotalMinutes - startTotalMinutes;

                    // Chuyển đổi tham số thành phút
                    const maxTimeInMinutes =
                        timeUnit === 'Phút' ? maxTime :
                            timeUnit === 'Giờ' ? maxTime * 60 :
                                timeUnit === 'Ngày' ? maxTime * 24 * 60 : 0;
                    if (item.trangThai === 'Chờ nhận sân' && isModal && timeDifference > maxTimeInMinutes) {
                        try {
                            const response = await fetch(`http://localhost:8080/hoa-don-chi-tiet/huy/${item.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({trangThai: 'Đã hủy'}),
                            });


                        } catch (error) {

                        }
                        continue; // Bỏ qua các hóa đơn đã hủy
                    }


                    const row = document.createElement('tr');
                    row.setAttribute('data-id', item.id);
                    row.innerHTML = `
                    <td>${index + 1 + (page * pageSize)}</td>
                    <td>${item.maHoaDonChiTiet || ''}</td>
                    <td>${item.hoVaTenKhachHang || ''}</td>
                    <td>${item.soDienThoaiKhachHang || ''}</td>
                    <td>${item.emailKhachHang || ''}</td>
                    <td>${item.tenSanBong || ''}</td>
                    <td>${thoiGianBatDau.toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    })} - ${thoiGianKetThuc.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</td>
                    <td>${item.ngayDenSan || ''}</td>
                    ${trangThai === "Chờ nhận sân" && isModal ? `<td>
                        <button class="btn btn-outline-success check-in-btn" title="Check in" onclick="checkIn('${item.id}')">
                            <span class="fe fe-check-circle"></span>
                        </button>
                    </td>` : ''}
                `;
                    tableBody.appendChild(row);
                }
            } else {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="9" class="text-center">Không có dữ liệu</td>`;
                tableBody.appendChild(emptyRow);
            }

            // Cập nhật phân trang
            if (paginationContainerId) {
                updatePagination(currentPage, totalPages, keyWord, trangThai, tableBodyId, paginationContainerId, isModal);
            }
            // Ẩn cột "Hành động" nếu không phải trạng thái "Chờ nhận sân"
            if (!isModal) {
                const actionColumn = document.querySelector(`table thead th:nth-child(9)`);
                if (actionColumn) {
                    actionColumn.style.display = trangThai === "Chờ nhận sân" ? '' : 'none';
                }
            }

        } catch (error) {
        }
    }

    // Hàm cập nhật phân trang
    function updatePagination(currentPage, totalPages, keyWord, trangThai, tableBodyId, paginationContainerId, isModal) {
        const paginationContainer = document.getElementById(paginationContainerId);
        if (!paginationContainer) return;

        paginationContainer.innerHTML = ''; // Xóa nội dung cũ

        // Nút Previous
        if (currentPage > 0) {
            const prevButton = document.createElement('button');
            prevButton.className = 'btn btn-success me-2';
            prevButton.textContent = '<';
            prevButton.onclick = () => {
                fetchData(currentPage - 1, keyWord, trangThai, tableBodyId, paginationContainerId, isModal);
            };
            paginationContainer.appendChild(prevButton);
        }

        // Hiển thị số trang hiện tại
        const pageDisplay = document.createElement('span');
        pageDisplay.className = 'btn btn-outline-secondary';
        pageDisplay.textContent = `Trang ${currentPage + 1}`;
        paginationContainer.appendChild(pageDisplay);

        // Nút Next
        if (currentPage < totalPages - 1) {
            const nextButton = document.createElement('button');
            nextButton.className = 'btn btn-success ms-2';
            nextButton.textContent = '>';
            nextButton.onclick = () => {
                fetchData(currentPage + 1, keyWord, trangThai, tableBodyId, paginationContainerId, isModal);
            };
            paginationContainer.appendChild(nextButton);
        }
    }


    document.getElementById('search').addEventListener('input', function () {
        const searchValue = this.value.trim();
        fetchData(0, searchValue, "Đang hoạt động", 'dang-hoat-dong-table', 'pagination-container', false);
    });

    // Gọi hàm fetchData ban đầu
    document.addEventListener('DOMContentLoaded', () => {
        fetchData(0, '', "Đang hoạt động", 'dang-hoat-dong-table', 'pagination-container', false);
    });

    //End table Đang hoạt động

    //Code modal chờ nhận sân

    function showCheckInList() {
        fetchData(0, '', "Chờ nhận sân", 'checkInListTable', 'modal-pagination-container', true);
        const checkInListModal = new bootstrap.Modal(document.getElementById('checkInListModal'));
        checkInListModal.show();
    }

    document.getElementById('checkInSearch').addEventListener('input', function () {
        const searchValue = this.value.trim();
        fetchData(0, searchValue, "Chờ nhận sân", 'checkInListTable', 'modal-pagination-container', true);
    });

    //Nút check-in trong modal
    async function checkIn(id) {
        try {
            // Hiển thị SweetAlert để xác nhận
            const result = await Swal.fire({
                title: 'Xác nhận',
                text: "Bạn có chắc chắn muốn check-in không?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Có',
                cancelButtonText: 'Không'
            });

            // Nếu người dùng hủy bỏ, thoát khỏi hàm
            if (!result.isConfirmed) {
                return;
            }

            // Gửi yêu cầu API để cập nhật trạng thái
            const response = await fetch(`http://localhost:8080/hoa-don-chi-tiet/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({trangThai: 'Đang hoạt động'})
            });

            // Hiển thị thông báo thành công
            showSuccessToast('Check-in thành công.');

            // Tắt modal
            const checkInListModal = bootstrap.Modal.getInstance(document.getElementById('checkInListModal'));
            checkInListModal.hide();

            // Làm mới bảng dữ liệu "Đang hoạt động"
            fetchData(0, '', "Đang hoạt động", 'dang-hoat-dong-table', 'pagination-container', false);

        } catch (error) {
            // console.error('Error during check-in:', error);
            // showErrorToast('Có lỗi xảy ra khi check-in.');
        }
    }

    //Code phần phụ phí

    // Hàm gọi API để lấy tiền phụ phí từ API và hiển thị lên ô input
    async function fetchTienPhuPhi(invoiceId) {
        try {
            const response = await fetch(`http://localhost:8080/api/phu-phi-hoa-don/${invoiceId}`);
            if (!response.ok) {
                throw new Error('Không thể lấy dữ liệu phụ phí.');
            }

            const data = await response.json();

            // Kiểm tra nếu có phụ phí trong mảng và lấy tổng tiền phụ phí
            if (Array.isArray(data) && data.length > 0) {
                return data.reduce((total, phuPhi) => total + phuPhi.tienPhuPhi, 0); // Tính tổng tiền phụ phí
            } else {
                return 0; // Nếu không có phụ phí, trả về 0
            }

        } catch (error) {
            return 0; // Nếu có lỗi, trả về 0
        }
    }

    // Hàm tải các phụ phí có sẵn và hiển thị trong modal
    async function loadAvailablePhuPhi(invoiceId) {
        try {
            const response = await fetch(`http://localhost:8080/api/phu-phi-hoa-don/${invoiceId}`);
            if (!response.ok) {
                throw new Error('Không thể tải danh sách phụ phí.');
            }
            const data = await response.json();

            // Xử lý dropdown "Phụ phí hóa đơn"
            const phuPhiSelect = document.getElementById('phuPhiSelect');
            phuPhiSelect.innerHTML = ''; // Xóa các option cũ trong dropdown

            if (data.length > 0) {
                // Thêm các phụ phí vào dropdown
                data.forEach(phuPhi => {
                    const option = document.createElement('option');
                    option.value = phuPhi.id;
                    option.textContent = `${phuPhi.ten} - ${phuPhi.tienPhuPhi.toLocaleString()} VND`;
                    phuPhiSelect.appendChild(option);
                });
            } else {
                // Nếu không có phụ phí, hiển thị thông báo
                phuPhiSelect.innerHTML = '<option value="">Không có phụ phí nào</option>';
            }

            // Hiển thị các phụ phí trong bảng trong modal
            const phuPhiList = document.getElementById('phuPhiList');
            phuPhiList.innerHTML = ''; // Xóa các hàng cũ trong bảng

            if (data.length > 0) {
                data.forEach((phuPhi, index) => {
                    // Tạo một hàng mới cho bảng phụ phí
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${phuPhi.ten}</td>
                    <td>${phuPhi.tienPhuPhi.toLocaleString()} VND</td>
                    <td>
                    <button class="btn mb-2 mr-1 btn-outline-danger" type="button" data-phuPhi-id="${phuPhi.id}" title="Xóa phụ phí">
                        <span class="fe fe-trash-2"></span>
                    </button>
                    </td>
                `;
                    phuPhiList.appendChild(row);
                    // Gắn sự kiện click cho mỗi nút "Xóa phụ phí" sau khi phần tử được thêm vào DOM
                    const deleteButton = row.querySelector('.btn-outline-danger');
                    deleteButton.addEventListener('click', function () {
                        const phuPhiId = this.getAttribute('data-phuPhi-id');
                        handleDeletePhuPhi(phuPhiId, selectedInvoiceId); // Xử lý xóa phụ phí
                    });
                });
            } else {
                // Nếu không có phụ phí, hiển thị dòng thông báo trong bảng
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" class="text-center">Không có phụ phí nào để chọn</td>`;
                phuPhiList.appendChild(row);

            }
        } catch (error) {
            // console.error(error);
            // showErrorToast('Không thể tải dữ liệu phụ phí.');
        }
    }

    // Hàm xử lý thêm phụ phí vào hóa đơn
    document.getElementById('btnThemPhuPhi').addEventListener('click', async function () {
        const tenPhuPhi = document.getElementById('tenPhuPhi').value.trim();
        const giaPhuPhi = document.getElementById('giaPhuPhi').value.trim();

        // Ẩn thông báo lỗi trước khi kiểm tra
        document.getElementById('errorTenPhuPhi').style.display = 'none';
        document.getElementById('errorGiaPhuPhi').style.display = 'none';

        let isValid = true;

        // Kiểm tra tên phụ phí
        if (!tenPhuPhi) {
            document.getElementById('errorTenPhuPhi').style.display = 'block'; // Hiển thị thông báo lỗi
            isValid = false;
        }

        // Kiểm tra giá phụ phí (phải là một số và lớn hơn 0)
        if (!giaPhuPhi || isNaN(giaPhuPhi) || parseFloat(giaPhuPhi) <= 0) {
            document.getElementById('errorGiaPhuPhi').textContent = 'Giá phụ phí không hợp lệ'; // Thông báo lỗi cụ thể
            document.getElementById('errorGiaPhuPhi').style.display = 'block'; // Hiển thị thông báo lỗi
            isValid = false;
        }

        // Nếu có lỗi, không gửi yêu cầu POST
        if (!isValid) {
            return; // Dừng thực hiện nếu có lỗi
        }

        const phuPhiData = {
            hoaDonChiTietId: selectedInvoiceId,      // ID hóa đơn chi tiết
            ten: tenPhuPhi,                  // Tên phụ phí
            tienPhuPhi: parseFloat(giaPhuPhi), // Giá phụ phí
            trangThai: "Đã thêm",         // Trạng thái
            deletedAt: false                 // Đảm bảo không bị xóa
        };

        try {
            // Gửi yêu cầu POST để thêm phụ phí
            const response = await fetch('http://localhost:8080/api/phu-phi-hoa-don/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(phuPhiData)
            });

            if (!response.ok) {
                throw new Error('Không thể thêm phụ phí.');
            }

            const data = await response.json();

            // Cập nhật lại bảng phụ phí sau khi thêm mới
            await loadAvailablePhuPhi(selectedInvoiceId);  // Chờ cập nhật bảng và dropdown

            // Lấy lại tổng tiền phụ phí và cập nhật ô input
            const totalTienPhuPhi = await fetchTienPhuPhi(selectedInvoiceId);
            document.getElementById('tienPhuPhi').value = totalTienPhuPhi.toLocaleString() + ' VND'; // Cập nhật ô input

            // Chờ dữ liệu được cập nhật rồi mới đóng modal
            $('#phuPhiModal').modal('hide'); // Đóng modal sau khi hoàn thành

            showSuccessToast('Thêm phụ phí thành công.');

            // Reset form khi modal đóng
            $('#phuPhiModal').on('hidden.bs.modal', function () {
                document.getElementById('tenPhuPhi').value = '';   // Xóa tên phụ phí
                document.getElementById('giaPhuPhi').value = '';   // Xóa giá phụ phí
                document.getElementById('errorTenPhuPhi').style.display = 'none'; // Ẩn thông báo lỗi
                document.getElementById('errorGiaPhuPhi').style.display = 'none'; // Ẩn thông báo lỗi
            });

            tinhTongThanhToan();
        } catch (error) {
            // console.error(error);
            // showErrorToast('Không thể thêm phụ phí.');
        }
    });

    // Lắng nghe sự kiện khi modal đóng (bao gồm khi ấn ra ngoài hoặc ấn nút X)
    $('#phuPhiModal').on('hidden.bs.modal', function () {
        // Reset các trường nhập liệu
        document.getElementById('tenPhuPhi').value = '';   // Xóa tên phụ phí
        document.getElementById('giaPhuPhi').value = '';   // Xóa giá phụ phí

        // Ẩn các thông báo lỗi
        document.getElementById('errorTenPhuPhi').style.display = 'none';
        document.getElementById('errorGiaPhuPhi').style.display = 'none';
    });

    // Mở modal khi nhấn nút + và hiển thị phụ phí có sẵn
    document.getElementById('btnAddPhuPhi').addEventListener('click', async function () {
        // Mở modal để thêm phụ phí
        $('#phuPhiModal').modal('show');
        // Tải danh sách phụ phí có sẵn trong modal
        await loadAvailablePhuPhi(selectedInvoiceId);  // Hàm để lấy và hiển thị danh sách phụ phí
        tinhTongThanhToan();
    });

    // Hàm xử lý xóa phụ phí
    async function handleDeletePhuPhi(phuPhiId, invoiceId) {
        try {
            // Hiển thị xác nhận xóa
            const result = await Swal.fire({
                title: 'Xác nhận',
                text: 'Bạn có chắc chắn muốn xóa phụ phí này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy'
            });

            if (!result.isConfirmed) {
                return; // Nếu người dùng hủy, không làm gì
            }

            // Gửi yêu cầu PUT để xóa phụ phí
            const response = await fetch(`http://localhost:8080/api/phu-phi-hoa-don/delete/${phuPhiId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error('Không thể xóa phụ phí.');
            }

            // Hiển thị thông báo thành công
            showSuccessToast('Xóa phụ phí thành công.');

            // Cập nhật lại bảng phụ phí và số tiền sau khi xóa
            await loadAvailablePhuPhi(invoiceId);  // Cập nhật bảng phụ phí
            const totalTienPhuPhi = await fetchTienPhuPhi(invoiceId); // Cập nhật tổng tiền phụ phí
            document.getElementById('tienPhuPhi').value = totalTienPhuPhi.toLocaleString() + ' VND'; // Cập nhật ô input
            tinhTongThanhToan();
        } catch (error) {
            // console.error(error);
            // showErrorToast('Không thể xóa phụ phí.');
        }
    }

    //End phụ phí

    // Code phần xử lý hình thức thanh toán

    // Hàm chuyển đổi từ chuỗi tiền tệ dạng "130.000 VND" thành số
    function parseCurrency(value) {
        return parseFloat(value.replace(/[^\d]/g, '')); // Loại bỏ tất cả ký tự không phải số và chuyển thành số
    }

    // Đảm bảo khi click vào nút "Tiền khách đưa" sẽ mở modal
    document.querySelectorAll('.btn-outline-warning').forEach(button => {
        button.addEventListener('click', async function () {
            const modalId = `#exampleModal`; // ID của modal
            $(modalId).modal('show'); // Mở modal
            // Reset trạng thái ban đầu của modal
            resetModalState();
            const tongTienPhaiTra = document.getElementById('tongTienPhaiTra').value.trim()
            const formattedTongTien = parseCurrency(tongTienPhaiTra).toLocaleString();
            tongTienHang.textContent = formattedTongTien;
            if (selectedInvoiceId) {
                await loadChiTietHTTTTable(selectedInvoiceId);
            }
        });
    });

    // Hàm reset trạng thái modal
    function resetModalState() {
        // Chọn nút "Tiền mặt" làm mặc định
        const chuyenKhoanButton = document.getElementById('btnChuyenKhoan');
        const tienMatButton = document.getElementById('btnTienMat');

        tienMatButton.classList.add('btn-success');
        tienMatButton.style.color = 'white';

        chuyenKhoanButton.classList.remove('btn-success');
        chuyenKhoanButton.classList.add('btn-outline-success');
        chuyenKhoanButton.style.color = '';

        // Ẩn input "Mã giao dịch"
        maGDInput(false);

        // Reset các input
        document.getElementById('khachDua').value = ''; // Reset tiền khách đưa
        document.getElementById('maGD').value = ''; // Reset mã giao dịch

        // Ẩn các thông báo lỗi
        const errorTienKhachDua = document.getElementById('errorTienKhachDua');
        const errorMaGD = document.getElementById('errorMaGD');
        if (errorTienKhachDua) errorTienKhachDua.style.display = 'none';
        if (errorMaGD) errorMaGD.style.display = 'none';
    }

    // Hàm để xử lý hiển thị/ẩn input Mã giao dịch và điều chỉnh layout khi chọn "Chuyển khoản" hoặc "Tiền mặt"
    function maGDInput(check) {
        const maGDInput = document.getElementById('maGDDiv');  // Input Mã giao dịch
        const khachDuaInput = document.getElementById('khachDuaDiv');  // Input Tiền khách đưa

        // Nếu chọn Chuyển khoản, hiển thị Mã giao dịch
        if (check) {
            maGDInput.style.display = "block";  // Hiển thị Mã giao dịch
            khachDuaInput.style.width = "50%";  // Điều chỉnh chiều rộng của "Tiền khách đưa"
        } else {
            maGDInput.style.display = "none";  // Ẩn Mã giao dịch
            khachDuaInput.style.width = "100%";  // Chiều rộng của "Tiền khách đưa" đầy đủ
        }
    }

    // Gắn sự kiện click cho các nút "Chuyển khoản" và "Tiền mặt"
    document.getElementById('btnChuyenKhoan').addEventListener('click', function () {
        // Xóa lớp "active" (btn-success) khỏi cả hai nút
        document.getElementById('btnChuyenKhoan').classList.add('btn-success');
        document.getElementById('btnChuyenKhoan').style.color = 'white';  // Thêm màu chữ trắng
        document.getElementById('btnTienMat').classList.remove('btn-success');
        document.getElementById('btnTienMat').style.color = '';  // Đặt lại màu chữ của Tiền mặt
        // Ẩn các thông báo lỗi
        const errorTienKhachDua = document.getElementById('errorTienKhachDua');
        const errorMaGD = document.getElementById('errorMaGD');
        if (errorTienKhachDua) errorTienKhachDua.style.display = 'none';
        if (errorMaGD) errorMaGD.style.display = 'none';
        // Hiển thị input mã giao dịch khi chọn "Chuyển khoản"
        maGDInput(true);
    });

    document.getElementById('btnTienMat').addEventListener('click', function () {
        // Xóa lớp "active" (btn-success) khỏi cả hai nút
        document.getElementById('btnTienMat').classList.add('btn-success');
        document.getElementById('btnTienMat').style.color = 'white';  // Thêm màu chữ trắng
        document.getElementById('btnChuyenKhoan').classList.remove('btn-success');
        document.getElementById('btnChuyenKhoan').style.color = '';  // Đặt lại màu chữ của Chuyển khoản
        // Ẩn các thông báo lỗi
        const errorTienKhachDua = document.getElementById('errorTienKhachDua');
        const errorMaGD = document.getElementById('errorMaGD');
        if (errorTienKhachDua) errorTienKhachDua.style.display = 'none';
        if (errorMaGD) errorMaGD.style.display = 'none';
        // Ẩn input mã giao dịch khi chọn "Tiền mặt"
        maGDInput(false);
    });

    // Hàm hiển thị danh sách chi tiết hình thức thanh toán lên bảng
    async function loadChiTietHTTTTable(invoiceId) {
        try {
            // Gọi API lấy danh sách chi tiết hình thức thanh toán
            const response = await fetch(`http://localhost:8080/chi-tiet-hinh-thuc-thanh-toan/find-by-id-hdct/${invoiceId}`);

            const data = await response.json();

            // Lấy bảng hiển thị danh sách
            const tbody = document.getElementById(`tbodyCTHTTT`);
            tbody.innerHTML = ''; // Xóa nội dung cũ trong bảng

            let totalAmount = 0; // Biến lưu tổng số tiền

            if (data.length > 0) {
                // Duyệt qua danh sách và thêm từng hàng vào bảng
                data.forEach((item, index) => {
                    totalAmount += item.soTien; // Cộng dồn tổng số tiền

                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.maGiaoDich || ''}</td>
                <td>${item.idHinhThucThanhToan === 1 ? 'Chuyển khoản' : 'Tiền mặt'}</td>
                <td>${item.soTien.toLocaleString('vi-VN')} VND</td>
                <td>
                    <button type="button" class="btn btn-outline-danger btnDeleteHTTT"
                            data-id="${item.id}"
                            title="Xóa">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
                    tbody.appendChild(row);
                });

                // Gắn sự kiện cho các nút "Xóa" sau khi thêm hàng
                document.querySelectorAll('.btnDeleteHTTT').forEach(button => {
                    button.addEventListener('click', async function () {
                        const htttId = this.getAttribute('data-id');
                        await deleteChiTietHTTT(htttId, selectedInvoiceId);
                    });
                });
            } else {
                // Hiển thị thông báo nếu không có dữ liệu
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="5" class="text-center"></td>`;
                tbody.appendChild(row);
            }

            // Thêm dòng tổng tiền ở cuối bảng
            const totalRow = document.createElement('tr');
            totalRow.style.fontWeight = 'bold'; // Làm nổi bật dòng tổng tiền
            totalRow.innerHTML = `
        <td colspan="3" class="text-start">Tổng cộng:</td>
        <td>${totalAmount.toLocaleString('vi-VN')} VND</td>
        <td></td>
    `;
            tbody.appendChild(totalRow);

            // Cập nhật tiền còn thiếu
            const tongTienHang = parseCurrency(document.getElementById('tongTienHang').textContent.trim());
            const tienConThieuElement = document.getElementById('tienConThieu');

            const tienConThieu = Math.max(tongTienHang - totalAmount, 0); // Đảm bảo không âm
            tienConThieuElement.textContent = tienConThieu.toLocaleString();
            // Cập nhật ô "Tiền khách đưa" bên ngoài modal
            const tienKhachDuaInput = document.getElementById('tienKhachDua');
            tienKhachDuaInput.value = totalAmount.toLocaleString('vi-VN') + ' VND';
            let tienTraLai = totalAmount - tongTienHang;
            // Kiểm tra nếu tiền trả lại < 0 thì set về 0
            if (tienTraLai < 0) {
                tienTraLai = 0;
            }
            const tienTraLaiFormatted = tienTraLai.toLocaleString() + ' VND';
            document.getElementById('tienTraLai').value = tienTraLaiFormatted;
        } catch (error) {
            // console.error(error);
            // showErrorToast('Lỗi khi tải dữ liệu chi tiết hình thức thanh toán.');
        }
    }


    // Hàm xóa chi tiết hình thức thanh toán
    async function deleteChiTietHTTT(htttId, invoiceId) {
        try {
            // Hiển thị xác nhận trước khi xóa
            const result = await Swal.fire({
                title: 'Xác nhận xóa',
                text: 'Bạn có chắc chắn muốn xóa chi tiết này?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Xóa',
                cancelButtonText: 'Hủy',
            });

            if (!result.isConfirmed) return;
            // Gửi yêu cầu xóa tới API
            const response = await fetch(`http://localhost:8080/chi-tiet-hinh-thuc-thanh-toan/xoa/${htttId}`, {
                method: 'PUT',
            });

            if (!response.ok) {
                throw new Error('Không thể xóa chi tiết hình thức thanh toán.');
            }

            // Tải lại danh sách sau khi xóa
            await loadChiTietHTTTTable(invoiceId);
            showSuccessToast('Xóa thành công.');
        } catch (error) {
            // console.error(error);
            // showErrorToast('Lỗi khi xóa chi tiết hình thức thanh toán.');
        }
    }


    //Thêm hình thức thanh toán
    document.getElementById('btnXacNhanThanhToan').addEventListener('click', async function () {
        const khachDua = document.getElementById('khachDua').value.trim();
        const maGD = document.getElementById('maGD').value.trim();
        const chuyenKhoanButton = document.getElementById('btnChuyenKhoan');
        const tienMatButton = document.getElementById('btnTienMat');

        // Xác định idHinhThucThanhToan
        let idHinhThucThanhToan = null;
        if (chuyenKhoanButton.classList.contains('btn-success')) {
            idHinhThucThanhToan = chuyenKhoanButton.getAttribute('data-id-hinh-thuc-thanh-toan');
        } else if (tienMatButton.classList.contains('btn-success')) {
            idHinhThucThanhToan = tienMatButton.getAttribute('data-id-hinh-thuc-thanh-toan');
        }

        // Lấy các ô lỗi để hiển thị thông báo
        const errorTienKhachDua = document.getElementById('errorTienKhachDua'); // Thông báo lỗi tiền khách đưa
        const errorMaGD = document.getElementById('errorMaGD'); // Thông báo lỗi mã giao dịch

        // Reset hiển thị lỗi
        if (errorTienKhachDua) errorTienKhachDua.style.display = 'none';
        if (errorMaGD) errorMaGD.style.display = 'none';

        // Validate tiền khách đưa
        let isValid = true;
        if (!khachDua || isNaN(khachDua) || parseFloat(khachDua) <= 0) {
            if (errorTienKhachDua) errorTienKhachDua.style.display = 'block'; // Hiển thị lỗi
            isValid = false;
        }

        // Validate mã giao dịch khi chọn chuyển khoản
        if (idHinhThucThanhToan === "1" && (!maGD || maGD.trim() === '')) {
            if (errorMaGD) errorMaGD.style.display = 'block'; // Hiển thị lỗi
            isValid = false;
        }

        if (!isValid) {
            return; // Dừng lại nếu không hợp lệ
        }

        // Chuẩn bị dữ liệu để gửi
        const payload = {
            idHinhThucThanhToan: parseInt(idHinhThucThanhToan),
            soTien: parseFloat(khachDua),
            maGiaoDich: idHinhThucThanhToan === "1" ? maGD : null,
            idHoaDonChiTiet: selectedInvoiceId,
            trangThai: "Đã thêm",
        };

        try {
            // Gửi yêu cầu POST để lưu thông tin thanh toán
            const response = await fetch('http://localhost:8080/chi-tiet-hinh-thuc-thanh-toan/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                throw new Error('Lưu thông tin thanh toán thất bại.');
            }

            const data = await response.json();
            // Tải lại bảng chi tiết hình thức thanh toán
            await loadChiTietHTTTTable(selectedInvoiceId);
            showSuccessToast('Lưu thông tin thanh toán thành công!');

            // **RESET INPUTS SAU KHI LƯU THÀNH CÔNG**
            document.getElementById('khachDua').value = ''; // Xóa tiền khách đưa
            document.getElementById('maGD').value = '';     // Xóa mã giao dịch
            resetModalState(); // Reset trạng thái modal
        } catch (error) {
            // console.error(error);
            // showErrorToast('Lỗi khi lưu thông tin thanh toán.');
        }
    });


    //End hình thức thanh toán

    //Code phần bên phải (Thanh toán)
    async function loadInvoiceDetails(invoiceId) {
        try {
            // Gọi API lấy thông tin chi tiết hóa đơn
            const response = await fetch(`http://localhost:8080/hoa-don-chi-tiet/${invoiceId}`);

            const data = await response.json();

            // Điền thông tin vào các ô input trong phần bên phải
            document.getElementById('id').value = data.id || 'Chưa có dữ liệu';
            document.getElementById('idHoaDon').value = data.idHoaDon || 'Chưa có dữ liệu';
            document.getElementById('maHoaDon').value = data.maHoaDon || 'Chưa có dữ liệu';
            document.getElementById('maHoaDonChiTiet').value = data.maHoaDonChiTiet || 'Chưa có dữ liệu';
            document.getElementById('hoVaTenKhachHang').value = data.hoVaTenKhachHang || 'Chưa có dữ liệu';
            document.getElementById('idKhachHang').value = data.idKhachHang || 'Chưa có dữ liệu';
            document.getElementById('soDienThoaiKhachHang').value = data.soDienThoaiKhachHang || 'Chưa có dữ liệu';
            // document.getElementById('trangThai').value = data.trangThai || 'Chưa có dữ liệu';
            document.getElementById('tenSanBong').value = data.tenSanBong || 'Chưa có dữ liệu';
            document.getElementById('thoiGianBatDauCa').value = data.thoiGianBatDauCa
                ? new Date(data.thoiGianBatDauCa).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})
                : '';
            document.getElementById('thoiGianKetThucCa').value = data.thoiGianKetThucCa
                ? new Date(data.thoiGianKetThucCa).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})
                : '';
            document.getElementById('ngayTaoHoaDon').value = data.ngayTaoHoaDon || '';
            document.getElementById('ngayDenSan').value = data.ngayDenSan || '';
            document.getElementById('tienSan').value = data.giaSanCa?.toLocaleString() + ' VND' || '0 VND';
            document.getElementById('tienCoc').value = data.tienCocHdct?.toLocaleString() + ' VND' || '0 VND';
            // Gọi API để lấy tiền phụ phí và hiển thị lên ô input
            const tienPhuPhi = await fetchTienPhuPhi(invoiceId);
            document.getElementById('tienPhuPhi').value = tienPhuPhi.toLocaleString() + ' VND'; // Hiển thị tiền phụ phí
            await loadAvailablePhuPhi(selectedInvoiceId);
        } catch (error) {
            // console.error('Error fetching invoice details:', error);
        }
    }

    // Code phần dưới bên trái (DỊCH VỤ)
    //Hàm hiển thị dữ liệu trong modal
    function fetchAndRenderServices(apiUrl, containerId, itemFields) {
        $.ajax({
            url: apiUrl,
            type: 'GET',
            success: function (data) {
                if (!data || data.length === 0) {
                    $(`#${containerId}`).html('<p>Không có dịch vụ nào được tìm thấy.</p>');
                    return;
                }

                let content = '<div class="row" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">';

                data.forEach(item => {
                    const imageUrl = item[itemFields.imageField] || '';
                    const serviceName = item[itemFields.ten] || '';
                    const stock = item[itemFields.soLuong] || 0;
                    const price = item[itemFields.donGia] ? item[itemFields.donGia].toLocaleString() : '0';
                    content += `
                <div class="product-card" style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 250px; background-color: #ffffff; padding: 15px; text-align: center; position: relative;">
                    <div class="price-tag" style="position: absolute; top: 10px; right: 10px; background-color: #ff4d4d; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 14px;">
                        ${price} VND
                    </div>
                    <img src="${imageUrl}" class="card-img-top" alt="${serviceName}" style="width: 100%; height: 160px; object-fit: cover; border-radius: 5px; margin-bottom: 10px;">
                    <h5 class="card-title" style="margin: 10px 0; font-size: 18px; font-weight: bold; color: #333;">${serviceName}</h5>
                    <p class="card-text kho-con" style="margin: 5px 0; font-size: 14px; color: #666;" >Kho Còn: ${stock}</p>
                    <div class="input-group" style="margin: 10px 0;">
                        <input type="number" class="form-control quantity-input" value="0" min="0" style="width: 60px; display: inline-block;">
                    </div>
                    <div class="input-group-append" style="margin-top: 10px;">
                        <button class="btn btn-success add-btn" data-id="${item[itemFields.id]}"  data-price="${item[itemFields.donGia]}" data-name="${serviceName}" data-so-luong="${item[itemFields.soLuong]}" type="button" style="width: 100%; margin-bottom: 5px;">Thêm</button>
                    </div>
                </div>`;
                });

                content += '</div>';
                $(`#${containerId}`).html(content);
            },
        });
    }

    //Khi mở modal THêm dịch vụ
    $('#openServiceModal').on('click', function () {
        if (!selectedInvoiceId) {
            Swal.fire({
                icon: 'warning',
                title: 'Chưa chọn hóa đơn!',
                text: 'Vui lòng chọn một hóa đơn chi tiết trước khi thêm dịch vụ.',
            });
            return;
        }

        // Hiển thị danh sách "Đồ Thuê"
        fetchAndRenderServices(
            'http://localhost:8080/do_thue/searchTenDoThue?tenDoThue=',
            'doThueTab',
            {ten: 'tenDoThue', donGia: 'donGias', imageField: 'imageData', soLuong: 'soLuongs', id: 'id'}
        );

        // Hiển thị danh sách "Nước Uống"
        fetchAndRenderServices(
            'http://localhost:8080/nuoc_uong/searchTenNuocUong?tenNuocUong=',
            'nuocUongTab',
            {ten: 'tenNuocUong', donGia: 'donGias', imageField: 'imageData', soLuong: 'soLuongs', id: 'id'}
        );

        $('#serviceModal').modal('show');
    });

    document.addEventListener('click', async (event) => {
        if (event.target.classList.contains('add-btn')) {
            const button = event.target;
            const id = parseInt(button.getAttribute('data-id'), 10); // ID dịch vụ
            const soLuongInput = button.closest('.product-card').querySelector('.quantity-input');
            const soLuong = parseInt(soLuongInput.value, 10); // Số lượng nhập từ input
            const soLuongTonKho = parseInt(button.getAttribute('data-so-luong'), 10); // Số lượng tồn kho ban đầu
            const idTabActive = document.querySelector('#serviceTabs .nav-link.active').id; // Tab hiện tại
            const trangThai = "Đã đặt";
            const idHoaDonChiTiet = selectedInvoiceId; // ID hóa đơn chi tiết đã chọn
            const dongia2 = parseInt(button.getAttribute('data-price'));

            if (!idHoaDonChiTiet) {
                // showErrorToast('Không thể thêm dịch vụ. ID hóa đơn chi tiết không hợp lệ!');
                return;
            }

            // URL kiểm tra tồn tại
            const checkUrl = idTabActive === 'tab1'
                ? `http://localhost:8080/dich-vu-san-bong/tim-dvsb-do-thue?idHDCT=${idHoaDonChiTiet}&idDoThue=${id}`
                : `http://localhost:8080/dich-vu-san-bong/tim-dvsb-nuoc-uong?idHDCT=${idHoaDonChiTiet}&idNuocUong=${id}`;

            // Gửi API kiểm tra
            fetch(checkUrl)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 400) {
                        return null;
                    }
                    throw new Error('Error checking service existence.');
                })
                .then(data => {
                    if (data) {
                        // Kiểm tra loại dịch vụ và lấy donGia phù hợp
                        const donGia = idTabActive === 'tab1' ? data.donGiasDoThue : data.donGiasNuocUong;

                        if (donGia !== undefined) {
                            // Đã tồn tại: Cộng dồn số lượng và cập nhật
                            const soLuongMoi = data.soLuong + soLuong;
                            const tongTien = soLuongMoi * donGia;

                            const updatePayload = {
                                idDoThue: idTabActive === 'tab1' ? id : null,
                                idNuocUong: idTabActive === 'tab2' ? id : null,
                                idHoaDonChiTiet: idHoaDonChiTiet,
                                soLuong: soLuongMoi,
                                trangThai: trangThai,
                                tongTien: tongTien,
                                deletedAt: false,
                            };

                            const updateUrl = `http://localhost:8080/dich-vu-san-bong/${data.id}`;
                            return fetch(updateUrl, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(updatePayload),
                            });
                        }
                    } else {
                        const payload = {
                            idDoThue: idTabActive === 'tab1' ? id : null,
                            idNuocUong: idTabActive === 'tab2' ? id : null,
                            idHoaDonChiTiet,
                            soLuong,
                            trangThai,
                            tongTien: soLuong * dongia2,
                            deletedAt: false,
                        };

                        return fetch('http://localhost:8080/dich-vu-san-bong', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload),
                        });
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Error processing service.');
                    // console.log('Xử lý dịch vụ thành công!');
                    fillDichVuChoHoaDon(selectedInvoiceId);
                    const modalElement = document.getElementById('serviceModal');

                    // Đóng modal nếu nó đang mở
                    const bootstrapModal = bootstrap.Modal.getInstance(modalElement);
                    if (bootstrapModal) {
                        bootstrapModal.hide();
                    }

                    // Tính toán số lượng tồn kho còn lại
                    const soLuongConLai = soLuongTonKho - soLuong;
                    const updateStockUrl = idTabActive === 'tab1'
                        ? `http://localhost:8080/do_thue/updateSoLuong/${id}`
                        : `http://localhost:8080/nuoc_uong/updateSoLuong/${id}`;
                    return fetch(updateStockUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({soLuongs: soLuongConLai}),
                    });
                })
                .then(response => {
                    if (!response.ok) throw new Error('Error updating stock.');
                    // console.log('Cập nhật tồn kho thành công!');
                    showSuccessToast('Thêm dịch vụ và cập nhật tồn kho thành công!');

                    // Cập nhật UI
                    const khoConElement = button.closest('.product-card').querySelector('.kho-con');
                    if (khoConElement) {
                        khoConElement.textContent = `Kho Còn: ${soLuongTonKho - soLuong}`;
                    }
                })
                .catch(error => {
                    // console.error('Error:', error);
                    // showErrorToast('Có lỗi xảy ra khi xử lý dịch vụ!');
                });
        }

        if (event.target.classList.contains('update-btn')) {
            const button = event.target;
            const idDichVu = button.getAttribute('data-id'); // ID dịch vụ
            const idHoaDonChiTiet = button.getAttribute('data-id-hdct'); // ID hóa đơn chi tiết
            const soLuongInput = button.closest('.product-card').querySelector('.quantity-input');
            const soLuongThem = parseInt(soLuongInput.value, 10); // Số lượng nhập thêm

            if (!soLuongThem || soLuongThem <= 0) {
                showErrorToast('Vui lòng nhập số lượng hợp lệ!');
                return;
            }

            try {
                // 1. Gọi API để lấy thông tin chi tiết dịch vụ
                const detailUrl = `http://localhost:8080/dich-vu-san-bong/${idDichVu}`;
                const detailResponse = await fetch(detailUrl);

                if (!detailResponse.ok) throw new Error('Không lấy được thông tin dịch vụ.');
                const detailData = await detailResponse.json();

                const idDoThue = detailData.idDoThue;
                const idNuocUong = detailData.idNuocUong;
                const donGia = idDoThue ? detailData.donGiasDoThue : detailData.donGiasNuocUong; // Lấy đơn giá
                const soLuongTonKho = idDoThue ? detailData.soLuongsDoThue : detailData.soLuongsNuocUong;

                // 2. Xây dựng URL kiểm tra tồn tại
                const checkUrl = idDoThue
                    ? `http://localhost:8080/dich-vu-san-bong/tim-dvsb-do-thue?idHDCT=${idHoaDonChiTiet}&idDoThue=${idDoThue}`
                    : `http://localhost:8080/dich-vu-san-bong/tim-dvsb-nuoc-uong?idHDCT=${idHoaDonChiTiet}&idNuocUong=${idNuocUong}`;

                // 3. Gọi API kiểm tra tồn tại
                const checkResponse = await fetch(checkUrl);

                let checkData = null;
                if (checkResponse.ok) {
                    // Dịch vụ đã tồn tại, thực hiện cập nhật số lượng
                    checkData = await checkResponse.json();

                    const updatePayload = {
                        idDoThue: idDoThue || null,
                        idNuocUong: idNuocUong || null,
                        idHoaDonChiTiet,
                        soLuong: soLuongThem,
                        trangThai: checkData.trangThai,
                        tongTien: soLuongThem * donGia, // Tính tổng tiền
                    };

                    const updateUrl = `http://localhost:8080/dich-vu-san-bong/${idDichVu}`;
                    const updateResponse = await fetch(updateUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatePayload),
                    });

                    if (!updateResponse.ok) throw new Error('Cập nhật số lượng thất bại.');
                    showSuccessToast('Cập nhật số lượng thành công!');
                    await fillDichVuChoHoaDon(selectedInvoiceId);
                } else if (checkResponse.status === 400) {
                    // Dịch vụ chưa tồn tại, thực hiện thêm mới
                    const addPayload = {
                        idHoaDonChiTiet,
                        soLuong: soLuongThem,
                        idDoThue: idDoThue || null,
                        idNuocUong: idNuocUong || null,
                    };

                    const addResponse = await fetch('http://localhost:8080/dich-vu-san-bong', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(addPayload),
                    });

                    if (!addResponse.ok) throw new Error('Thêm dịch vụ thất bại.');
                    await fillDichVuChoHoaDon(selectedInvoiceId);
                    showSuccessToast('Thêm dịch vụ thành công!');
                } else {
                    throw new Error('Lỗi kiểm tra dịch vụ.');
                }

                // 4. Cập nhật số lượng tồn kho
                const soLuongHienTai = checkData ? checkData.soLuong : 0; // Lấy số lượng hiện tại từ checkData
                const chenhLechSoLuong = soLuongThem - soLuongHienTai; // Tính chênh lệch số lượng

                if (chenhLechSoLuong !== 0) {
                    const soLuongConLai = soLuongTonKho - chenhLechSoLuong; // Điều chỉnh tồn kho dựa trên chênh lệch

                    const updateStockUrl = idDoThue
                        ? `http://localhost:8080/do_thue/updateSoLuong/${idDoThue}`
                        : `http://localhost:8080/nuoc_uong/updateSoLuong/${idNuocUong}`;

                    const updateStockPayload = {
                        soLuongs: soLuongConLai, // Số lượng tồn kho mới
                    };

                    const stockResponse = await fetch(updateStockUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updateStockPayload),
                    });

                    if (!stockResponse.ok) throw new Error('Cập nhật tồn kho thất bại.');

                    // Cập nhật hiển thị kho
                    const khoConElement = button.closest('.product-card').querySelector('.kho-con');
                    if (khoConElement) {
                        khoConElement.textContent = `Kho Còn: ${soLuongConLai}`;
                    }

                    // console.log('Cập nhật tồn kho thành công!');
                    // showSuccessToast('Cập nhật số lượng và tồn kho thành công!');
                }
            } catch (error) {
                // console.error('Error:', error);
                // showErrorToast('Có lỗi xảy ra khi xử lý dịch vụ!');
            }
        }

        if (event.target.classList.contains('cancel-btn')) {
            const button = event.target;
            const idDichVu = button.getAttribute('data-id'); // ID dịch vụ
            const idHoaDonChiTiet = selectedInvoiceId;

            try {
                // 1. Gọi API để lấy thông tin chi tiết dịch vụ
                const detailUrl = `http://localhost:8080/dich-vu-san-bong/${idDichVu}`;
                const detailResponse = await fetch(detailUrl);

                if (!detailResponse.ok) throw new Error('Không lấy được thông tin dịch vụ.');
                const detailData = await detailResponse.json();

                const idDoThue = detailData.idDoThue;
                const idNuocUong = detailData.idNuocUong;
                const soLuongTonKho = idDoThue ? detailData.soLuongsDoThue : detailData.soLuongsNuocUong;

                // 2. Xây dựng URL kiểm tra tồn tại
                const checkUrl = idDoThue
                    ? `http://localhost:8080/dich-vu-san-bong/tim-dvsb-do-thue?idHDCT=${idHoaDonChiTiet}&idDoThue=${idDoThue}`
                    : `http://localhost:8080/dich-vu-san-bong/tim-dvsb-nuoc-uong?idHDCT=${idHoaDonChiTiet}&idNuocUong=${idNuocUong}`;

                // 3. Gọi API kiểm tra tồn tại
                const checkResponse = await fetch(checkUrl);

                let checkData = null; // Định nghĩa checkData ở đây
                if (checkResponse.ok) {
                    // Dịch vụ đã tồn tại, thực hiện cập nhật số lượng về 0
                    checkData = await checkResponse.json();

                    const updatePayload = {
                        idDoThue: idDoThue || null,
                        idNuocUong: idNuocUong || null,
                        idHoaDonChiTiet,
                        soLuong: 0, // Số lượng hủy bỏ
                        trangThai: checkData.trangThai,
                        deletedAt: true,
                    };

                    const updateUrl = `http://localhost:8080/dich-vu-san-bong/${idDichVu}`;
                    const updateResponse = await fetch(updateUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatePayload),
                    });

                    if (!updateResponse.ok) throw new Error('Cập nhật số lượng thất bại.');
                    await fillDichVuChoHoaDon(selectedInvoiceId);
                    showSuccessToast('Số lượng đã được hủy thành công!');
                } else if (checkResponse.status === 400) {
                    // Dịch vụ chưa tồn tại trong giỏ hàng
                    // showErrorToast('Dịch vụ chưa được thêm vào giỏ hàng.');
                } else {
                    // throw new Error('Lỗi kiểm tra dịch vụ.');
                }

                // 4. Cập nhật số lượng tồn kho (số lượng được hủy bỏ sẽ không làm thay đổi tồn kho)
                const soLuongHienTai = checkData ? checkData.soLuong : 0; // Lấy số lượng hiện tại từ checkData
                const soLuongConLai = soLuongTonKho + soLuongHienTai;

                const updateStockUrl = idDoThue
                    ? `http://localhost:8080/do_thue/updateSoLuong/${idDoThue}`
                    : `http://localhost:8080/nuoc_uong/updateSoLuong/${idNuocUong}`;

                const updateStockPayload = {
                    soLuongs: soLuongConLai, // Cập nhật lại số lượng tồn kho
                };

                const stockResponse = await fetch(updateStockUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateStockPayload),
                });

                if (!stockResponse.ok) throw new Error('Cập nhật tồn kho thất bại.');

                // Cập nhật hiển thị kho
                const khoConElement = button.closest('.product-card').querySelector('.kho-con');
                if (khoConElement) {
                    khoConElement.textContent = `Kho Còn: ${soLuongConLai}`;
                }

                // console.log('Cập nhật tồn kho thành công!');
                showSuccessToast('Cập nhật số lượng và tồn kho thành công!');
            } catch (error) {
                // console.error('Error:', error);
                // showErrorToast('Có lỗi xảy ra khi hủy dịch vụ!');
            }
        }
    });

    async function tinhTongTienDichVu() {
        try {
            // Gọi API để lấy thông tin hóa đơn chi tiết
            const invoiceResponse = await fetch(`http://localhost:8080/hoa-don-chi-tiet/${selectedInvoiceId}`, {cache: "no-store"});
            const invoiceData = await invoiceResponse.json();

            // Gọi API để lấy danh sách dịch vụ
            const servicesResponse = await fetch(`http://localhost:8080/dich-vu-san-bong/tim-theo-idhdct/${invoiceData.id}`, {cache: "no-store"});
            const services = await servicesResponse.json();

            let totalCost = 0; // Khởi tạo tổng tiền dịch vụ

            if (Array.isArray(services) && services.length > 0) {
                // Tính tổng tiền từ các dịch vụ
                totalCost = services.reduce((sum, service) => {
                    return sum + (parseFloat(service.tongTien) || 0); // Đảm bảo chuyển đổi sang số
                }, 0);
            }

            // Cập nhật giá trị dịch vụ, mặc định là 0 nếu không có dịch vụ
            document.getElementById(`giaDichVu`).value = totalCost.toLocaleString() + ' VND';

        } catch (error) {
            // console.error('Lỗi khi tính tổng tiền:', error);
            // Đặt giá trị tiền dịch vụ về 0 trong trường hợp lỗi
            document.getElementById(`giaDichVu`).value = '0 VND';
        }
    }


    // Hàm tính tổng
    async function tinhTongThanhToan() {
        // Lấy giá trị từ các input theo ID và chuyển đổi
        const tienSan = parseCurrency(document.getElementById('tienSan').value.trim()) || 0;
        const tienCoc = parseCurrency(document.getElementById('tienCoc').value.trim()) || 0;
        const giaDichVu = parseCurrency(document.getElementById('giaDichVu').value.trim()) || 0;
        const tienPhuPhi = parseCurrency(document.getElementById('tienPhuPhi').value.trim()) || 0;

        // Tính tổng
        const tongTien = tienSan - tienCoc + giaDichVu + tienPhuPhi;

        // Hiển thị kết quả định dạng tiền tệ Việt Nam
        const tongTienFormatted = tongTien.toLocaleString() + ' VND';

        const tienGiam = parseCurrency(document.getElementById('tienGiam').value.trim()) || 0;
        let tongTienPhaiTra = tongTien - tienGiam;
        if (tongTienPhaiTra <= 0) {
            tongTienPhaiTra = 0;
        }
        const tongTienPhaiTraFormatted = tongTienPhaiTra.toLocaleString() + ' VND';
        // Lấy tiền khách đưa và tính tiền trả lại
        const tienKhachDua = parseCurrency(document.getElementById('tienKhachDua').value.trim()) || 0;

        let tienTraLai = tienKhachDua - tongTienPhaiTra;
        // Kiểm tra nếu tiền trả lại < 0 thì set về 0
        if (tienTraLai < 0) {
            tienTraLai = 0;
        }
        const tienTraLaiFormatted = tienTraLai.toLocaleString() + ' VND';
        // Cập nhật giá trị vào ô input hoặc giao diện
        document.getElementById('tongTien').value = tongTienFormatted;
        document.getElementById('tongTienPhaiTra').value = tongTienPhaiTraFormatted;
        document.getElementById('tienTraLai').value = tienTraLaiFormatted;
    }

    // Hàm hiển thị dữ liệu phiếu giảm giá lên bảng

    document.getElementById('btnShowModal').addEventListener('click', async () => {
        const modal = new bootstrap.Modal(document.getElementById('modalPhieuGiamGia'));
        modal.show();

        const idKhachHang = document.getElementById('idKhachHang').value.trim();
        const tongTien = parseCurrency(document.getElementById('tongTien').value.trim()) || 0;

        try {
            // Gọi API để lấy danh sách phiếu giảm giá
            const [congKhaiResponse, caNhanResponse] = await Promise.all([
                fetch(`http://localhost:8080/api-phieu-giam-gia-chi-tiet/pgg-cong-khai?tongTien=${tongTien}`),
                fetch(`http://localhost:8080/api-phieu-giam-gia-chi-tiet/pgg-ca-nhan/${idKhachHang}?tongTien=${tongTien}`)
            ]);

            const pggCongKhai = await congKhaiResponse.json();
            const pggCaNhan = await caNhanResponse.json();

            // Kết hợp danh sách phiếu giảm giá công khai và cá nhân
            let combinedPGG = [...pggCongKhai, ...pggCaNhan];

            // Hàm hiển thị danh sách phiếu giảm giá
            function displayPhieuGiamGia(data) {
                const tableBody = document.getElementById('tablePhieuGiamGiaBody');
                tableBody.innerHTML = ''; // Xóa dữ liệu cũ
                const itemsPerPage = 5;
                let currentPage = 0;
                const totalPages = Math.ceil(data.length / itemsPerPage);

                // Hàm hiển thị bảng với dữ liệu của trang hiện tại
                function displayPage(page) {
                    const startIndex = page * itemsPerPage;
                    const endIndex = Math.min(startIndex + itemsPerPage, data.length);
                    const pageItems = data.slice(startIndex, endIndex);

                    tableBody.innerHTML = ''; // Xóa dữ liệu cũ
                    pageItems.forEach((pgg, index) => {
                        const mucGiam = (pgg.hinhThucGiamGiaPhieuGiamGia === false || pgg.hinhThucGiamGiaPhieuGiamGia === 'false')
                            ? `${parseFloat(pgg.mucGiamPhieuGiamGia || 0).toLocaleString()} VND`
                            : `${parseFloat(pgg.mucGiamPhieuGiamGia || 0).toLocaleString()} %`;

                        const giaTriToiDa = pgg.giaTriToiDaPhieuGiamGia
                            ? `${parseFloat(pgg.giaTriToiDaPhieuGiamGia).toLocaleString()} VND`
                            : 'Không giới hạn';

                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td>${startIndex + index + 1}</td>
                        <td>${pgg.maPhieuGiamGia || ''}</td>
                        <td>${pgg.tenPhieuGiamGia || ''}</td>
                        <td>${pgg.doiTuongApDungPhieuGiamGia === false ? 'Công khai' : 'Cá nhân'}</td>
                        <td>${mucGiam}</td>
                        <td>${giaTriToiDa}</td>
                        <td >
                            <button class="btn btn-success btn-chon-pgg"
                                    data-id="${pgg.id}"
                                    data-id-pgg = "${pgg.idPhieuGiamGia}"
                                    data-ma="${pgg.maPhieuGiamGia}"
                                    data-gia-so-luong ="${pgg.soLuongPhieuGiamGia}"
                                    data-trang-thai="${pgg.trangThaiPhieuGiamGia}"
                                    data-muc-giam="${pgg.mucGiamPhieuGiamGia}"
                                    data-hinh-thuc="${pgg.hinhThucGiamGiaPhieuGiamGia}"
                                    data-gia-tri-toi-da="${pgg.giaTriToiDaPhieuGiamGia || 0}" >
                                Chọn
                            </button>
                        </td>
                    `;
                        tableBody.appendChild(row);
                    });
                }

                // Phân trang và hiển thị trang đầu tiên
                function createPagination() {
                    const paginationContainer = document.getElementById('pagination');
                    paginationContainer.innerHTML = '';

                    if (currentPage > 0) {
                        const prevButton = document.createElement('button');
                        prevButton.className = 'btn btn-success me-2';
                        prevButton.textContent = '<';
                        prevButton.onclick = () => {
                            currentPage--;
                            displayPage(currentPage);
                            createPagination();
                            addPhieuGiamGiaClickHandler();
                        };
                        paginationContainer.appendChild(prevButton);
                    }

                    const pageDisplay = document.createElement('span');
                    pageDisplay.className = 'btn btn-outline-secondary';
                    pageDisplay.textContent = `Trang ${currentPage + 1}`;
                    paginationContainer.appendChild(pageDisplay);

                    if (currentPage < totalPages - 1) {
                        const nextButton = document.createElement('button');
                        nextButton.className = 'btn btn-success ms-2';
                        nextButton.textContent = '>';
                        nextButton.onclick = () => {
                            currentPage++;
                            displayPage(currentPage);
                            createPagination();
                            addPhieuGiamGiaClickHandler();
                        };
                        paginationContainer.appendChild(nextButton);
                    }
                }

                displayPage(currentPage);
                createPagination();
                addPhieuGiamGiaClickHandler();
            }

            // Hiển thị danh sách đầy đủ ban đầu
            displayPhieuGiamGia(combinedPGG);
            // Thêm sự kiện cho nút "Chọn"

            function addPhieuGiamGiaClickHandler() {
                document.querySelectorAll('.btn-chon-pgg').forEach(button => {
                    button.addEventListener('click', function () {
                        // Xác định dòng chứa nút "Chọn" đang được nhấn
                        // Lấy dữ liệu từ thuộc tính data
                        let tienGiam = 0;
                        const tongTien = parseCurrency(document.getElementById('tongTien').value.trim()) || 0;
                        const tenPhieu = this.getAttribute('data-ma');
                        const mucGiam = parseFloat(this.getAttribute('data-muc-giam')) || 0 ;
                        const giaTriToiDa = parseFloat(this.getAttribute('data-gia-tri-toi-da')) || 0;
                        const idPhieuGiamGia = this.getAttribute('data-id-pgg');
                        const idPhieuGiamGiaChiTiet = this.getAttribute('data-id');
                        const soLuongPhieuGiamGia = this.getAttribute('data-gia-so-luong');
                        const trangThaiPhieuGiamGia = this.getAttribute('data-trang-thai');
                        const hinhThucGiamGiaPhieuGiamGia = this.getAttribute('data-hinh-thuc');
                        // Kiểm tra lại giá trị kiểu Boolean của hinhThucGiamGiaPhieuGiamGia
                        const isDiscountPercentage = hinhThucGiamGiaPhieuGiamGia === true || hinhThucGiamGiaPhieuGiamGia === 'true' || hinhThucGiamGiaPhieuGiamGia === 1;

                        if (isDiscountPercentage) { // Giảm giá theo %
                            // Tính tiền giảm theo phần trăm
                            tienGiam = (tongTien * mucGiam) / 100;

                            // Giới hạn tiền giảm theo giá trị tối đa nếu có
                            if (giaTriToiDa > 0) {
                                tienGiam = Math.min(tienGiam, giaTriToiDa);
                            }
                        } else { // Giảm giá theo VND
                            tienGiam = mucGiam; // Tiền giảm là giá trị VND
                        }
                        // Đặt dữ liệu vào các ô input
                        document.getElementById('phieuGiamGia').value = tenPhieu;
                        document.getElementById('tienGiam').value = tienGiam.toLocaleString() + 'VND';
                        document.getElementById('idPhieuGiamGia').value = idPhieuGiamGia;
                        document.getElementById('idPhieuGiamGiaChiTiet').value = idPhieuGiamGiaChiTiet;
                        document.getElementById('soLuongPhieuGiamGia').value = soLuongPhieuGiamGia;
                        document.getElementById('trangThaiPhieuGiamGia').value = trangThaiPhieuGiamGia;

                        // Tính toán lại tổng thanh toán
                        tinhTongThanhToan();

                        // Hiển thị thông báo thành công
                        showSuccessToast('Đã áp dụng phiếu giảm giá');

                        // Ẩn modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalPhieuGiamGia'));
                        modal.hide();
                    });
                });
            }

            // Xử lý tìm kiếm
            document.getElementById('searchPhieuGiamGia').addEventListener('input', async function () {
                const keyword = this.value.trim();
                if (keyword === '') {
                    displayPhieuGiamGia(combinedPGG); // Hiển thị danh sách đầy đủ
                } else {
                    try {
                        const [searchCongKhaiResponse, searchCaNhanResponse] = await Promise.all([
                            fetch(`http://localhost:8080/api-phieu-giam-gia-chi-tiet/pgg-cong-khai?tongTien=${tongTien}&keyword=${keyword}`),
                            fetch(`http://localhost:8080/api-phieu-giam-gia-chi-tiet/pgg-ca-nhan/${idKhachHang}?tongTien=${tongTien}&keyword=${keyword}`)
                        ]);
                        const searchCongKhai = await searchCongKhaiResponse.json();
                        const searchCaNhan = await searchCaNhanResponse.json();
                        const searchResults = [...searchCongKhai, ...searchCaNhan];
                        displayPhieuGiamGia(searchResults); // Hiển thị danh sách tìm kiếm
                    } catch (error) {
                        // console.error('Lỗi khi tìm kiếm:', error);
                    }
                }
            });
        } catch (error) {
            // console.error('Lỗi khi tải danh sách phiếu giảm giá:', error);
        }
    });

    async function calculateBestDiscount() {
        try {
            const tongTien = parseCurrency(document.getElementById('tongTien').value.trim()) || 0;
            const idKhachHang = document.getElementById('idKhachHang').value.trim();

            // Gọi API để lấy danh sách phiếu giảm giá công khai và cá nhân
            const [congKhaiResponse, caNhanResponse] = await Promise.all([
                fetch(`http://localhost:8080/api-phieu-giam-gia-chi-tiet/pgg-cong-khai?tongTien=${tongTien}`),
                fetch(`http://localhost:8080/api-phieu-giam-gia-chi-tiet/pgg-ca-nhan/${idKhachHang}?tongTien=${tongTien}`)
            ]);

            const pggCongKhai = await congKhaiResponse.json();
            const pggCaNhan = await caNhanResponse.json();

            // Kết hợp danh sách phiếu giảm giá
            const combinedPGG = [...pggCongKhai, ...pggCaNhan];

            let bestDiscount = 0;
            let bestPgg = null;

            // Duyệt qua danh sách để tìm phiếu giảm giá tốt nhất
            combinedPGG.forEach(pgg => {
                let tienGiam = 0;

                // Chuyển đổi giá trị `mucGiamPhieuGiamGia` và `giaTriToiDaPhieuGiamGia` sang dạng số
                const mucGiam = parseFloat(pgg.mucGiamPhieuGiamGia) || 0;
                const giaTriToiDa = parseFloat(pgg.giaTriToiDaPhieuGiamGia) || 0;

                // Kiểm tra lại giá trị kiểu Boolean của hinhThucGiamGiaPhieuGiamGia
                const isDiscountPercentage = pgg.hinhThucGiamGiaPhieuGiamGia === true || pgg.hinhThucGiamGiaPhieuGiamGia === 'true' || pgg.hinhThucGiamGiaPhieuGiamGia === 1;

                if (isDiscountPercentage) { // Giảm giá theo %
                    // Tính tiền giảm theo phần trăm
                    tienGiam = (tongTien * mucGiam) / 100;

                    // Giới hạn tiền giảm theo giá trị tối đa nếu có
                    if (giaTriToiDa > 0) {
                        tienGiam = Math.min(tienGiam, giaTriToiDa);
                    }
                } else { // Giảm giá theo VND
                    tienGiam = mucGiam; // Tiền giảm là giá trị VND
                }

                // Kiểm tra và cập nhật phiếu giảm giá tốt nhất
                if (tienGiam > bestDiscount) {
                    bestDiscount = tienGiam;
                    bestPgg = pgg;
                }
            });

            // Hiển thị phiếu giảm giá tốt nhất vào các ô input
            if (bestPgg) {
                document.getElementById('phieuGiamGia').value = bestPgg.maPhieuGiamGia;
                document.getElementById('idPhieuGiamGiaChiTiet').value = bestPgg.id;
                document.getElementById('idPhieuGiamGia').value = bestPgg.idPhieuGiamGia;
                document.getElementById('soLuongPhieuGiamGia').value = bestPgg.soLuongPhieuGiamGia;
                document.getElementById('trangThaiPhieuGiamGia').value = bestPgg.trangThaiPhieuGiamGia;
                // Hiển thị tiền giảm đúng: % nếu giảm theo phần trăm, VND nếu giảm theo tiền
                document.getElementById('tienGiam').value = bestDiscount.toLocaleString() + 'VND'; // Hiển thị VND nếu giảm theo tiền
                tinhTongThanhToan()
            } else {
                document.getElementById('phieuGiamGia').value = '';
                document.getElementById('idPhieuGiamGia').value = '';
                document.getElementById('idPhieuGiamGiaChiTiet').value = '';
                document.getElementById('tienGiam').value = '0 VND';
            }
        } catch (error) {
            // console.error('Lỗi khi tính toán phiếu giảm giá tốt nhất:', error);
        }
    }

    async function fillDichVuChoHoaDon(idHDCT) {
        await tinhTongTienDichVu();
         await tinhTongThanhToan();
        $.ajax({
            url: `http://localhost:8080/dich-vu-san-bong/tim-theo-idhdct/${idHDCT}`,
            type: 'GET',
            success: function (data) {
                if (!data || data.length === 0) {
                    $('#dichVuThueList').html('<p>Chưa có dịch vụ nào được thêm vào hóa đơn.</p>');
                    return;
                }

                let content = '<div class="row" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">';
                data.forEach(item => {
                    const imageUrl = item.idDoThue ? item.imageDataDoThue : item.imageDataNuocUong || '';
                    const serviceName = item.idDoThue ? item.tenDoThue : item.tenNuocUong || '';
                    const price = item.idDoThue ? item.donGiasDoThue : item.donGiasNuocUong;
                    const formattedPrice = price ? price.toLocaleString() : '0';
                    const idDoThue = item.idDoThue || null;
                    const idNuocUong = item.idNuocUong || null;

                    content += `
                <div class="product-card" style="border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); width: 250px; background-color: #ffffff; padding: 15px; text-align: center; position: relative;">
                    <div class="price-tag" style="position: absolute; top: 10px; right: 10px; background-color: #ff4d4d; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 14px;">
                        ${formattedPrice} VND
                    </div>
                    <img src="${imageUrl}" class="card-img-top" alt="${serviceName}" style="width: 100%; height: 160px; object-fit: cover; border-radius: 5px; margin-bottom: 10px;">
                    <h5 class="card-title" style="margin: 10px 0; font-size: 18px; font-weight: bold; color: #333;">${serviceName}</h5>
                    <div class="input-group">
                        <input type="number" class="form-control quantity-input" value="${item.soLuong}" min="0" data-id="${item.id}" data-id-hdct="${idHDCT}" data-id-do-thue="${idDoThue}" data-id-nuoc-uong="${idNuocUong}" style="width: 100px; margin: auto;">
                    </div>
                    <div class="d-flex justify-content-between" style="margin-top: 10px;">
                        <button class="btn btn-danger cancel-btn" data-id="${item.id}" type="button" style="width: 48%;">Hủy</button>
                        <button class="btn btn-success update-btn" data-id="${item.id}" data-id-hdct="${idHDCT}" type="button" style="width: 48%;">Cập nhật</button>
                    </div>
                </div>`;
                });

                content += '</div>';
                $('#dichVuThueList').html(content);
            },
            error: function (error) {
                // console.error('Lỗi khi lấy dữ liệu dịch vụ:', error);
                // showErrorToast('Không thể lấy danh sách dịch vụ.');
            }
        });
    }

    function formatCurrency(value) {
        if (typeof value === 'undefined' || value === null || isNaN(value)) {
            return '0'; // Giá trị mặc định nếu không hợp lệ
        }
        return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' VND';
    }

    async function exportPDFWithTemplate(invoiceId) {
        // Lấy dữ liệu từ form
        const hoVaTenKhachHang = document.getElementById(`hoVaTenKhachHang`).value || "Nguyễn Văn A";
        const soDienThoaiKhachHang = document.getElementById(`soDienThoaiKhachHang`).value || "0123456789";
        const idHoaDon = document.getElementById(`idHoaDon`).value;
        const tenSanBong = document.getElementById(`tenSanBong`).value || "Sân A";
        const thoiGianBatDauCa = document.getElementById(`thoiGianBatDauCa`).value || "8:00 AM";
        const thoiGianKetThucCa = document.getElementById(`thoiGianKetThucCa`).value || "10:00 AM";
        const ngayTaoHoaDon = document.getElementById(`ngayTaoHoaDon`).value || "01/02/2024";
        const tongTien = document.getElementById(`tongTien`).value || "500,000";
        const phuPhi = document.getElementById(`tienPhuPhi`).value || "500,000";
        const tienSan = document.getElementById(`tienSan`).value || "500,000";
        const tongTienPhaiTra = document.getElementById(`tongTienPhaiTra`).value || "0";
        const tienKhachDua = document.getElementById(`tienKhachDua`).value || "0";
        const tienTraLai = document.getElementById(`tienTraLai`).value || "0";
        const response = await fetch(`http://localhost:8080/hoa-don-chi-tiet/${selectedInvoiceId}`);
        const data = await response.json();
        const maHoaDonChiTiet = data.maHoaDonChiTiet;
        const qr = new QRious({
            value: maHoaDonChiTiet,
            size: 80
        });

        $.ajax({
            url: `http://localhost:8080/dich-vu-san-bong/dichVuSanBongTheoHoaDon/${invoiceId}`,
            type: 'GET',
            success: function (data) {
                let serviceDetailsHTML = '';
                let totalServiceCost = 0;

                if (data.length > 0) {
                    // Xây dựng bảng chi tiết dịch vụ
                    serviceDetailsHTML += `
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead style="background-color: #fff; color: #000000;">
                        <tr>
                            <th style="border: 1px solid #000000; padding: 8px;">STT</th>
                            <th style="border: 1px solid #000000; padding: 8px;">Tên dịch vụ</th>
                            <th style="border: 1px solid #000000; padding: 8px; text-align: center;">Số lượng</th>
                            <th style="border: 1px solid #000000; padding: 8px; text-align: right;">Giá (VND)</th>
                            <th style="border: 1px solid #000000; padding: 8px; text-align: right;">Tổng tiền (VND)</th>
                        </tr>
                    </thead>
                    <tbody>`;

                    // Lặp qua các dịch vụ trong dữ liệu
                    data.forEach((item, index) => {
                        let itemName = '';
                        let itemTotal = 0;

                        // Kiểm tra xem dịch vụ là đồ thuê hay nước uống
                        if (item.idDoThue) {
                            itemName = item.tenDoThue;
                            itemTotal = item.soLuong * item.donGiasDoThue;
                        } else if (item.idNuocUong) {
                            itemName = item.tenNuocUong;
                            itemTotal = item.soLuong * item.donGiasNuocUong;
                        }

                        totalServiceCost += itemTotal;

                        serviceDetailsHTML += `
                    <tr>
                        <td style="border: 1px solid #000000; padding: 8px;">${index + 1}</td>
                        <td style="border: 1px solid #000000; padding: 8px;">${itemName}</td>
                        <td style="border: 1px solid #000000; padding: 8px; text-align: center;">${item.soLuong}</td>
                        <td style="border: 1px solid #000000; padding: 8px; text-align: right;">${formatCurrency(item.idDoThue ? item.donGiasDoThue : item.donGiasNuocUong)}</td>
                        <td style="border: 1px solid #000000; padding: 8px; text-align: right;">${formatCurrency(itemTotal)}</td>
                    </tr>`;
                    });

                    serviceDetailsHTML += `
                </tbody>
            </table>`;
                }

                const template = `
                <div style="max-width: 800px; margin: auto; padding: 30px; border: 2px solid #000; border-radius: 10px; font-family: 'Times New Roman', serif; color: #333; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.05; z-index: 0;">
                        <img src="/img/logo.png" alt="Logo" style="width: 500px; height: auto;">
                    </div>
                    <table cellpadding="0" cellspacing="0" style="width: 100%; text-align: left;">
                        <!-- Header -->
                        <tr class="top">
                            <td colspan="2" style="padding-bottom: 20px;">
                                <table style="width: 100%; border-bottom: 4px solid #000; padding-bottom: 10px; table-layout: fixed;">
                                    <tr>
                                        <!-- Logo Column -->
                                        <td style="width: 33%; text-align: left; vertical-align: middle;">
                                            <img src="/img/logo.png" alt="Logo" style="width: 100px; vertical-align: middle;">
                                        </td>

                                        <!-- Invoice Title Column -->
                                        <td style="width: 33%; text-align: center; vertical-align: middle;">
                                            <strong style="font-size: 36px; color: #000;">HÓA ĐƠN</strong>
                                        </td>

                                        <!-- QR Code Column -->
                                        <td style="width: 33%; text-align: right; vertical-align: middle; padding-top: 20px;">
                                            <img src="${qr.toDataURL()}" alt="QR Code" style="width: 80px; height: 80px;">
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>

                        <!-- Thông tin khách hàng -->
                        <tr class="information">
                            <td colspan="2" style="padding-bottom: 20px;">
                                <table style="width: 100%;">
                                    <tr>
                                        <td>
                                            <strong style="color: #000;">Hóa đơn cho:</strong><br>
                                            ${hoVaTenKhachHang}<br>
                                            SĐT: ${soDienThoaiKhachHang}
                                        </td>
                                        <td style="text-align: right;">
                                            <strong style="color: #000;">Ngày tạo:</strong> ${ngayTaoHoaDon}<br>
                                            <strong style="color: #000;">Hóa đơn #:</strong> ${idHoaDon}<br>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>

                        <!-- Thông tin hóa đơn -->
                        <tr class="heading">
                            <td colspan="2" style="padding-top: 20px; padding-bottom: 10px; font-weight: bold; font-size: 18px; background-color: #fff; color: #000; border-bottom: 3px solid #000;">
                                <strong style="color: #000000;">Thông tin hóa đơn</strong>
                            </td>
                        </tr>
                        <tr class="item">
                            <td>Tên sân:</td>
                            <td style="text-align: right;">${tenSanBong}</td>
                        </tr>
                        <tr class="item">
                            <td>Thời gian bắt đầu:</td>
                            <td style="text-align: right;">${thoiGianBatDauCa}</td>
                        </tr>
                        <tr class="item">
                            <td>Thời gian kết thúc:</td>
                            <td style="text-align: right;">${thoiGianKetThucCa}</td>
                        </tr>

                        <!-- Chi tiết dịch vụ đã thuê -->
                        ${serviceDetailsHTML}

                        <!-- Chi phí khác -->
                        <tr class="heading">
                            <td colspan="2" style="border-bottom: 3px solid #000; padding-top: 20px; padding-bottom: 10px; font-weight: bold; font-size: 18px; background-color: #f9f9f9; color: #000;">
                                <strong style="color: #000000">Chi phí khác</strong>
                            </td>
                        </tr>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                            <tr class="item">
                                <td style="border: 2px solid #333; padding: 10px;">Phụ phí:</td>
                                <td style="border: 2px solid #333; padding: 10px; text-align: right;">${phuPhi}</td>
                            </tr>
                            <tr class="item">
                                <td style="border: 2px solid #333; padding: 10px;">Tiền sân:</td>
                                <td style="border: 2px solid #333; padding: 10px; text-align: right;">${tienSan}</td>
                            </tr>
                        </table>

                        <!-- Tổng chi phí -->

                        <div style="padding: 10px; background-color: #f9f9f9; border: 1px solid #333; margin-top: 20px;">
                            <div style="font-size: 16px; font-weight: bold; display: flex; justify-content: space-between;">
                                <span>Tổng tiền:</span>
                                <span style="text-align: right; flex-grow: 1;">${tongTienPhaiTra}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Tiền khách đưa:</span>
                                <span style="text-align: right; flex-grow: 1;">${tienKhachDua}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Tiền trả lại:</span>
                                <span style="text-align: right; flex-grow: 1;">${tienTraLai}</span>
                            </div>
                        </div>
                        <br>

                        <!-- Cảm ơn -->
                        <p style="text-align: center; font-size: 14px; color: #777;">Cảm ơn bạn đã sử dụng dịch vụ của chúng tôi!</p>

                        <!-- Footer -->
                        <footer style="text-align: center; font-size: 12px; color: #999;">
                            <p>FIVE STU | Địa chỉ: 123 Đường ABC, TP. HCM</p>
                            <p>Email: contact@fivestu.com | Số điện thoại: (028) 1234 5678</p>
                        </footer>
                    </table>
                </div>`;

                const element = document.createElement('div');
                element.innerHTML = template;
                html2pdf()
                    .from(element)
                    .save(`hoa_don_${invoiceId}.pdf`)
                    .then(() => {
                        setTimeout(() => {
                            location.reload();
                        }, 0001);
                    });
            },
            error: function (error) {
                // console.log('Lỗi khi lấy dữ liệu dịch vụ: ', error);
            }
        });
    }

    async function thanhToan() {
        // Lấy dữ liệu hóa đơn chi tiết hiện tại
        const response = await fetch(`http://localhost:8080/hoa-don-chi-tiet/${selectedInvoiceId}`);
        const data = await response.json();

        const tienKhachDua = parseCurrency(document.getElementById('tienKhachDua').value.trim()) || 0;
        const tongTienPhaiTra = parseCurrency(document.getElementById('tongTienPhaiTra').value.trim()) || 0;
        const tongTien = parseCurrency(document.getElementById('tongTien').value.trim()) || 0;
        const tienCocHdct = parseCurrency(document.getElementById('tienCoc').value.trim()) || 0;
        const tienGiamGia = parseCurrency(document.getElementById('tienGiam').value.trim()) || 0;
        const idPhieuGiamGia = document.getElementById('idPhieuGiamGia').value || null;
        const idPhieuGiamGiaChiTiet = document.getElementById('idPhieuGiamGiaChiTiet').value|| null;
        const soLuongPhieuGiamGia = parseInt(document.getElementById('soLuongPhieuGiamGia').value) || 0;
        const trangThaiPhieuGiamGia = document.getElementById('trangThaiPhieuGiamGia').value;
        const idKhachHang = document.getElementById('idKhachHang').value || 0;
        const responseNhanVien = await fetch('http://localhost:8080/hoa-don/get-nhan-vien-trong-ca');
        if (!responseNhanVien.ok) {
            throw new Error("Không thể lấy thông tin nhân viên");
        }
        const nhanVienData = await responseNhanVien.json();
        const idNhanVien = nhanVienData.id;
        // Kiểm tra nếu tiền khách đưa nhỏ hơn tổng tiền phải trả
        if (tienKhachDua < tongTienPhaiTra) {
            showErrorToast('Chưa thanh toán đủ tiền!');
            return;
        }

        // Hiển thị xác nhận trước khi thanh toán
        const result = await Swal.fire({
            title: 'Xác nhận thanh toán',
            text: 'Bạn có chắc chắn muốn thanh toán không?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6', // Đổi màu confirmButton
            cancelButtonColor: '#d33', // Đổi màu cancelButton
            confirmButtonText: 'Thanh toán', // Đổi tên nút xác nhận
            cancelButtonText: 'Hủy',
        });

        if (!result.isConfirmed) {
            return; // Nếu người dùng không xác nhận, dừng lại
        }

        await exportPDFWithTemplate(selectedInvoiceId);

        // Chuẩn bị payload cho API PUT
        const payload = {
            idHoaDon: data.idHoaDon,
            idSanCa: data.idSanCa,
            idNhanVien: idNhanVien,
            idphieuGiamGia: idPhieuGiamGia || null,
            tongTien: tongTien,
            tienCocHdct: tienCocHdct,
            tienGiamGia: tienGiamGia || null,
            tongTienThucTe: tongTienPhaiTra,
        };
        try {
           await fetch(`http://localhost:8080/hoa-don-chi-tiet/thanh-toan/${selectedInvoiceId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });
            // Cập nhật phiếu giảm giá chi tiết
            await fetch(`http://localhost:8080/api-phieu-giam-gia-chi-tiet/${idPhieuGiamGiaChiTiet}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    idPhieuGiamGia: idPhieuGiamGia,
                    idKhachHang: idKhachHang,
                    deletedAt: true, // Xóa nếu cần
                }),
            });
            // Cập nhật phiếu giảm giá
            await fetch(`http://localhost:8080/api-phieu-giam-gia/update2/${idPhieuGiamGia}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    soLuong: soLuongPhieuGiamGia - 1, // Giảm số lượng phiếu giảm giá
                    trangThai: soLuongPhieuGiamGia - 1 <= 0 ? 'Đã kết thúc' : trangThaiPhieuGiamGia, // Nếu số lượng <= 0, đổi trạng thái
                    deletedAt: data.soLuong - 1 <= 0 ? true : false, // Nếu hết số lượng, set deletedAt
                }),
            });
            showSuccessToast('Thanh toán thành công!');
            // Cập nhật lại giao diện, ví dụ tải lại danh sách hóa đơn
            await fetchData();  // Giả sử bạn có hàm này để làm mới dữ liệu
        } catch (error) {
            // console.error(error);
            // showErrorToast('Lỗi khi thanh toán hóa đơn chi tiết.');
        }
    }


    //Xử lý tham số check in
    async function fetchCheckInTimeParam() {
        try {
            const response = await fetch('http://localhost:8080/tham-so/searchMaFake/TS_Gio_Check_In');
            if (!response.ok) throw new Error('Failed to fetch check-in time parameter.');
            const data = await response.json();
            return {value: parseInt(data.giaTri, 10), type: data.typeGiaTri};
        } catch (error) {
            // console.error('Error fetching check-in parameter:', error);
            return {value: 0, type: 'phút'}; // Giá trị mặc định nếu lỗi
        }
    }

    document.getElementById('khongApDungPGG').addEventListener('click', function () {
        // Reset ô Phiếu  Giá
        document.getElementById('phieuGiamGia').value = 'Phiếu giảm giá';
        document.getElementById('idPhieuGiamGia').value = '';
        document.getElementById('idPhieuGiamGiaChiTiet').value = '';
        document.getElementById('soLuongPhieuGiamGia').value = '';
        document.getElementById('trangThaiPhieuGiamGia').value = '';

        // Reset số tiền giảm về 0 VND
        document.getElementById('tienGiam').value = '0 VND';
        tinhTongThanhToan()
        // Hiển thị thông báo thành công (nếu muốn)
        showSuccessToast('Đã bỏ áp dụng phiếu giảm giá.');
    });

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head th:include="~{fragment/head::head}"></head>
<head>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <link href="https://unpkg.com/@fullcalendar/timegrid@5.11.3/main.css" rel="stylesheet"/>
</head>
<style>
    /*.fc-timegrid-time {*/
    /*    width: 150px; !* Adjust this width as needed *!*/
    /*}*/

    /*.fc-timegrid-body tr:last-child {*/
    /*    height: auto !important; !* Ensures the last row doesn't stretch *!*/
    /*}*/

    .calendar-container {
        margin: 20px;
    }

    .table th, .table td {
        vertical-align: middle;
    }

    .header-row {
        background-color: #f8f9fa;
    }

    .fc-timegrid-time {
        width: 150px; /* Adjust width as needed */
    }

    .fc-san-column {
        width: 100px; /* Adjust width as needed */
    }

    .toolbar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
    }

    .toolbar .view-buttons {
        display: flex;
        gap: 10px;
    }

    .toolbar .nav-buttons {
        display: flex;
        gap: 10px;
    }
</style>
<body class="vertical light" style="background-color: whitesmoke">

<div class="wrapper">
    <div th:include="~{fragment/client/sidebarClient :: sidebarClient}"></div>
    <main style="margin-top: 100px">
        <!--       Chọn sân-->
        <div class="row" style="width: 100%">
            <div class="col-md-12" style="width: 100%">
                <div class="card shadow ms-2 me-2 mt-5 mb-5 ">
                    <div class="card-body d-flex justify-content-end" id="tableCardBody1">
                        <div class="toolbar row mb-3 mt-3 ">
                            <div class="dropdown">
                                <button aria-expanded="false" aria-haspopup="true"
                                        class="btn btn-outline-success ml-3 mr-3 dropdown-toggle" data-toggle="dropdown"
                                        id="actionMenuButton1" type="button" value="1">
                                    Chọn loại sân
                                </button>
                                <div aria-labelledby="actionMenuButton1" class="dropdown-menu" id="dropdownLoaiSan">
                                    <!-- Các tùy chọn sẽ được thêm vào đây -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--        Chọn lịch-->
        <div class="row" style="width: 100%">
            <div class="col-md-12" style="width: 100%">
                <div class="card shadow ms-2 me-2 mt-5 mb-5 ">
                    <div class="card-body">
                        <div class="calendar-container">
                            <div class="mb-3 d-flex justify-content-between align-items-center">
                                <div class="d-inline-flex">
                                    <button id="prev" class="btn btn-secondary me-2"><</button>
                                    <button id="next" class="btn btn-secondary me-2">></button>
                                    <button id="today" class="btn btn-secondary me-2">Hôm nay</button>
                                </div>
                                <h4 id="currentRange" class="text-center mb-0">Hiển thị khoảng ngày</h4>
                                <div class="d-inline-flex">
                                    <button id="month" class="btn btn-primary ms-2">Tháng</button>
                                    <button id="week" class="btn btn-primary ms-2">Tuần</button>
                                    <button id="day" class="btn btn-primary ms-2">Ngày</button>
                                </div>
                            </div>
                            <div id="calendar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>
<!--// Modal Add-->
<!-- Modal -->
<div aria-hidden="true" aria-labelledby="exampleModalLabel" class="modal fade" id="createEventModal" role="dialog"
     tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Thêm lịch</h5>
            </div>
            <div class="modal-body">
                <!-- Phần nửa trên -->
                <div class="row" id="box-container">
                    <!-- Các box sẽ được thêm vào đây -->
                </div>
                <!-- Phần nửa duoi -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <label for="dateSelection">Chọn kiểu đặt lịch</label>
                        <select class="form-control" id="dateSelection">
                            <option value="Theo ngày" selected>Theo ngày</option>
                            <option value="Nhiều ngày">Nhiều ngày</option>
                            <option value="Theo tuần">Theo tuần</option>
                        </select>
                    </div>
                    <div class="col-md-8" id="calendarContainer">

                        <!-- Ô input để chọn ngày -->
                        <div id="selectedDateInput">
                            <label for="ngayDangChon">Ngày đang chọn</label>
                            <input type="text" id="ngayDangChon" class="form-control" readonly/>
                        </div>

                        <!-- Ô input cho việc chọn nhiều ngày -->
                        <div id="multipleDateInputs" style="display: none;">
                            <label for="startDate">Từ ngày</label>
                            <input type="text" id="startDate" class="form-control" readonly/>
                            <label for="endDate">Đến ngày</label>
                            <input type="text" id="endDate" class="form-control" readonly/>
                        </div>
                    </div>
                </div>

                <!-- Phần thêm khách hàng -->
                <div class="row mt-4">
                    <input type="text" id="idKhachHang" class="form-control" hidden/>
                    <div class="col-md-6">
                        <label for="hoVaTenKhachHang">Tên khách hàng</label>
                        <input type="text" id="hoVaTenKhachHang" class="form-control" placeholder="Nhập số điện thoại"/>
                    </div>
                    <div class="col-md-6">
                        <label for="soDienThoaiKhachHang">Số điện thoại</label>
                        <input type="text" id="soDienThoaiKhachHang" class="form-control"
                               placeholder="Nhập tên khách hàng"/>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" type="button">Đóng</button>
                <button class="btn btn-primary" id="saveEventButton" type="button">Lưu</button>
            </div>
        </div>
    </div>
</div>
<div th:include="fragment/scriptClient :: scriptClient"></div>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script src="https://unpkg.com/@fullcalendar/timegrid@5.11.3/main.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    let calendar;

    // Calendar
    document.addEventListener('DOMContentLoaded', function () {
        var currentDate = new Date();
        var currentView = 'week';

        function getWeekDates(date) {
            var firstDay = new Date(date.setDate(date.getDate() - date.getDay() + 1));
            return [...Array(7).keys()].map(i => new Date(firstDay.setDate(firstDay.getDate() + i)));
        }

        function formatTime(datetime) {
            var date = new Date(datetime);
            var hours = date.getHours().toString().padStart(2, '0');
            var minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function formatDate(date) {
            var day = date.getDate().toString().padStart(2, '0');
            var month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${day}/${month}`;
        }


        function fetchCaData(weekDates) {
            return fetch('http://localhost:8080/ca/hien-thi')
                .then(response => response.json())
                .catch(error => {
                    console.error('Failed to fetch ca data:', error);
                    return [];
                });
        }

        function fetchSanBongData(idLoaiSan) {
            return fetch(`http://localhost:8080/san-bong/findByIdLoaiSan/${idLoaiSan}`)
                .then(response => response.json())
                .catch(error => {
                    console.error('Failed to fetch san bong data:', error);
                    return [];
                });
        }

        function fetchAndRenderEvents(weekDates) {
            const dropdownMenu = document.getElementById('dropdownLoaiSan');
            const selectedId = dropdownMenu.dataset.selectedId;
            if (!selectedId) {
                console.error("Không có ID sân được chọn.");
                return;
            }

            Promise.all([fetchCaData(weekDates), fetchSanBongData(selectedId)]).then(([caData, sanData]) => {
                updateCalendar(caData, sanData, weekDates);
            });
        }

        function renderCalendarForWeek(date) {
            var weekDates = getWeekDates(new Date(date));
            fetchAndRenderEvents(weekDates);
            document.getElementById('currentRange').innerText = `${formatDate(weekDates[0])} - ${formatDate(weekDates[6])}`;
        }

        document.getElementById('prev').addEventListener('click', function () {
            currentDate.setDate(currentDate.getDate() - 7);
            renderCalendarForWeek(currentDate);
        });

        document.getElementById('next').addEventListener('click', function () {
            currentDate.setDate(currentDate.getDate() + 7);
            renderCalendarForWeek(currentDate);
        });

        document.getElementById('today').addEventListener('click', function () {
            currentDate = new Date();
            renderCalendarForWeek(currentDate);
        });

        document.getElementById('week').addEventListener('click', function () {
            currentView = 'week';
            renderCalendarForWeek(currentDate);
        });

        renderCalendarForWeek(currentDate);

        // Initialize dropdown for Loại Sân
        initializeDropdown();

        function initializeDropdown() {
            fetch('http://localhost:8080/loai-san/hien-thi')
                .then(response => response.json())
                .then(data => {
                    const uniqueLoaiSan = [...new Map(data.map(item => [item.tenLoaiSan, item])).values()];
                    const dropdownMenu = document.getElementById('dropdownLoaiSan');
                    uniqueLoaiSan.forEach(loaiSan => {
                        const dropdownItem = document.createElement('a');
                        dropdownItem.className = 'dropdown-item';
                        dropdownItem.href = '#';
                        dropdownItem.textContent = loaiSan.tenLoaiSan;
                        dropdownItem.dataset.id = loaiSan.id;
                        dropdownItem.onclick = function () {
                            document.getElementById('actionMenuButton1').textContent = loaiSan.tenLoaiSan;
                            dropdownMenu.dataset.selectedId = loaiSan.id;
                            console.log("ID của loại sân đã chọn:", dropdownMenu.dataset.selectedId);
                        };
                        dropdownMenu.appendChild(dropdownItem);
                    });
                })
                .catch(error => console.error('Lỗi khi gọi API:', error));
        }
    });
</script>
</body>
</html>
